<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Graphicmath" rel="Chapter" href="Graphicmath.html"><title>Graphicmath.Analogic.oscillo_recorder</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;oscillo_recorder&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(phosphor:bool)&nbsp;(monotrace:bool)&nbsp;(approx_hori_size:int)&nbsp;(approx_verti_size:int)&nbsp;(max_number:int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;step&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dname&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Sys</span>.getcwd&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture_file&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture_address&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;3&nbsp;1&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;height&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;factor&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;reduc&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;3&nbsp;1&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coefficients&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;3&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;threshold&nbsp;=&nbsp;[|&nbsp;1.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;marks&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;4&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;mark&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;4&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;affine_isomorphism&nbsp;=&nbsp;ref&nbsp;[|&nbsp;[|&nbsp;[|&nbsp;1.&nbsp;;&nbsp;0.&nbsp;|]&nbsp;;&nbsp;[|&nbsp;0.&nbsp;;&nbsp;-1.&nbsp;|]&nbsp;|]&nbsp;;&nbsp;[|&nbsp;[|&nbsp;0.&nbsp;;&nbsp;0.&nbsp;|]&nbsp;|]&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ll_corner&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ur_corner&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;horizontal_units&nbsp;=&nbsp;[|&nbsp;<span class="string">"1."</span>&nbsp;;&nbsp;<span class="string">"&nbsp;"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vertical_units&nbsp;=&nbsp;[|&nbsp;<span class="string">"1."</span>&nbsp;;&nbsp;<span class="string">"&nbsp;"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;source&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;3&nbsp;1&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bigomega&nbsp;=&nbsp;ref&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;number_of_traces&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;samples&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;interval&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;curves&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;derivatives&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;speeds&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;transfos&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;modules&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;crop_values&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;6&nbsp;0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;never_cropped&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;truncate&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(peak:float)&nbsp;(x:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;classify_float&nbsp;y&nbsp;=&nbsp;<span class="constructor">FP_normal</span>&nbsp;<span class="keyword">then</span>&nbsp;min&nbsp;peak&nbsp;(&nbsp;max&nbsp;0.&nbsp;y&nbsp;)&nbsp;<span class="keyword">else</span>&nbsp;0.&nbsp;)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accu_int&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;s&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;^&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accu_float&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;s&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;^&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_float&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;end_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;Terminer&nbsp;"</span>&nbsp;;&nbsp;<span class="string">"&nbsp;Finish&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;go_on_messages&nbsp;=&nbsp;[|&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;le&nbsp;répertoire&nbsp;de&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;directory&nbsp;of&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Recadrer&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Crop&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Traiter&nbsp;les&nbsp;couleurs"</span>&nbsp;;&nbsp;<span class="string">"Treat&nbsp;the&nbsp;colors"</span>&nbsp;|]&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;le&nbsp;seuil"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;threshold"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;brut&nbsp;des&nbsp;courbes"</span>&nbsp;;&nbsp;<span class="string">"Raw&nbsp;display&nbsp;of&nbsp;the&nbsp;curves"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Marquer&nbsp;des&nbsp;points&nbsp;du"</span>&nbsp;;&nbsp;<span class="string">"réticule&nbsp;sur&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Mark&nbsp;graticule&nbsp;points"</span>&nbsp;;&nbsp;<span class="string">"on&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Raffiner&nbsp;le&nbsp;marquage"</span>&nbsp;;&nbsp;<span class="string">"Refine&nbsp;the&nbsp;marks"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;les&nbsp;unités&nbsp;horizontales"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;horizontal&nbsp;units"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;les&nbsp;unités&nbsp;verticales"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;vertical&nbsp;units"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;des&nbsp;courbes"</span>&nbsp;;&nbsp;<span class="string">"en&nbsp;divisions"</span>&nbsp;;&nbsp;<span class="string">"Display&nbsp;of&nbsp;the&nbsp;curves"</span>&nbsp;;&nbsp;<span class="string">"in&nbsp;divisions"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;des"</span>&nbsp;;&nbsp;<span class="string">"courbes&nbsp;en&nbsp;unités"</span>&nbsp;;&nbsp;<span class="string">"Display&nbsp;of&nbsp;the"</span>&nbsp;;&nbsp;<span class="string">"curves&nbsp;in&nbsp;units"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;brut"</span>&nbsp;;&nbsp;<span class="string">"des&nbsp;dérivées"</span>&nbsp;;&nbsp;<span class="string">"Raw&nbsp;display&nbsp;of"</span>&nbsp;;&nbsp;<span class="string">"the&nbsp;derivatives"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;brut"</span>&nbsp;;&nbsp;<span class="string">"des&nbsp;transformées"</span>&nbsp;;&nbsp;<span class="string">"de&nbsp;Fourier"</span>;&nbsp;<span class="string">"Raw&nbsp;display&nbsp;of"</span>&nbsp;;&nbsp;<span class="string">"the&nbsp;Fourier"</span>&nbsp;;&nbsp;<span class="string">"transforms"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Suite"</span>&nbsp;;&nbsp;<span class="string">"Continuation"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Reprendre&nbsp;à&nbsp;partir"</span>&nbsp;;&nbsp;<span class="string">"du&nbsp;recadrage"</span>&nbsp;;&nbsp;<span class="string">"Resume&nbsp;from"</span>&nbsp;;&nbsp;<span class="string">"the&nbsp;cropping"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Terminer"</span>&nbsp;;&nbsp;<span class="string">"Finish"</span>&nbsp;|]&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ending&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;go_on&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;approx_hori_size&nbsp;/&nbsp;20<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;metadata&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"phosphor:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_bool&nbsp;phosphor&nbsp;)&nbsp;;&nbsp;<span class="string">"monotrace:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_bool&nbsp;monotrace&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"size:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_verti_size&nbsp;)&nbsp;;&nbsp;<span class="string">"max&nbsp;number&nbsp;for&nbsp;selectors:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;max_number&nbsp;)&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;approx_verti_size&nbsp;/&nbsp;20&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!step&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"L'oscilloscope&nbsp;a&nbsp;été&nbsp;inventé&nbsp;par&nbsp;Karl&nbsp;Ferdinand&nbsp;Braun&nbsp;(1850-1918)."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;15&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"The&nbsp;oscilloscope&nbsp;has&nbsp;been&nbsp;invented&nbsp;by&nbsp;Karl&nbsp;Ferdinand&nbsp;Braun&nbsp;(1850-1918)."</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ending&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;end_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.array_write_text_file&nbsp;!metadata&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".metadata"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ending&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!go_on&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!step&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Répertoire - Directory *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dname&nbsp;:=&nbsp;<span class="constructor">Widget</span>.choose_directory&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;max_number&nbsp;!dname&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Fichier - File *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture_file&nbsp;:=&nbsp;<span class="constructor">Widget</span>.choose_regular_file&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;max_number&nbsp;!dname&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture_address&nbsp;:=&nbsp;<span class="constructor">Filename</span>.concat&nbsp;!dname&nbsp;!picture_file&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;!picture_file&nbsp;)&nbsp;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Sys</span>.file_exists&nbsp;!picture_address&nbsp;)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Recadrage - Croping *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!never_cropped&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture&nbsp;:=&nbsp;<span class="constructor">Readwrite</span>.read_picture_float_rgb&nbsp;!picture_address&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height&nbsp;:=&nbsp;<span class="constructor">Array</span>.length&nbsp;!picture.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width&nbsp;:=&nbsp;<span class="constructor">Array</span>.length&nbsp;!picture.(0).(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!affine_isomorphism.(1).(0).(1)&nbsp;&lt;-&nbsp;float&nbsp;!height&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="constructor">Util</span>.int_gcd&nbsp;!height&nbsp;!width&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factor&nbsp;:=&nbsp;min&nbsp;g&nbsp;(&nbsp;2&nbsp;+&nbsp;(&nbsp;max&nbsp;(&nbsp;!height&nbsp;/&nbsp;approx_verti_size&nbsp;)&nbsp;(&nbsp;!width&nbsp;/&nbsp;approx_hori_size&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;g&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factor&nbsp;:=&nbsp;succ&nbsp;!factor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;!height&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;!width&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"The&nbsp;under-sampling&nbsp;factor&nbsp;must&nbsp;divide&nbsp;the&nbsp;height&nbsp;and&nbsp;the&nbsp;width&nbsp;of&nbsp;the&nbsp;picture&nbsp;in&nbsp;Analogic.oscillo."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reduc&nbsp;:=&nbsp;<span class="constructor">Readwrite</span>.matrix_float_rgb_under_sample&nbsp;!factor&nbsp;!picture&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values&nbsp;:=&nbsp;autocrop&nbsp;(&nbsp;<span class="constructor">Readwrite</span>.matrix_float_rgb_to_luminance&nbsp;!picture&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;never_cropped&nbsp;:=&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_crop_image&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!picture&nbsp;!reduc&nbsp;!crop_values&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"crop&nbsp;values:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;accu_int&nbsp;<span class="string">""</span>&nbsp;!crop_values&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;phosphor&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;2&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;3&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Traitement des couleurs - Color treatment *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_color_treatment&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!reduc&nbsp;coefficients&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;coefficients.(0)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(0)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;!picture.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(0)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;!picture.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;coefficients.(1)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(1)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;!picture.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(1)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;!picture.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;coefficients.(2)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(2)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;!picture.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(2)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;!picture.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"red:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;pred&nbsp;coefficients.(0)&nbsp;)&nbsp;)&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"green:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;pred&nbsp;coefficients.(1)&nbsp;)&nbsp;)&nbsp;;&nbsp;<span class="string">"blue:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;pred&nbsp;coefficients.(2)&nbsp;)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;4&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Seuil - Threshold *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;<span class="constructor">Widget</span>.choose_real&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;[|&nbsp;0.&nbsp;;&nbsp;10.&nbsp;|]&nbsp;threshold&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"threshold:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_float&nbsp;threshold.(0)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;5&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage brut des courbes - Raw display of the curves *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;:=&nbsp;<span class="constructor">Readwrite</span>.rgb_crop&nbsp;!picture&nbsp;!crop_values.(2)&nbsp;!crop_values.(3)&nbsp;!crop_values.(0)&nbsp;!crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_min&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_float_rgb&nbsp;!source&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;luminance&nbsp;=&nbsp;<span class="constructor">Readwrite</span>.matrix_float_rgb_to_luminance&nbsp;!source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;splitting&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;[|&nbsp;|]&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;monotrace&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;splitting&nbsp;:=&nbsp;prepare_trace&nbsp;threshold.(0)&nbsp;(&nbsp;antigamma&nbsp;luminance&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;number_of_traces&nbsp;:=&nbsp;1&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;splitting&nbsp;:=&nbsp;split_traces&nbsp;threshold.(0)&nbsp;(&nbsp;antigamma&nbsp;luminance&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;number_of_traces&nbsp;:=&nbsp;<span class="constructor">Array</span>.length&nbsp;!splitting.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;samples&nbsp;:=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;!number_of_traces&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!source&nbsp;)&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!samples.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.vector_float_scal_add&nbsp;(&nbsp;float&nbsp;!crop_values.(2)&nbsp;)&nbsp;(&nbsp;automatic_digitize&nbsp;!splitting.(0).(i)&nbsp;!splitting.(1).(i)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.vector_float_write&nbsp;!samples.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"trace"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;100&nbsp;!samples&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"traces.au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bigomega&nbsp;:=&nbsp;float&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!source.(0).(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_multicolor_segment_1_1&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!samples&nbsp;[|&nbsp;0.&nbsp;;&nbsp;!bigomega&nbsp;;&nbsp;float&nbsp;!height&nbsp;;&nbsp;0.&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;raw&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".raw.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"number&nbsp;of&nbsp;traces:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;!number_of_traces&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;18&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;6&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Marquage - Marking *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;mark.(0)&nbsp;&gt;=&nbsp;0.&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_mark_image&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!picture&nbsp;!reduc&nbsp;mark&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;marks&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!marks&nbsp;[|&nbsp;[|&nbsp;mark.(0)&nbsp;;&nbsp;mark.(1)&nbsp;;&nbsp;mark.(2)&nbsp;;&nbsp;mark.(3)&nbsp;|]&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;!marks&nbsp;&gt;=&nbsp;4&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;6&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;3&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(i)&nbsp;&lt;-&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;7&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Raffinement du marquage - Refining the marks *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!marks&nbsp;)&nbsp;-&nbsp;2&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_refine_mark&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!picture&nbsp;!marks.(i)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"marks:&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lm&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;!marks&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m_m&nbsp;=&nbsp;<span class="constructor">Array</span>.sub&nbsp;!marks&nbsp;0&nbsp;&nbsp;(&nbsp;pred&nbsp;lm&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;accu_float&nbsp;<span class="string">""</span>&nbsp;)&nbsp;m_m&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;lm&nbsp;&gt;=&nbsp;4&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;m_m&nbsp;<span class="keyword">in</span><br>
</code><table><tr><td></td><td><span class="comment">(** Les coordonnées doivent être du même ordre de grandeur pour que la régression linéaire fonctionne.
The coordinates must have the same order of magnitude in order for the regression to work. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;departures&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_mult&nbsp;1e-3&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;m&nbsp;0&nbsp;2&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Matrix</span>.float_rank&nbsp;departures&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;r&nbsp;=&nbsp;2&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;affine_isomorphism&nbsp;:=&nbsp;linear_regression&nbsp;departures&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;m&nbsp;2&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!affine_isomorphism.(0)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_mult&nbsp;1e-3&nbsp;!affine_isomorphism.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;5&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"affine&nbsp;isomorphism:&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;accu_float&nbsp;<span class="string">""</span>&nbsp;)&nbsp;!affine_isomorphism.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;string_of_float&nbsp;!affine_isomorphism.(1).(0).(0)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;string_of_float&nbsp;!affine_isomorphism.(1).(0).(1)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;8&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Unités horizontales - Horizontal units *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;choose_unit&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;horizontal_units&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;9&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Unités verticales - Vertical units *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;choose_unit&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;vertical_units&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;10&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage des courbes en divisions - Curves display in divisions *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"horizontal&nbsp;units:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">"&nbsp;"</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.to_list&nbsp;horizontal_units&nbsp;)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"vertical&nbsp;units:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">"&nbsp;"</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.to_list&nbsp;vertical_units&nbsp;)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;decalage&nbsp;=&nbsp;float&nbsp;!crop_values.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;a&nbsp;=&nbsp;!affine_isomorphism.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;b&nbsp;=&nbsp;!affine_isomorphism.(1).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interval&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.float_closed_equal_subdivision&nbsp;decalage&nbsp;(&nbsp;int_of_float&nbsp;!bigomega&nbsp;)&nbsp;(&nbsp;!bigomega&nbsp;+.&nbsp;decalage&nbsp;-.&nbsp;1.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curves&nbsp;:=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;!number_of_traces&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_curve&nbsp;=&nbsp;[|&nbsp;!interval&nbsp;;&nbsp;!samples.(i)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!curves.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_column_apply_vect&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_plus&nbsp;b&nbsp;)&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_prod&nbsp;a&nbsp;input_curve&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"curve"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;200&nbsp;+&nbsp;i&nbsp;)&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"curve"</span>&nbsp;^&nbsp;(string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ll_corner&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.vector_float_plus&nbsp;b&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_vector_float_prod&nbsp;a&nbsp;[|&nbsp;0.&nbsp;;&nbsp;float&nbsp;!height&nbsp;|]&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ur_corner&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.vector_float_plus&nbsp;b&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_vector_float_prod&nbsp;a&nbsp;[|&nbsp;float&nbsp;!width&nbsp;;&nbsp;0.&nbsp;|]&nbsp;&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ll_corner.(0)&nbsp;&lt;-&nbsp;min&nbsp;(&nbsp;floor&nbsp;!ll_corner.(0)&nbsp;)&nbsp;(&nbsp;-5.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ll_corner.(1)&nbsp;&lt;-&nbsp;min&nbsp;(&nbsp;floor&nbsp;!ll_corner.(1)&nbsp;)&nbsp;(&nbsp;-4.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ur_corner.(0)&nbsp;&lt;-&nbsp;max&nbsp;(&nbsp;ceil&nbsp;!ur_corner.(0)&nbsp;)&nbsp;5.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ur_corner.(1)&nbsp;&lt;-&nbsp;max&nbsp;(&nbsp;ceil&nbsp;!ur_corner.(1)&nbsp;)&nbsp;4.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_trans_multicolor_segment_1_2&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!curves&nbsp;[|&nbsp;0.&nbsp;;&nbsp;1.&nbsp;|]&nbsp;[|&nbsp;!ll_corner.(0)&nbsp;;&nbsp;!ur_corner.(0)&nbsp;;&nbsp;!ll_corner.(1)&nbsp;;&nbsp;!ur_corner.(1)&nbsp;;&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;curves&nbsp;DIV&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".div.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;18&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;11&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage des courbes en unités - Curves display in units *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;[|&nbsp;float_of_string&nbsp;horizontal_units.(0)&nbsp;;&nbsp;float_of_string&nbsp;vertical_units.(0)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;horizontal_units.(3)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"pix"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(0)&nbsp;&lt;-&nbsp;u.(0)&nbsp;*.&nbsp;(&nbsp;float&nbsp;!width&nbsp;)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(0)&nbsp;-.&nbsp;!ll_corner.(0)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"scrn"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(0)&nbsp;&lt;-&nbsp;u.(0)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(0)&nbsp;-.&nbsp;!ll_corner.(0)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;vertical_units.(3)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"pix"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(1)&nbsp;&lt;-&nbsp;u.(1)&nbsp;*.&nbsp;(&nbsp;float&nbsp;!height&nbsp;)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(1)&nbsp;-.&nbsp;!ll_corner.(1)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"scrn"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(1)&nbsp;&lt;-&nbsp;u.(1)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(1)&nbsp;-.&nbsp;!ll_corner.(1)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curves&nbsp;:=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.mapi&nbsp;(&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Matrix</span>.vector_float_scal_mult&nbsp;u.(i)&nbsp;x&nbsp;)&nbsp;)&nbsp;!curves&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ll_corner&nbsp;:=&nbsp;[|&nbsp;u.(0)&nbsp;*.&nbsp;!ll_corner.(0)&nbsp;;&nbsp;u.(1)&nbsp;*.&nbsp;!ll_corner.(1)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ur_corner&nbsp;:=&nbsp;[|&nbsp;u.(0)&nbsp;*.&nbsp;!ur_corner.(0)&nbsp;;&nbsp;u.(1)&nbsp;*.&nbsp;!ur_corner.(1)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_trans_multicolor_segment_1_2&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!curves&nbsp;[|&nbsp;0.&nbsp;;&nbsp;1.&nbsp;|]&nbsp;[|&nbsp;!ll_corner.(0)&nbsp;;&nbsp;!ur_corner.(0)&nbsp;;&nbsp;!ll_corner.(1)&nbsp;;&nbsp;!ur_corner.(1)&nbsp;;&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;curves&nbsp;UNITS&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"magnitude"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;300&nbsp;+&nbsp;i&nbsp;)&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"magnitude"</span>&nbsp;^&nbsp;(string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".units.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;12&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage brut des dérivées - Raw display of the derivatives *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Les lignes sont numérotées du haut vers le bas. - The lines are numbered from top to bottom. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;derivatives&nbsp;:=&nbsp;<span class="constructor">Infinitesimal</span>.discrete_trans_vector_speed&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_richardson_binary_diff&nbsp;(-1.)&nbsp;!samples&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.vector_float_write&nbsp;!derivatives.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"deriv"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;400&nbsp;!derivatives&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"derivatives.au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_multicolor_segment_1_1&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!derivatives&nbsp;[|&nbsp;0.&nbsp;;&nbsp;!bigomega&nbsp;;&nbsp;<span class="constructor">Matrix</span>.matrix_float_min&nbsp;!derivatives&nbsp;;&nbsp;<span class="constructor">Matrix</span>.matrix_float_max&nbsp;!derivatives&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;raw&nbsp;derivatives&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".raw_deriv.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;!curves&nbsp;&gt;=&nbsp;5&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;speeds&nbsp;:=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Infinitesimal</span>.discrete_trans_vector_speed&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_richardson_binary_diff&nbsp;(&nbsp;!ur_corner.(0)&nbsp;-.&nbsp;!ll_corner.(0)&nbsp;)&nbsp;)&nbsp;!curves&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!speeds.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"speed"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;500&nbsp;+&nbsp;i&nbsp;)&nbsp;!speeds.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"speed"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;13&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage brut des transformées - Raw display of the transforms *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tf&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;omega&nbsp;z&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Infinitesimal</span>.discrete_float_causal_fourier_transform&nbsp;z&nbsp;omega<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;value&nbsp;=&nbsp;(&nbsp;!bigomega&nbsp;-.&nbsp;1.&nbsp;)&nbsp;/.&nbsp;2.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interval&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.float_closed_equal_subdivision&nbsp;(&nbsp;-.&nbsp;value&nbsp;)&nbsp;(&nbsp;int_of_float&nbsp;!bigomega&nbsp;)&nbsp;value&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transfos&nbsp;:=&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!samples&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules&nbsp;:=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!samples&nbsp;)&nbsp;0&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ft&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;omega&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tf&nbsp;omega&nbsp;(&nbsp;truncate&nbsp;(&nbsp;float&nbsp;!height&nbsp;)&nbsp;!samples.(i)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!transfos.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;ft&nbsp;!interval&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!modules.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Matrix</span>.vector_float_norm_2&nbsp;!transfos.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!transfos.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"Fourier"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;600&nbsp;+&nbsp;i&nbsp;)&nbsp;(&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;!transfos.(i)&nbsp;)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"Fourier"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!modules&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"transfoModules"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;700&nbsp;)&nbsp;(&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;!modules&nbsp;)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"transfoModules.au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_multicolor_segment_1_1&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!modules&nbsp;[|&nbsp;-.&nbsp;value&nbsp;;&nbsp;value&nbsp;;&nbsp;floor&nbsp;(&nbsp;1.1&nbsp;*.&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_min&nbsp;!modules&nbsp;)&nbsp;)&nbsp;;&nbsp;ceil&nbsp;(&nbsp;1.1&nbsp;*.&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_max&nbsp;!modules&nbsp;)&nbsp;)&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;raw&nbsp;Fourier&nbsp;transforms&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".raw_Fourier.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;18&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;14&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Choix - Choice *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;15&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Bouclage - Looping *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;()</code></body></html>