<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Graphicmath" rel="Chapter" href="Graphicmath.html"><title>Graphicmath.Sparse_matrix</title>
</head>
<body>
<code class="code"><span class="keyword">struct</span><br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="1_Introduction"><h1>Introduction</h1></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
The mathematician will find in this module functors to handle
sparse matrices with coefficients in a commutative rng or a field.
<p>

<span id="2_Conventions"><h2>Conventions</h2></span>
<p>

Dimensions are often unreachable in a sparse tensor as soon as it is null (excepted sometimes for the first variable). 
Since sparse matrices are modelled on sparse tensors, the problem is present too for null sparse amtrices, 
and a null sparse matrix is sometimes supposed to be square.
<p>

<span id="2_Comments"><h2>Comments</h2></span>
<p>

A function is <em>sealed</em> if there is no sharing between the input variables and the output value.
This is the expected behavior of usual mathematical functions.
The recursive programming of polymorphic functions is easier in a <em>non sealed</em> way.
Some copy functions are provided for every type of data.
They are sealed provided that they receive as argument elementary copy functions for coefficients and indices.
By composition, they permit to seal all functions necessary.
<p>

This module is distributed under the same licence as Ocaml.
<p>

<center>§ </center>
<p>

La mathématicienne ou le mathématicien trouvera dans ce module des focnteurs pour traiter
les matrices creuses à coefficients dans un annau commutatif ou un corps.
<p>

<span id="2_Conventions"><h2>Conventions</h2></span>
<p>

Les dimensions d'un tenseur creux sont souvent inaccessibles (sauf parfois pour la première variable) dès qu'il est nul.
Puisque les matrices creuses sont modelées sur les tenseurs creux, le problème se pose aussi pour les matrices creuses nulles, 
et une matrice creuse nulle est parfois supposée carrée.
<p>

<span id="2_Commentaires"><h2>Commentaires</h2></span>
<p>

Une fonction est <em>étanche</em> quand il n'y a aucun partage entre les variables fournies en entrée et la valeur obtenue en sortie.
C'est le comportement attendu des fonctions mathématiques habituelles. 
La programmation récursive des fonctions polymorphes est plus facile de manière <em>non étanche</em>.
Des fonctions de recopie sont fournies pour tous les types de données. 
Elles sont étanches à condition de leur fournir en argument des fonctions élémentaires de recopie des coefficients et des indices. 
Par composition, elle permettent d'étanchéifier toutes les fonctions voulues.
<p>

Ce module est distribué selon la même licence qu'Ocaml.
<p>

<center>Copyright Stéphane Grognet</center>
<center>Laboratoire de mathématiques Jean Leray UMR 6629 CNRS</center>
<center>Fédération de recherche mathématique des Pays de la Loire</center>
<center>Centre Henri Lebesgue</center>
<center>IREM des Pays de la Loire - Université de Nantes</center>
<center>version 0.1</center>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(**
@version 0.1
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(**
@author Stéphane Grognet
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(**
@since 2013
*)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="2_Matricescreusescoefficientsdansunannaucommutatif"><h2>Matrices creuses à coefficients dans un annau commutatif</h2></span>
<span id="2_SparsematriceswithcoefficientsinacommiutativeRng"><h2>Sparse matrices with coefficients in a commiutative Rng</h2></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Util</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Data</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Hash</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Sparse_vector</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Sparse_tensor</span>&nbsp;;;<br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Rng</span>&nbsp;(<span class="constructor">Index</span>:<span class="constructor">Data</span>.<span class="constructor">Index_type</span>)&nbsp;(<span class="constructor">Hasher</span>:<span class="constructor">Hash</span>.<span class="constructor">Hash_type</span>&nbsp;<span class="keyword">with</span>&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Index</span>.t)&nbsp;(<span class="constructor">Coeff</span>:<span class="constructor">Data</span>.<span class="constructor">Rng_coeff_type</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
<br>
<br>
<span class="keyword">type</span>&nbsp;index&nbsp;=&nbsp;<span class="constructor">Index</span>.t&nbsp;;;<br>
<br>
<span class="keyword">type</span>&nbsp;coeff&nbsp;=&nbsp;<span class="constructor">Coeff</span>.t&nbsp;;;<br>
<br>
<span class="keyword">type</span>&nbsp;elt&nbsp;=&nbsp;index&nbsp;*&nbsp;coeff&nbsp;;;<br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">V</span>&nbsp;=&nbsp;<span class="constructor">Sparse_vector</span>.<span class="constructor">Rng</span>&nbsp;(<span class="constructor">Index</span>)&nbsp;(<span class="constructor">Hasher</span>)&nbsp;(<span class="constructor">Coeff</span>)&nbsp;;;<br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">T</span>&nbsp;=&nbsp;<span class="constructor">Sparse_tensor</span>.<span class="constructor">Rng</span>&nbsp;(<span class="constructor">Index</span>)&nbsp;(<span class="constructor">Hasher</span>)&nbsp;(<span class="constructor">Coeff</span>)&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** A very sparse matrix is profitably represented as a sparse tensor.
The matrices who are little different from a scalar or multi-scalar matrix are also included in the type.
In all the preceding cases, the indices may be naturally polymorphic.
In all the following cases, the indices are generally of type <code class="code">int</code>.
The invertible sparse matrices are handled preferably as full vectors whose coefficients are sparse vectors.
The matrices who differ a little from a diagonal or multi-diagonal matrix are also included in the type.
The non square matrices of type Diff* are supposed to have more columns than rows.
The lengths of the lines of coefficients on their own in Diff_to_diag_matrix and Diff_to_multi_diag_matrix 
may be greater than the dimensions of the associated sparse tensor.
<p>

BEWARE : In the <code class="code"><span class="constructor">Diff_to_multi_diag</span></code> type, somme marginal coefficients of the multidiagonal are not taken into account : the second index of the multidiagonal is always (up to <code class="code"><span class="constructor">Index</span>.from_int</code> translation) the row number of the matrix.
<p>

Une matrice très creuse sera représentée avantageusement comme un tenseur creux.
Les matrices qui diffèrent peu d'un matrice scalaire ou multi-scalaire sont aussi incluses dans le type.
Dans tous les cas précédents, les indices peuvent être naturellement polymorphes.
Dans les cas qui suivent, les indices sont généralement de type <code class="code">int</code>.
Les matrices creuses inversibles sont manipulées de préférence comme des vecteurs pleins dont les coefficients sont des vecteurs creux.
Les matrices qui diffèrent peu d'une matrice diagonale ou multidiagonale sont aussi incluses dans le type.
Les matrics non carrées de type Diff* sont censées avoir plus de colonnes que de lignes.
La longueur des lignes de coefficients mis à part dans Diff_to_diag_matrix et Diff_to_multi_diag_matrix 
peuvent être supérieures aux dimensions du tenseur creux associé.
<p>

ATTENTION : Dans le type <code class="code"><span class="constructor">Diff_to_multi_diag</span></code>, certains coefficients marginaux de la multidiagonale ne sont pas pris en compte : le second indice de la multidiagonale est toujours le numéro de ligne de la matrice (à traduction <code class="code"><span class="constructor">Index</span>.from_int</code> près). *)</span></td></tr></table><code class="code"><br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">T</span>.t<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;<span class="keyword">of</span>&nbsp;coeff&nbsp;*&nbsp;<span class="constructor">T</span>.t<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;<span class="keyword">of</span>&nbsp;coeff&nbsp;array&nbsp;*&nbsp;<span class="constructor">T</span>.t<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">V</span>.t&nbsp;array<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;<span class="keyword">of</span>&nbsp;coeff&nbsp;array&nbsp;*&nbsp;<span class="constructor">T</span>.t<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;<span class="keyword">of</span>&nbsp;coeff&nbsp;array&nbsp;array&nbsp;*&nbsp;<span class="constructor">T</span>.t&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>copy matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;copy&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.copy&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;x&nbsp;,&nbsp;<span class="constructor">T</span>.copy&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.copy&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">V</span>.copy&nbsp;)&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.copy&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.copy&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="3_Dstructurations"><h3>Déstructurations</h3></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_matrix_demakeup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_matrix_demakeup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;sparse&nbsp;tensor&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_tensor_matrix_demakeup."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_scal_matrix_demakeup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_scal_matrix_demakeup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference&nbsp;to&nbsp;scalar&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_scal_matrix_demakeup."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_multi_scal_matrix_demakeup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_multi_scal_matrix_demakeup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference&nbsp;to&nbsp;multi-scalar&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_multi_scal_matrix_demakeup."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>half_full_matrix_demakeup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;half_full_matrix_demakeup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;half&nbsp;full&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.half_full_matrix_demakeup."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_diag_matrix_demakeup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_diag_matrix_demakeup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference&nbsp;to&nbsp;diagonal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_diag_matrix_demakeup."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_multi_diag_matrix_demakeup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_multi_diag_matrix_demakeup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference&nbsp;to&nbsp;multi-diagonal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_multi_diag_matrix_demakeup."</span>&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="3_Oprationslmentaires"><h3>Opérations élémentaires</h3></span>
<span id="3_Elementaryoperations"><h3>Elementary operations</h3></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>null dimensions</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;null&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(dimensions:<span class="keywordsign">'</span>b&nbsp;array)&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;dimensions&nbsp;&lt;&gt;&nbsp;2&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;number&nbsp;of&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.null."</span>&nbsp;;<br>
&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.null&nbsp;dimensions&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>zero unit</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;zero&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.zero&nbsp;()&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>filling matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;filling&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.filling&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.filling&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.filling&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.filling&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;(&nbsp;+&nbsp;)&nbsp;0&nbsp;a<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.filling&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.filling&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>detailed_filling matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;detailed_filling&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[|&nbsp;0&nbsp;;&nbsp;<span class="constructor">T</span>.filling&nbsp;w&nbsp;|]<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[|&nbsp;1&nbsp;;&nbsp;<span class="constructor">T</span>.filling&nbsp;w&nbsp;|]<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[|&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;;&nbsp;<span class="constructor">T</span>.filling&nbsp;w&nbsp;|]<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[|&nbsp;0&nbsp;;&nbsp;filling&nbsp;m&nbsp;|]<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[|&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;;&nbsp;<span class="constructor">T</span>.filling&nbsp;w&nbsp;|]<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[|&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;*&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;)&nbsp;;&nbsp;<span class="constructor">T</span>.filling&nbsp;w&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sizes matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sizes&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.sizes&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.sizes&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.sizes&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;max_int&nbsp;,&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.size&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.sizes&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.sizes&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>size matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;size&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.size&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.size&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.size&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;(&nbsp;+&nbsp;)&nbsp;0&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.size&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.size&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.size&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>dimensions matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;dimensions&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;r&nbsp;;&nbsp;c&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;d&nbsp;)&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;d.(0)&nbsp;<span class="keyword">else</span>&nbsp;d&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>cleanup matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;cleanup&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.cleanup&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.cleanup&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.cleanup&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ignore&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.cleanup&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.cleanup&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.cleanup&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>resize size matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;resize&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(n:int)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.resize&nbsp;n&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.resize&nbsp;n&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.resize&nbsp;n&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ignore&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">V</span>.resize&nbsp;n&nbsp;)&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.resize&nbsp;n&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.resize&nbsp;n&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_string matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;to_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Sparse_tensor_matrix&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">T</span>.to_string&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Diff_to_scal_matrix&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Coeff</span>.to_string&nbsp;x&nbsp;)&nbsp;^&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">T</span>.to_string&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Diff_to_multi_scal_matrix&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Util</span>.bare_vector_to_string&nbsp;<span class="constructor">Coeff</span>.to_string&nbsp;a&nbsp;)&nbsp;^&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">T</span>.to_string&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Half_full_matrix&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Util</span>.vector_to_string&nbsp;(&nbsp;<span class="constructor">V</span>.to_string&nbsp;)&nbsp;<span class="string">"{|"</span>&nbsp;<span class="string">"~"</span>&nbsp;<span class="string">"|}"</span>&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Diff_to_diag_matrix&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Util</span>.bare_vector_to_string&nbsp;<span class="constructor">Coeff</span>.to_string&nbsp;a&nbsp;)&nbsp;^&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">T</span>.to_string&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Diff_to_multi_diag_matrix&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Util</span>.vector_to_string&nbsp;(&nbsp;<span class="constructor">Util</span>.bare_vector_to_string&nbsp;<span class="constructor">Coeff</span>.to_string&nbsp;)&nbsp;<span class="string">"{|"</span>&nbsp;<span class="string">"~"</span>&nbsp;<span class="string">"|}"</span>&nbsp;a&nbsp;)&nbsp;^&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">T</span>.to_string&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_matrix_of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_matrix_of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;21&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;<span class="string">"Sparse_tensor_matrix&nbsp;"</span>&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;21&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;-&nbsp;21&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.of_string&nbsp;t&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;sparse&nbsp;tensor&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_tensor_matrix_of_string."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>half_full_matrix_of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;half_full_matrix_of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;17&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;<span class="string">"Half_full_matrix&nbsp;"</span>&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;17&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;-&nbsp;17&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;(&nbsp;<span class="constructor">Util</span>.vector_of_string&nbsp;(&nbsp;<span class="constructor">V</span>.of_string&nbsp;)&nbsp;<span class="string">"{|"</span>&nbsp;<span class="string">"~"</span>&nbsp;<span class="string">"|}"</span>&nbsp;t&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;half&nbsp;full&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.half_full_matrix_of_string."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_scal_matrix_of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_scal_matrix_of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;20&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;<span class="string">"Diff_to_scal_matrix&nbsp;"</span>&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;20&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;-&nbsp;20&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;listing&nbsp;=&nbsp;<span class="constructor">Str</span>.split&nbsp;(&nbsp;<span class="constructor">Str</span>.regexp_string&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;)&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;listing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;(&nbsp;<span class="constructor">List</span>.tl&nbsp;listing&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.of_string&nbsp;u&nbsp;,&nbsp;<span class="constructor">T</span>.of_string&nbsp;v&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-scalar&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_scal_matrix_of_string."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_multi_scal_matrix_of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_multi_scal_matrix_of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;26&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;<span class="string">"Diff_to_multi_scal_matrix&nbsp;"</span>&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;26&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;-&nbsp;26&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;listing&nbsp;=&nbsp;<span class="constructor">Str</span>.split&nbsp;(&nbsp;<span class="constructor">Str</span>.regexp_string&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;)&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;listing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;(&nbsp;<span class="constructor">List</span>.tl&nbsp;listing&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Util</span>.bare_vector_of_string&nbsp;<span class="constructor">Coeff</span>.of_string&nbsp;u&nbsp;,&nbsp;<span class="constructor">T</span>.of_string&nbsp;v&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-multi-scalar&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_multi_scal_matrix_of_string."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_diag_matrix_of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_diag_matrix_of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;20&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;<span class="string">"Diff_to_diag_matrix&nbsp;"</span>&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;20&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;-&nbsp;20&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;listing&nbsp;=&nbsp;<span class="constructor">Str</span>.split&nbsp;(&nbsp;<span class="constructor">Str</span>.regexp_string&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;)&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;listing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;(&nbsp;<span class="constructor">List</span>.tl&nbsp;listing&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Util</span>.bare_vector_of_string&nbsp;<span class="constructor">Coeff</span>.of_string&nbsp;u&nbsp;,&nbsp;<span class="constructor">T</span>.of_string&nbsp;v&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-diagonal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_diag_matrix_of_string."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_multi_diag_matrix_of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_multi_diag_matrix_of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;26&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;<span class="string">"Diff_to_multi_diag_matrix&nbsp;"</span>&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;26&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;-&nbsp;26&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;listing&nbsp;=&nbsp;<span class="constructor">Str</span>.split&nbsp;(&nbsp;<span class="constructor">Str</span>.regexp_string&nbsp;<span class="string">"&nbsp;$&nbsp;"</span>&nbsp;)&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;listing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;(&nbsp;<span class="constructor">List</span>.tl&nbsp;listing&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;uu&nbsp;=&nbsp;<span class="constructor">Util</span>.vector_of_string&nbsp;(&nbsp;<span class="constructor">Util</span>.bare_vector_of_string&nbsp;<span class="constructor">Coeff</span>.of_string&nbsp;)&nbsp;<span class="string">"{|"</span>&nbsp;<span class="string">"~"</span>&nbsp;<span class="string">"|}"</span>&nbsp;u&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;uu&nbsp;,&nbsp;<span class="constructor">T</span>.of_string&nbsp;v&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-multi-diagonal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_multi_diag_matrix_of_string."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>of_string string</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;of_string&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(s:string)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;sparse_tensor_matrix_of_string&nbsp;s<br>
&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;half_full_matrix_of_string&nbsp;s<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff_to_scal_matrix_of_string&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff_to_multi_scal_matrix_of_string&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff_to_diag_matrix_of_string&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff_to_multi_diag_matrix_of_string&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;valid&nbsp;string&nbsp;in&nbsp;Sparse_matrix.Rng.of_string."</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>print matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;print&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;print_string&nbsp;(&nbsp;to_string&nbsp;m&nbsp;)&nbsp;;<br>
&nbsp;print_newline&nbsp;()&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>description_eq_zero matrix</pre> This verification of nullity is superficial.
<p>

Cette vérification de nullité est superficielle. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;description_eq_zero&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.eq_zero&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">T</span>.eq_zero&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Util</span>.array_eq_zero&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;a&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">T</span>.eq_zero&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Util</span>.array_eq_zero&nbsp;<span class="constructor">V</span>.eq_zero&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Util</span>.array_eq_zero&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;a&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">T</span>.eq_zero&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Util</span>.array_eq_zero&nbsp;(&nbsp;<span class="constructor">Util</span>.array_eq_zero&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;)&nbsp;a&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">T</span>.eq_zero&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>description_eq matrix1 matrix2</pre> This verification of equality is superficial.
<p>

Cette vérification de nullité est superficielle. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;description_eq&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;(&nbsp;m&nbsp;,&nbsp;n&nbsp;)&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;,&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.eq&nbsp;w&nbsp;ww<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;,&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;xx&nbsp;,&nbsp;ww&nbsp;)&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.eq&nbsp;x&nbsp;xx&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">T</span>.eq&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;,&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">T</span>.eq&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;r&nbsp;&lt;&gt;&nbsp;rr&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.eq&nbsp;a.(!i)&nbsp;aa.(!i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;r&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;,&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;ww&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;r&nbsp;=&nbsp;rr&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.eq&nbsp;w.(!i)&nbsp;ww.(!i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;i&nbsp;:=&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;,&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;description_eq&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;)&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;,&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;)<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">T</span>.eq&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;aa<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;aa.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;r&nbsp;&lt;&gt;&nbsp;rr&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;c&nbsp;&lt;&gt;&nbsp;cc&nbsp;)<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">Util</span>.array_eq&nbsp;<span class="constructor">Coeff</span>.eq&nbsp;a.(!i)&nbsp;aa.(!i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;r&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Incompatible&nbsp;formats&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_matrix_eq."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_row_extract index tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_row_extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">T</span>.vector_demakeup&nbsp;(&nbsp;<span class="constructor">T</span>.tensor_to_vector&nbsp;(&nbsp;<span class="constructor">T</span>.sub_tensor_extract&nbsp;0&nbsp;i&nbsp;w&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_column_extract index tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_column_extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">T</span>.vector_demakeup&nbsp;(&nbsp;<span class="constructor">T</span>.tensor_to_vector&nbsp;(&nbsp;<span class="constructor">T</span>.sub_tensor_extract&nbsp;1&nbsp;i&nbsp;w&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>row_extract index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;row_extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_extract&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;i&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;v&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;cc&nbsp;(&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(&nbsp;j&nbsp;-&nbsp;shift&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;i&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;v&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;cc&nbsp;(&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(&nbsp;j&nbsp;-&nbsp;shift&nbsp;).(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>column_extract index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;column_extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;ii&nbsp;,&nbsp;x&nbsp;)&nbsp;=&nbsp;<span class="constructor">V</span>.unsafe_extract&nbsp;i&nbsp;w.(j)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_extract&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;i&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;v&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bound&nbsp;=&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;rr&nbsp;bound&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(&nbsp;bound&nbsp;-&nbsp;j&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;i&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;v&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bound&nbsp;=&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;rr&nbsp;bound&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(&nbsp;bound&nbsp;-&nbsp;j&nbsp;).(j)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>extract row column matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;snd&nbsp;(&nbsp;<span class="constructor">V</span>.extract&nbsp;j&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;snd&nbsp;(&nbsp;<span class="constructor">T</span>.extract&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;snd&nbsp;(&nbsp;<span class="constructor">T</span>.extract&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Coeff</span>.add&nbsp;y&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;snd&nbsp;(&nbsp;<span class="constructor">T</span>.extract&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a.(&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;snd&nbsp;(&nbsp;<span class="constructor">T</span>.extract&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;snd&nbsp;(&nbsp;<span class="constructor">T</span>.extract&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a.(&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;).(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_row_remove index tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_row_remove&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">T</span>.sub_tensor_remove&nbsp;0&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_column_remove index tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_column_remove&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">T</span>.sub_tensor_remove&nbsp;1&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>row_remove index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;row_remove&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.zero&nbsp;()<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_remove&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_row_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;y&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;i&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_row_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;a.(&nbsp;j&nbsp;-&nbsp;shift&nbsp;)&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;jj&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_row_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_row_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;a.(&nbsp;j&nbsp;-&nbsp;shift&nbsp;).(ii)&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;jj&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>column_remove index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;column_remove&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.remove&nbsp;i&nbsp;w.(j)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_remove&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_column_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;y&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;i&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_column_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bound&nbsp;=&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;bound&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;a.(&nbsp;bound&nbsp;-&nbsp;j&nbsp;)&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;jj&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_column_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;tensor_column_remove&nbsp;i&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bound&nbsp;=&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;bound&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_index&nbsp;=&nbsp;bound&nbsp;-&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;a.(row_index).(j)&nbsp;)&nbsp;[|&nbsp;jj&nbsp;;&nbsp;i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>remove row column matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;remove&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.remove&nbsp;j&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.remove&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;y&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i&nbsp;)&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.remove&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;a.(&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;)&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.remove&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.remove&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.remove&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;).(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_row_replace vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_row_replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">T</span>.sub_tensor_replace&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Vector</span>&nbsp;x&nbsp;)&nbsp;0&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_column_replace vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_column_replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">T</span>.sub_tensor_replace&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Vector</span>&nbsp;x&nbsp;)&nbsp;1&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>raw_row_replace vector index matrix</pre> For the types storing diagonal values on their own,
these ones are not taken into account in the operation.
This function is applied in place.
<p>

Cette fonction est exécutée en place.
Dans les types stockant des valeurs diagonales à part, celles-ci n'entrent pas en compte dans l'opération. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;raw_row_replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;x<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_replace&nbsp;x&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>raw_column_replace vector index matrix</pre> For the types storing diagonal values on their own,
these ones are not taken into account in the operation.
This function is applied in place.
<p>

Cette fonction est exécutée en place.
Dans les types stockant des valeurs diagonales à part, celles-ci n'entrent pas en compte dans l'opération. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;raw_column_replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.replace&nbsp;y&nbsp;i&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;f&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_replace&nbsp;x&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>row_replace vector index matrix</pre> This function is applied in place.
<p>

Cette fonction est exécutée en place. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;row_replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;x<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xi&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;i&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xi&nbsp;y&nbsp;)&nbsp;i&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xj&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;jj&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xj&nbsp;a.(&nbsp;j&nbsp;-&nbsp;shift&nbsp;)&nbsp;)&nbsp;jj&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xi&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;i&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xi&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;)&nbsp;i&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xj&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;jj&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xj&nbsp;a.(&nbsp;j&nbsp;-&nbsp;shift&nbsp;).(ii)&nbsp;)&nbsp;jj&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>column_replace vector index matrix</pre> This function is applied in place.
<p>

Cette fonction est exécutée en place. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;column_replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.replace&nbsp;y&nbsp;i&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;f&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_replace&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xi&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;i&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xi&nbsp;y&nbsp;)&nbsp;i&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_column_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bound&nbsp;=&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;bound&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xj&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;jj&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xj&nbsp;a.(&nbsp;bound&nbsp;-&nbsp;j&nbsp;)&nbsp;)&nbsp;jj&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_column_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xi&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;i&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xi&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;)&nbsp;i&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_column_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;<span class="constructor">V</span>.copy&nbsp;x<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bound&nbsp;=&nbsp;ii&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;shift&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;bound&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xj&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;jj&nbsp;xx&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;xj&nbsp;a.(&nbsp;bound&nbsp;-&nbsp;j&nbsp;).(j)&nbsp;)&nbsp;jj&nbsp;xx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_column_replace&nbsp;xx&nbsp;i&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>replace coefficient row column matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;replace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.replace&nbsp;x&nbsp;j&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.replace&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;x&nbsp;y&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i&nbsp;)&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;x&nbsp;a.(&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;)&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.remove&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i&nbsp;)&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;).(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.remove&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.replace&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_row_insert_add vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_row_insert_add&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">V</span>.add&nbsp;x&nbsp;row&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;y&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_column_insert_add vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_column_insert_add&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;column&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">V</span>.add&nbsp;x&nbsp;column&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_column_replace&nbsp;y&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>row_insert_add vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;row_insert_add&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;w.(ii)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.add&nbsp;x&nbsp;w.(ii)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_add&nbsp;x&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>column_insert_add vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;column_insert_add&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;y&nbsp;i&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;f&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_add&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_add&nbsp;x&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>insert_add coefficient row column matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;insert_add&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;j&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(ii)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;x&nbsp;a.(ii)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(jj).(ii)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;x&nbsp;a.(jj).(ii)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_row_insert_sub vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_row_insert_sub&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">V</span>.sub&nbsp;row&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;y&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_column_insert_sub vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_column_insert_sub&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;column&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">V</span>.sub&nbsp;column&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_column_replace&nbsp;y&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>row_insert_sub vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;row_insert_sub&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;w.(ii)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.sub&nbsp;w.(ii)&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_row_insert_sub&nbsp;x&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>column_insert_sub vector index matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;column_insert_sub&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:<span class="constructor">V</span>.t)&nbsp;(i:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_sub&nbsp;y&nbsp;i&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;f&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_sub&nbsp;x&nbsp;i&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_column_insert_sub&nbsp;x&nbsp;i&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>insert_sub coefficient row column matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;insert_sub&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_sub&nbsp;x&nbsp;j&nbsp;w.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(ii)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;a.(ii)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs&nbsp;diff&nbsp;&lt;=&nbsp;h_a_l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;h_a_l&nbsp;+&nbsp;diff&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(jj).(ii)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.sub&nbsp;a.(jj).(ii)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;x&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_diag_extract tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_diag_extract&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;e&nbsp;,&nbsp;t&nbsp;,&nbsp;v&nbsp;)&nbsp;=&nbsp;<span class="constructor">T</span>.flat_tensor_demakeup&nbsp;w<br>
&nbsp;<span class="keyword">and</span>&nbsp;ensemble&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.empty&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.dimension&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;table&nbsp;=&nbsp;(&nbsp;snd&nbsp;v&nbsp;).<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.data<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rows&nbsp;=&nbsp;t.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.min&nbsp;dim.(0)&nbsp;dim.(1)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;s&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;table&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;index&nbsp;,&nbsp;coefficient&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ensemble&nbsp;:=&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.union&nbsp;!ensemble&nbsp;table.(&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.raw_extract&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;index&nbsp;)&nbsp;coefficient&nbsp;)&nbsp;<span class="keyword">mod</span>&nbsp;s&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">Info</span>.iter&nbsp;f&nbsp;rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;i.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;ii&nbsp;i.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;ii&nbsp;diag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.iter&nbsp;g&nbsp;!ensemble&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diag&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_diag_extract tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_diag_extract&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.min&nbsp;dim.(0)&nbsp;dim.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;snd&nbsp;(&nbsp;<span class="constructor">V</span>.extract&nbsp;ii&nbsp;w.(i)&nbsp;)&nbsp;)&nbsp;ii&nbsp;diag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diag<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tensor_diag_extract&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tensor_diag_extract&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Unadapted&nbsp;format&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_diag_extract."</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;a.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tensor_diag_extract&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Unadapted&nbsp;format&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_diag_extract."</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Unadapted&nbsp;format&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_diag_extract."</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_diag_extract tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_diag_extract&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.min&nbsp;dim.(0)&nbsp;dim.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;dd&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;dd&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diag.(i)&nbsp;&lt;-&nbsp;snd&nbsp;(&nbsp;<span class="constructor">V</span>.extract&nbsp;ii&nbsp;w.(i)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diag<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.to_full&nbsp;(&nbsp;tensor_diag_extract&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">V</span>.to_full&nbsp;(&nbsp;tensor_diag_extract&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.add&nbsp;y&nbsp;)&nbsp;diag<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">V</span>.to_full&nbsp;(&nbsp;tensor_diag_extract&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;diag<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">V</span>.to_full&nbsp;(&nbsp;tensor_diag_extract&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a.(i)&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.mapi&nbsp;f&nbsp;diag<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">V</span>.to_full&nbsp;(&nbsp;tensor_diag_extract&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;).(i)&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.mapi&nbsp;f&nbsp;diag<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_diag_isolate tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;e&nbsp;,&nbsp;t&nbsp;,&nbsp;v&nbsp;)&nbsp;=&nbsp;<span class="constructor">T</span>.flat_tensor_demakeup&nbsp;w<br>
&nbsp;<span class="keyword">and</span>&nbsp;ensemble&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.empty&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.dimension&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;table&nbsp;=&nbsp;(&nbsp;snd&nbsp;v&nbsp;).<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.data<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rows&nbsp;=&nbsp;t.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;dim<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;s&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;table&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;index&nbsp;,&nbsp;coefficient&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ensemble&nbsp;:=&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.union&nbsp;!ensemble&nbsp;table.(&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.raw_extract&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;index&nbsp;)&nbsp;coefficient&nbsp;)&nbsp;<span class="keyword">mod</span>&nbsp;s&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">Info</span>.iter&nbsp;f&nbsp;rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;i.(0)&nbsp;i.(1)&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.iter&nbsp;g&nbsp;!ensemble&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diag_isolate matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;dd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;r&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;snd&nbsp;(&nbsp;<span class="constructor">V</span>.unsafe_extract&nbsp;ii&nbsp;w.(i)&nbsp;)&nbsp;)&nbsp;ii&nbsp;accu.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;a.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;,&nbsp;tensor_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;tensor_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;,&nbsp;tensor_diag_isolate&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_out_diag_isolate tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_out_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i.(0)&nbsp;i.(1)&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_upper_diag_isolate tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_upper_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;i.(0)&nbsp;i.(1)&nbsp;&lt;&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_lower_diag_isolate tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_lower_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;i.(0)&nbsp;i.(1)&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>out_diag_isolate matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;out_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.copy&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;r&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.remove&nbsp;ii&nbsp;accu.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b.(&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;tensor_out_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>upper_diag_isolate matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;upper_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.copy&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;r&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;(&nbsp;succ&nbsp;i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.ending&nbsp;ii&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s_h_a_l&nbsp;=&nbsp;succ&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;s_h_a_l&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aaa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;a&nbsp;s_h_a_l&nbsp;h_a_l&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.append&nbsp;aa&nbsp;aaa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s_h_a_l&nbsp;=&nbsp;succ&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;s_h_a_l&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;)&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aaa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;a&nbsp;s_h_a_l&nbsp;h_a_l&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.append&nbsp;aa&nbsp;aaa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;tensor_upper_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>lower_diag_isolate matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;lower_diag_isolate&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.copy&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;r&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;(&nbsp;pred&nbsp;i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.beginning&nbsp;ii&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s_h_a_l&nbsp;=&nbsp;succ&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;a&nbsp;0&nbsp;h_a_l&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aaa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;s_h_a_l&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.append&nbsp;aa&nbsp;aaa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s_h_a_l&nbsp;=&nbsp;succ&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;a&nbsp;0&nbsp;h_a_l&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aaa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;s_h_a_l&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.append&nbsp;aa&nbsp;aaa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;tensor_lower_diag_isolate&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="3_Coercitions"><h3>Coercitions</h3></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** These functions are not sealed.
<p>

Ces fonctions ne sont pas étanches. *)</span></td></tr></table><code class="code"><br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_half_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;to_half_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;dd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;y&nbsp;i.(1)&nbsp;accu.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;dd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;y&nbsp;i.(1)&nbsp;accu.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;accu.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;alength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;alength&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;multi-scalar&nbsp;dimension&nbsp;in&nbsp;Sparse_matrix.Rng.to_half_full."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;alength&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;dd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;i.(1)&nbsp;accu.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;accu.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i_i&nbsp;=&nbsp;i&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;i_i&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;ii&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;j&nbsp;-&nbsp;i_i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(jj)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;row<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;dd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;y&nbsp;i.(1)&nbsp;accu.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;r&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(i)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;accu.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;alength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;alength&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;multi-diagonal&nbsp;dimension&nbsp;in&nbsp;Sparse_matrix.Rng.to_half_full."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;alength&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;dd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;y&nbsp;i.(1)&nbsp;accu.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;accu.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i_i&nbsp;=&nbsp;i&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;i_i&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;ii&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;j&nbsp;-&nbsp;i_i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;a.(jj).(i)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;row<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;dd&nbsp;d.(1)&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_sparse_tensor matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;to_sparse_tensor&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mm:t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;j&nbsp;)&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;alength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;alength&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;multi-scalar&nbsp;dimension&nbsp;in&nbsp;Sparse_matrix.Rng.to_half_full."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;alength&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i_i&nbsp;=&nbsp;i&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;i_i&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;ii&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;j&nbsp;-&nbsp;i_i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;a.(jj)&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;;&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;dimensions&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;k&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;k&nbsp;;&nbsp;j&nbsp;|]&nbsp;u&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;(&nbsp;f&nbsp;i&nbsp;)&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;u<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;a.(i)&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;j&nbsp;)&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;alength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;alength&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;multi-scalar&nbsp;dimension&nbsp;in&nbsp;Sparse_matrix.Rng.to_half_full."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;alength&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i_i&nbsp;=&nbsp;i&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;+&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;i_i&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;ii&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jj&nbsp;=&nbsp;j&nbsp;-&nbsp;i_i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;a.(jj).(i)&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;;&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_diff_to_scal matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_diff_to_scal&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mmm:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mmm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;r&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;a.(rr)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(rr)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;to_sparse_tensor&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;sparse_tensor_matrix_demakeup&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;ww&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_scal&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_scal&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_scal&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_diff_to_multi_scal matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_diff_to_multi_scal&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mm:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;[|&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;|],&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;[|&nbsp;x&nbsp;|],&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_multi_scal&nbsp;(&nbsp;to_diff_to_scal&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_multi_scal&nbsp;(&nbsp;to_diff_to_scal&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_multi_scal&nbsp;(&nbsp;to_diff_to_scal&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_diff_to_diag matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_diff_to_diag&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mm:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;x&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;r&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;a.(rr)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(rr)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;to_sparse_tensor&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;d&nbsp;x&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;sparse_tensor_matrix_demakeup&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;ww&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_diag&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;r&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;a.(rr)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(rr)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;d&nbsp;()&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;to_sparse_tensor&nbsp;(&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;sparse_tensor_matrix_demakeup&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;ww&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_diff_to_multi_diag matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_diff_to_multi_diag&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mm:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;[|&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;[|&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;x&nbsp;)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;d&nbsp;)&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;w&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_diff_to_multi_diag&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;[|&nbsp;a&nbsp;|]&nbsp;,&nbsp;w&nbsp;)&nbsp;<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>half_full_matrix_to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;half_full_matrix_to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">V</span>.to_full&nbsp;)&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;half&nbsp;full&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.half_full_matrix_to_full."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_to_full_matrix tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_to_full_matrix&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;m.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(0)&nbsp;).(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i.(1)&nbsp;)&nbsp;&lt;-&nbsp;x&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_matrix_to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_matrix_to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sparse_tensor_to_full_matrix&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;sparse&nbsp;tensor&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_tensor_matrix_to_full."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_scal_matrix_to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_scal_matrix_to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;sparse_tensor_to_full_matrix&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m.(i).(i)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;m.(i).(i)&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;m<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-scalar&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_scal_matrix_to_full."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_multi_scal_matrix_to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_multi_scal_matrix_to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;sparse_tensor_to_full_matrix&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;m.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;ii&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;cc&nbsp;(&nbsp;i&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row.(j)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;row.(j)&nbsp;a.(&nbsp;j&nbsp;-&nbsp;ii&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-multi-scalar&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_multi_scal_matrix_to_full."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_diag_matrix_to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_diag_matrix_to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;sparse_tensor_to_full_matrix&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;min&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m.(i).(i)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;m.(i).(i)&nbsp;a.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;m<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-diagonal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_diag_matrix_to_full."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_multi_diag_matrix_to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_multi_diag_matrix_to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;sparse_tensor_to_full_matrix&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_a_l&nbsp;=&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;m&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;m.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;ii&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;cc&nbsp;(&nbsp;i&nbsp;+&nbsp;h_a_l&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row.(j)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;row.(j)&nbsp;a.(&nbsp;j&nbsp;-&nbsp;ii&nbsp;).(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;difference-to-multi-diagonal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.diff_to_multi_diag_matrix_to_full."</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_full matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;to_full&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sparse_tensor_matrix_to_full&nbsp;m<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;half_full_matrix_to_full&nbsp;m<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;diff_to_scal_matrix_to_full&nbsp;m<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;diff_to_multi_scal_matrix_to_full&nbsp;m<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;diff_to_diag_matrix_to_full&nbsp;m<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;diff_to_multi_diag_matrix_to_full&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>to_sparse size threshold matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;to_sparse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(size:int)&nbsp;(threshold:float)&nbsp;(m:coeff&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;filling_diag&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;<span class="keyword">and</span>&nbsp;filling_rows&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;c<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;tt&nbsp;=&nbsp;threshold&nbsp;*.&nbsp;(&nbsp;float&nbsp;r&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;wide&nbsp;=&nbsp;r&nbsp;&lt;=&nbsp;c<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;r&nbsp;;&nbsp;<span class="constructor">Index</span>.from_int&nbsp;c&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diag&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;with_diag&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;cc&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;marked_rows&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_input&nbsp;=&nbsp;m.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_output&nbsp;=&nbsp;<span class="constructor">V</span>.to_sparse&nbsp;size&nbsp;row_input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">V</span>.filling&nbsp;row_output&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;marked_rows&nbsp;:=&nbsp;i&nbsp;::&nbsp;!marked_rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with_diag.(i)&nbsp;&lt;-&nbsp;row_output&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">V</span>.eq_zero&nbsp;row_output&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;filling_rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;wide&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;row_input.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;x&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diag.(i)&nbsp;&lt;-&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;filling_diag&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;diag_is_small&nbsp;=&nbsp;(&nbsp;not&nbsp;wide&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;tt&nbsp;&gt;&nbsp;(&nbsp;float&nbsp;!filling_diag&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;diag_is_small&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;few_rows&nbsp;=&nbsp;tt&nbsp;&gt;&nbsp;(&nbsp;float&nbsp;!filling_rows&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;few_rows&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;!result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;<span class="constructor">Util</span>.list_non_empty&nbsp;!marked_rows&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;!marked_rows&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;(&nbsp;f&nbsp;i&nbsp;)&nbsp;with_diag.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;marked_rows&nbsp;:=&nbsp;<span class="constructor">List</span>.tl&nbsp;!marked_rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;!result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;with_diag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;!result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;<span class="constructor">Util</span>.list_non_empty&nbsp;!marked_rows&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;!marked_rows&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.remove&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;with_diag.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;(&nbsp;f&nbsp;i&nbsp;)&nbsp;with_diag.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;marked_rows&nbsp;:=&nbsp;<span class="constructor">List</span>.tl&nbsp;!marked_rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;diag&nbsp;,&nbsp;!result&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>auto_to_sparse threshold matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;auto_to_sparse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(threshold:float)&nbsp;(m:coeff&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;to_sparse&nbsp;(-1)&nbsp;threshold&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_vector_to_line_matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_vector_to_line_matrix&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;[|&nbsp;v&nbsp;|]&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_vector_to_square_matrix vector</pre> The vector is placed in the first row.
<p>

Le vecteur est placé dans la première ligne. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_vector_to_square_matrix&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;v&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;;&nbsp;i&nbsp;|]&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;f&nbsp;v&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;result&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_vector_to_square_matrix vector</pre> The vector is placed in the first row.
<p>

Le vecteur est placé dans la première ligne. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_vector_to_square_matrix&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;rr&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;v.(i)&nbsp;[|&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;;&nbsp;ii&nbsp;|]&nbsp;result&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;result&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="3_Autresoprations"><h3>Autres opérations</h3></span>
<span id="3_Otheroperations"><h3>Other operations</h3></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>eq_zero matrix</pre> This verification of nullity is correct, provided that the dimensions be not too big.
<p>

Cette vérification de nullité est correcte, à condition que les dimensions ne soient pas trop grandes.  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;eq_zero&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.eq_zero&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.eq_zero&nbsp;w.(!i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!accu&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;r&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!accu<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;eq_zero&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_transpose matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;in_place_transpose&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;mm&nbsp;=&nbsp;to_sparse_tensor&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;d.(0)&nbsp;d.(1)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Not&nbsp;a&nbsp;square&nbsp;half_full&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.in_place_transpose."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.(i)&nbsp;&lt;-&nbsp;column_extract&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;mm<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.level_exchange&nbsp;0&nbsp;1&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.level_exchange&nbsp;0&nbsp;1&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.level_exchange&nbsp;0&nbsp;1&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;r&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;r&nbsp;-&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu&nbsp;:=&nbsp;a.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(i)&nbsp;&lt;-&nbsp;a.(ii)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(ii)&nbsp;&lt;-&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.level_exchange&nbsp;0&nbsp;1&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.level_exchange&nbsp;0&nbsp;1&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;r&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r2&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;r&nbsp;-&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift&nbsp;=&nbsp;r2&nbsp;-&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu&nbsp;:=&nbsp;a.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.append&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;shift&nbsp;()&nbsp;)&nbsp;)&nbsp;a.(ii)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.(ii)&nbsp;&lt;-&nbsp;<span class="constructor">Util</span>.array_end&nbsp;shift&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>transpose matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;transpose&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;mm&nbsp;=&nbsp;to_sparse_tensor&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(0)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ww.(i)&nbsp;&lt;-&nbsp;column_extract&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;mm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;in_place_transpose&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mm<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_vector_to_column_matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_vector_to_column_matrix&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;transpose&nbsp;(&nbsp;sparse_vector_to_line_matrix&nbsp;v&nbsp;)&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>raw_find coefficient matrix</pre> If the coefficient <code class="code">x</code> is null, the search fails.
<p>

Si le coefficient <code class="code">x</code> est nul, la recherche échoue. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;raw_find&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_index&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;column_index&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;column_index&nbsp;:=&nbsp;<span class="constructor">V</span>.find&nbsp;x&nbsp;w.(!i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;!column_index&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_index&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;!row_index&nbsp;;&nbsp;!column_index&nbsp;|]<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.find&nbsp;x&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.find&nbsp;x&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.find&nbsp;x&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.find&nbsp;x&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.find&nbsp;x&nbsp;w&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>find coefficient matrix</pre> If the coefficient <code class="code">x</code> is null, the search fails.
<p>

Si le coefficient <code class="code">x</code> est nul, la recherche échoue. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;find&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raw_find&nbsp;x&nbsp;m<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.find&nbsp;x&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raw_find&nbsp;x&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_sub_row_iter function index beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_sub_row_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(i:index)&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;e&nbsp;,&nbsp;t&nbsp;,&nbsp;v&nbsp;)&nbsp;=&nbsp;<span class="constructor">T</span>.flat_tensor_demakeup&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;candidates&nbsp;=&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.mask_vector&nbsp;[|&nbsp;i&nbsp;;&nbsp;beginning&nbsp;|]&nbsp;[|&nbsp;i&nbsp;;&nbsp;ending&nbsp;|]&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Info</span>.raw_extract&nbsp;i&nbsp;t.(0)&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;(&nbsp;dim&nbsp;,&nbsp;table&nbsp;)&nbsp;=&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ensemble&nbsp;=&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.union&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.empty&nbsp;()&nbsp;)&nbsp;(&nbsp;snd&nbsp;candidates&nbsp;).<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.data<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;tab&nbsp;=&nbsp;table.<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.data&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;tab&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j1&nbsp;=&nbsp;j.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j.(0)&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;beginning&nbsp;j1&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;j1&nbsp;ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.iter&nbsp;g&nbsp;tab.(&nbsp;x&nbsp;<span class="keyword">mod</span>&nbsp;s&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.iter&nbsp;h&nbsp;ensemble&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_sub_row_extract index beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_sub_row_extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;j.(1)&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_sub_row_iter&nbsp;f&nbsp;i&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_sub_column_iter function index beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_sub_column_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(i:index)&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;e&nbsp;,&nbsp;t&nbsp;,&nbsp;v&nbsp;)&nbsp;=&nbsp;<span class="constructor">T</span>.flat_tensor_demakeup&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;candidates&nbsp;=&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.mask_vector&nbsp;[|&nbsp;beginning&nbsp;;&nbsp;i&nbsp;|]&nbsp;[|&nbsp;ending&nbsp;;&nbsp;i&nbsp;|]&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Info</span>.raw_extract&nbsp;i&nbsp;t.(1)&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;(&nbsp;dim&nbsp;,&nbsp;table&nbsp;)&nbsp;=&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ensemble&nbsp;=&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.union&nbsp;(&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.empty&nbsp;()&nbsp;)&nbsp;(&nbsp;snd&nbsp;candidates&nbsp;).<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.data<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;tab&nbsp;=&nbsp;table.<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.data&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;tab&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j.(1)&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;beginning&nbsp;j0&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;j0&nbsp;ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.<span class="constructor">M</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.iter&nbsp;g&nbsp;tab.(&nbsp;x&nbsp;<span class="keyword">mod</span>&nbsp;s&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">Multi_hash</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.iter&nbsp;h&nbsp;ensemble&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_sub_column_extract index beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_sub_column_extract&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;x&nbsp;j.(0)&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;f&nbsp;i&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_hor_band_iter function beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_hor_band_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;i.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;ii&nbsp;beginning&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;ii&nbsp;ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;g&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_masked_hor_band beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_masked_hor_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_hor_band_iter&nbsp;f&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_hor_band beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_hor_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;<span class="constructor">Index</span>.succ&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;ending&nbsp;beginning&nbsp;)&nbsp;;&nbsp;d.(1)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;<span class="constructor">Index</span>.sub&nbsp;i.(0)&nbsp;beginning&nbsp;;&nbsp;i.(1)&nbsp;|]&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tensor_hor_band_iter&nbsp;f&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_vert_band_iter function beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_vert_band_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;i.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;ii&nbsp;beginning&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;ii&nbsp;ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;g&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_masked_vert_band beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_masked_vert_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_vert_band_iter&nbsp;f&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_vert_band beginning ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_vert_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;d.(0)&nbsp;;&nbsp;<span class="constructor">Index</span>.succ&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;ending&nbsp;beginning&nbsp;)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;i.(0)&nbsp;;&nbsp;<span class="constructor">Index</span>.sub&nbsp;i.(1)&nbsp;beginning&nbsp;|]&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tensor_vert_band_iter&nbsp;f&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_head_iter function vert_ending hor_ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_head_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(vert_ending:index)&nbsp;(hor_ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i.(0)&nbsp;vert_ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i.(1)&nbsp;hor_ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;g&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_masked_head vert_ending hor_ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_masked_head&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_ending:index)&nbsp;(hor_ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_head_iter&nbsp;f&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_head vert_ending hor_ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_head&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_ending:index)&nbsp;(hor_ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;<span class="constructor">Index</span>.succ&nbsp;vert_ending&nbsp;;&nbsp;<span class="constructor">Index</span>.succ&nbsp;hor_ending&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_head_iter&nbsp;f&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_tail_iter function vert_beginning hor_beginning tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_tail_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(vert_beginning:index)&nbsp;(hor_beginning:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i.(0)&nbsp;vert_beginning&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i.(1)&nbsp;hor_beginning&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;g&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_masked_tail vert_beginning hor_beginning tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_masked_tail&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(hor_beginning:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_tail_iter&nbsp;f&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_tail vert_beginning hor_beginning tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_tail&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(hor_beginning:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;<span class="constructor">Index</span>.sub&nbsp;d.(0)&nbsp;vert_beginning&nbsp;;&nbsp;<span class="constructor">Index</span>.sub&nbsp;d.(1)&nbsp;hor_beginning&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;<span class="constructor">Index</span>.sub&nbsp;i.(0)&nbsp;vert_beginning&nbsp;;&nbsp;<span class="constructor">Index</span>.sub&nbsp;i.(1)&nbsp;hor_beginning&nbsp;|]&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_tail_iter&nbsp;f&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_sample_iter function vert_beginning vert_ending hor_beginning hor_ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_sample_iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(vert_beginning:index)&nbsp;(vert_ending:index)&nbsp;(hor_beginning:index)&nbsp;(hor_ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;i.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;column&nbsp;=&nbsp;i.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;row&nbsp;vert_beginning&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;row&nbsp;vert_ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;column&nbsp;hor_beginning&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;column&nbsp;hor_ending&nbsp;&lt;=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;g&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_masked_sample vert_beginning vert_ending hor_beginning hor_ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_masked_sample&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(vert_ending:index)&nbsp;(hor_beginning:index)&nbsp;(hor_ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;i&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;tensor_sample_iter&nbsp;f&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tensor_sample vert_beginning vert_ending hor_beginning hor_ending tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tensor_sample&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(vert_ending:index)&nbsp;(hor_beginning:index)&nbsp;(hor_ending:index)&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.succ&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;vert_ending&nbsp;vert_beginning&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.succ&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;hor_ending&nbsp;hor_beginning&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;r&nbsp;;&nbsp;c&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.insert_add&nbsp;x&nbsp;[|&nbsp;<span class="constructor">Index</span>.sub&nbsp;i.(0)&nbsp;vert_beginning&nbsp;;&nbsp;<span class="constructor">Index</span>.sub&nbsp;i.(1)&nbsp;hor_beginning&nbsp;|]&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tensor_sample_iter&nbsp;f&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>masked_hor_band beginning ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;masked_hor_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;0&nbsp;b&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;e&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_masked_hor_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_hor_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_diff_to_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_hor_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_diff_to_multi_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;0&nbsp;b&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;e&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aa.(i)&nbsp;&lt;-&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_hor_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;r&nbsp;c&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output&nbsp;=&nbsp;aa.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;input&nbsp;=&nbsp;a.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;b&nbsp;<span class="keyword">to</span>&nbsp;e&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.(j)&nbsp;&lt;-&nbsp;input.(j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_hor_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>masked_vert_band beginning ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;masked_vert_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.mask_vector&nbsp;beginning&nbsp;ending&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_masked_vert_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_vert_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_diff_to_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_vert_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_diff_to_multi_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;0&nbsp;b&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;e&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aa.(i)&nbsp;&lt;-&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_vert_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;r&nbsp;c&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hr&nbsp;=&nbsp;r&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output&nbsp;=&nbsp;aa.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;-&nbsp;hr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;input&nbsp;=&nbsp;a.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;b&nbsp;-&nbsp;ii&nbsp;)&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;cc&nbsp;(&nbsp;e&nbsp;-&nbsp;ii&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.(j)&nbsp;&lt;-&nbsp;input.(j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_vert_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>masked_head vert_ending hor_ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;masked_head&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_ending:index)&nbsp;(hor_ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.mask_vector&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)&nbsp;hor_ending&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_masked_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;(&nbsp;to_diff_to_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;(&nbsp;to_diff_to_multi_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;(&nbsp;min&nbsp;v&nbsp;h&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aa.(i)&nbsp;&lt;-&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;r&nbsp;c&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hr&nbsp;=&nbsp;r&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bound&nbsp;=&nbsp;min&nbsp;v&nbsp;cc&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output&nbsp;=&nbsp;aa.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;-&nbsp;hr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;input&nbsp;=&nbsp;a.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;bound&nbsp;(&nbsp;h&nbsp;-&nbsp;ii&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.(j)&nbsp;&lt;-&nbsp;input.(j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>masked_tail vert_beginning hor_beginning matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;masked_tail&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(hor_beginning:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning&nbsp;)&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.mask_vector&nbsp;hor_beginning&nbsp;d&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_masked_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;(&nbsp;to_diff_to_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;(&nbsp;to_diff_to_multi_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;v&nbsp;h&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aa.(i)&nbsp;&lt;-&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;r&nbsp;c&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hr&nbsp;=&nbsp;r&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bound&nbsp;=&nbsp;max&nbsp;0&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output&nbsp;=&nbsp;aa.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;-&nbsp;hr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;input&nbsp;=&nbsp;a.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;bound&nbsp;(&nbsp;h&nbsp;-&nbsp;ii&nbsp;)&nbsp;<span class="keyword">to</span>&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.(j)&nbsp;&lt;-&nbsp;input.(j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>masked_sample vert_beginning vert_ending hor_beginning hor_ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;masked_sample&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(vert_ending:index)&nbsp;(hor_beginning:index)&nbsp;(hor_ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning&nbsp;)&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.mask_vector&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_masked_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;(&nbsp;to_diff_to_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;masked_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;(&nbsp;to_diff_to_multi_diag&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ve&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;he&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;max&nbsp;vb&nbsp;hb&nbsp;)&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;(&nbsp;pred&nbsp;r&nbsp;)&nbsp;(&nbsp;min&nbsp;ve&nbsp;he&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aa.(i)&nbsp;&lt;-&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ve&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;he&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;r&nbsp;c&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hr&nbsp;=&nbsp;r&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;beginning&nbsp;=&nbsp;max&nbsp;0&nbsp;vb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ending&nbsp;=&nbsp;min&nbsp;ve&nbsp;cc&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output&nbsp;=&nbsp;aa.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;i&nbsp;-&nbsp;hr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;input&nbsp;=&nbsp;a.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;max&nbsp;beginning&nbsp;(&nbsp;hb&nbsp;-&nbsp;ii&nbsp;)&nbsp;<span class="keyword">to</span>&nbsp;min&nbsp;ending&nbsp;(&nbsp;he&nbsp;-&nbsp;ii&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.(j)&nbsp;&lt;-&nbsp;input.(j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_masked_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>hor_band beginning ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;hor_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;ending&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;e&nbsp;-&nbsp;b&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;succ&nbsp;r&nbsp;)&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;w.(&nbsp;b&nbsp;+&nbsp;i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_hor_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;hor_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;hor_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;hor_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;hor_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>vert_band beginning ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;vert_band&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(beginning:index)&nbsp;(ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.sub_vector&nbsp;beginning&nbsp;ending&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_vert_band&nbsp;beginning&nbsp;ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vert_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vert_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vert_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vert_band&nbsp;beginning&nbsp;ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>head vert_ending hor_ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;head&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_ending:index)&nbsp;(hor_ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ve&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;succ&nbsp;ve&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.succ&nbsp;hor_ending&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;max&nbsp;0&nbsp;ve&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.sub_vector&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)&nbsp;hor_ending&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_ending&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.sub&nbsp;a&nbsp;0&nbsp;(&nbsp;succ&nbsp;(&nbsp;min&nbsp;v&nbsp;h&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.sub&nbsp;b&nbsp;0&nbsp;(&nbsp;succ&nbsp;v&nbsp;)&nbsp;)&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_head&nbsp;vert_ending&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tail vert_beginning hor_beginning matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;tail&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(hor_beginning:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">V</span>.dimension&nbsp;w.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;r&nbsp;-&nbsp;vb&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dd&nbsp;=&nbsp;<span class="constructor">Index</span>.pred&nbsp;d&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;rr&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;d&nbsp;hor_beginning&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.sub_vector&nbsp;hor_beginning&nbsp;dd&nbsp;w.(&nbsp;vb&nbsp;+&nbsp;i&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_beginning&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Util</span>.array_end&nbsp;(&nbsp;min&nbsp;v&nbsp;h&nbsp;)&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Util</span>.array_end&nbsp;(&nbsp;max&nbsp;0&nbsp;v&nbsp;)&nbsp;)&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_head&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tail&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sample vert_beginning vert_ending hor_beginning hor_ending matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;sample&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(vert_beginning:index)&nbsp;(vert_ending:index)&nbsp;(hor_beginning:index)&nbsp;(hor_ending:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Index</span>.succ&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;hor_ending&nbsp;hor_beginning&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;vert_ending&nbsp;vert_beginning&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;succ&nbsp;rr&nbsp;)&nbsp;d&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.sub_vector&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w.(&nbsp;b&nbsp;+&nbsp;i&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;tensor_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;tensor_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ve&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;he&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;hor_ending&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.sub&nbsp;a&nbsp;vb&nbsp;(&nbsp;(&nbsp;min&nbsp;ve&nbsp;he&nbsp;)&nbsp;-&nbsp;vb&nbsp;+&nbsp;1&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;vert_beginning&nbsp;hor_beginning&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vb&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_beginning<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ve&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;vert_ending&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cc&nbsp;=&nbsp;ve&nbsp;-&nbsp;vb&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;succ&nbsp;cc&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;table&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.sub&nbsp;table&nbsp;vb&nbsp;c&nbsp;)&nbsp;a&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;tensor_sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sample&nbsp;vert_beginning&nbsp;vert_ending&nbsp;hor_beginning&nbsp;hor_ending&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>iter function matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;iter&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.iter&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;(&nbsp;[|&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;;&nbsp;j&nbsp;|]&nbsp;,&nbsp;x&nbsp;)&nbsp;)&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;iter&nbsp;f&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>row_exchange index1 index2 matrix</pre> This function is applied in place.
<p>

Cette fonction est exécutée en place.*)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;row_exchange&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;w.(ii)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.(ii)&nbsp;&lt;-&nbsp;w.(jj)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.(jj)&nbsp;&lt;-&nbsp;accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.exchange&nbsp;0&nbsp;i&nbsp;j&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.exchange&nbsp;0&nbsp;i&nbsp;j&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;y&nbsp;ii&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;y&nbsp;jj&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;j&nbsp;;&nbsp;i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;alength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.exchange&nbsp;0&nbsp;i&nbsp;j&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;alength&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;shift_i&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift_j&nbsp;=&nbsp;jj&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;k&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;alength&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;a.(k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ki&nbsp;=&nbsp;shift_i&nbsp;+&nbsp;k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;kj&nbsp;=&nbsp;shift_j&nbsp;+&nbsp;k&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;k_i&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;ki<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;k_j&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;kj&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;ki&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;ki&nbsp;&lt;&nbsp;c&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;aa&nbsp;[|&nbsp;j&nbsp;;&nbsp;k_i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;aa&nbsp;[|&nbsp;i&nbsp;;&nbsp;k_i&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;kj&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;kj&nbsp;&lt;&nbsp;c&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;aa&nbsp;[|&nbsp;i&nbsp;;&nbsp;k_j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;aa&nbsp;[|&nbsp;j&nbsp;;&nbsp;k_j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;j<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i_i&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;j_j&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.exchange&nbsp;0&nbsp;i&nbsp;j&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ai&nbsp;=&nbsp;a.(i_i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aj&nbsp;=&nbsp;a.(j_j)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;ai&nbsp;ii&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;aj&nbsp;jj&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;aj&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;ai&nbsp;[|&nbsp;j&nbsp;;&nbsp;i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;alength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">T</span>.dimensions&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.exchange&nbsp;0&nbsp;i&nbsp;j&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_a_l&nbsp;=&nbsp;alength&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;shift_i&nbsp;=&nbsp;ii&nbsp;-&nbsp;h_a_l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;shift_j&nbsp;=&nbsp;jj&nbsp;-&nbsp;h_a_l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;k&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;alength&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;a.(k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ki&nbsp;=&nbsp;shift_i&nbsp;+&nbsp;k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;kj&nbsp;=&nbsp;shift_j&nbsp;+&nbsp;k&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;k_i&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;ki<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;k_j&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;kj<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ai&nbsp;=&nbsp;aa.(ii)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aj&nbsp;=&nbsp;aa.(jj)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;ki&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;ki&nbsp;&lt;&nbsp;c&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;ai&nbsp;[|&nbsp;j&nbsp;;&nbsp;k_i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;ai&nbsp;[|&nbsp;i&nbsp;;&nbsp;k_i&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;kj&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;kj&nbsp;&lt;&nbsp;c&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;aj&nbsp;[|&nbsp;i&nbsp;;&nbsp;k_j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;aj&nbsp;[|&nbsp;j&nbsp;;&nbsp;k_j&nbsp;|]&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>column_exchange index1 index2 matrix</pre> This function is applied in place.
<p>

Cette fonction est exécutée en place. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;column_exchange&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(i:index)&nbsp;(j:index)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i&nbsp;j&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;k&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.exchange&nbsp;i&nbsp;j&nbsp;w.(k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.exchange&nbsp;1&nbsp;i&nbsp;j&nbsp;w<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.exchange&nbsp;1&nbsp;i&nbsp;j&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;y&nbsp;ii&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;y&nbsp;jj&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;y&nbsp;[|&nbsp;j&nbsp;;&nbsp;i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;jj&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;j<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i_i&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;j_j&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.exchange&nbsp;1&nbsp;i&nbsp;j&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ai&nbsp;=&nbsp;a.(i_i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aj&nbsp;=&nbsp;a.(j_j)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;ai&nbsp;ii&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_sub&nbsp;aj&nbsp;jj&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;ai&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;aj&nbsp;[|&nbsp;j&nbsp;;&nbsp;i&nbsp;|]&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ci&nbsp;=&nbsp;column_extract&nbsp;i&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cj&nbsp;=&nbsp;column_extract&nbsp;j&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;column_replace&nbsp;ci&nbsp;j&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;column_replace&nbsp;cj&nbsp;i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_map function matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;in_place_map&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">T</span>.in_place_map&nbsp;f&nbsp;w<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Diff_to_scal&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Rng.in_place_map."</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;a.(i)&nbsp;&lt;-&nbsp;f&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.in_place_map&nbsp;f&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.in_place_map&nbsp;f&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;a.(i)&nbsp;&lt;-&nbsp;f&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.in_place_map&nbsp;f&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;a.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;a.(i)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.in_place_map&nbsp;f&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>map function matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;map&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.map&nbsp;f&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;f&nbsp;x&nbsp;,&nbsp;<span class="constructor">T</span>.map&nbsp;f&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.map&nbsp;f&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">V</span>.map&nbsp;f&nbsp;)&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.map&nbsp;f&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;)&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.map&nbsp;f&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_opp matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;in_place_opp&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;in_place_map&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>opp matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;opp&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;map&nbsp;<span class="constructor">Coeff</span>.opp&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>embed dimensions shifts matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;embed&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(dim:index&nbsp;array)&nbsp;(shifts:index&nbsp;array)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;s0&nbsp;=&nbsp;shifts.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;s1&nbsp;=&nbsp;shifts.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;dim.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;dim.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;e0&nbsp;=&nbsp;<span class="constructor">Index</span>.add&nbsp;s0&nbsp;d.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;e1&nbsp;=&nbsp;<span class="constructor">Index</span>.add&nbsp;s1&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;r&nbsp;e0&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;c&nbsp;e1&nbsp;&gt;=&nbsp;0&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.embed&nbsp;dim&nbsp;shifts&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;embed&nbsp;dim&nbsp;shifts&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;embed&nbsp;dim&nbsp;shifts&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;s_0&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;s0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;r&nbsp;)&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ww.(&nbsp;s_0&nbsp;+&nbsp;i&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.embed&nbsp;c&nbsp;s1&nbsp;w.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;(&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;s0&nbsp;s1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rest&nbsp;=&nbsp;<span class="constructor">Index</span>.min&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;r&nbsp;e0&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;c&nbsp;e1&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aa&nbsp;=&nbsp;<span class="constructor">Array</span>.concat&nbsp;[&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;s0&nbsp;)&nbsp;()&nbsp;)&nbsp;;&nbsp;a&nbsp;;&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;rest&nbsp;)&nbsp;()&nbsp;)&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;<span class="constructor">T</span>.embed&nbsp;dim&nbsp;shifts&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;embed&nbsp;dim&nbsp;shifts&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;s0&nbsp;s1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rest&nbsp;=&nbsp;<span class="constructor">Index</span>.min&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;r&nbsp;e0&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.sub&nbsp;c&nbsp;e1&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.concat&nbsp;[&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;s0&nbsp;)&nbsp;()&nbsp;)&nbsp;;&nbsp;b&nbsp;;&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;rest&nbsp;)&nbsp;()&nbsp;)&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.embed&nbsp;dim&nbsp;shifts&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;embed&nbsp;dim&nbsp;shifts&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_dirty_rows_list tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_dirty_rows_list&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;e&nbsp;,&nbsp;t&nbsp;,&nbsp;v&nbsp;)&nbsp;=&nbsp;<span class="constructor">T</span>.flat_tensor_demakeup&nbsp;w<br>
&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rows&nbsp;=&nbsp;t.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;index&nbsp;,&nbsp;coefficient&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;result&nbsp;:=&nbsp;index&nbsp;::&nbsp;!result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">Info</span>.iter&nbsp;f&nbsp;rows&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_dirty_columns_list tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_dirty_columns_list&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;(&nbsp;e&nbsp;,&nbsp;t&nbsp;,&nbsp;v&nbsp;)&nbsp;=&nbsp;<span class="constructor">T</span>.flat_tensor_demakeup&nbsp;w<br>
&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;columns&nbsp;=&nbsp;t.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;index&nbsp;,&nbsp;coefficient&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;result&nbsp;:=&nbsp;index&nbsp;::&nbsp;!result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.<span class="constructor">Info</span>.iter&nbsp;f&nbsp;columns&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!result&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_dirty_rows_array tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_dirty_rows_array&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Array</span>.of_list&nbsp;(&nbsp;sparse_tensor_dirty_rows_list&nbsp;w&nbsp;)&nbsp;;;<br>
&nbsp;<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_tensor_dirty_columns_array tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_tensor_dirty_columns_array&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">T</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Array</span>.of_list&nbsp;(&nbsp;sparse_tensor_dirty_columns_list&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="3_Oprationsdecalcul"><h3>Opérations de calcul</h3></span>
<span id="3_Calculativeoperations"><h3>Calculative operations</h3></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_row_fold function init matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;sparse_row_fold&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(f:coeff&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;coeff)&nbsp;(init:<span class="constructor">V</span>.t)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;i&nbsp;)&nbsp;init&nbsp;)&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.to_sparse&nbsp;(&nbsp;<span class="constructor">V</span>.size&nbsp;init&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.mapi&nbsp;ff&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.empty&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;init&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.add&nbsp;(&nbsp;i.(0)&nbsp;,&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;i&nbsp;init<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;f&nbsp;y&nbsp;row&nbsp;)&nbsp;i&nbsp;result&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.iter&nbsp;g&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sparse_row_fold&nbsp;f&nbsp;init&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_column_fold function init matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;sparse_column_fold&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(f:coeff&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;coeff)&nbsp;(init:<span class="constructor">V</span>.t)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.empty&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">V</span>.dimension&nbsp;init&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.add&nbsp;(&nbsp;i.(1)&nbsp;,&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;i&nbsp;init<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;column&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;f&nbsp;y&nbsp;column&nbsp;)&nbsp;i&nbsp;result&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.iter&nbsp;g&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sparse_column_fold&nbsp;f&nbsp;init&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_row_fold function matrix init</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;full_row_fold&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(f:coeff&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;coeff)&nbsp;(init:coeff&nbsp;array)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;init.(i)&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.mapi&nbsp;ff&nbsp;w<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.empty&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;init&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.add&nbsp;(&nbsp;i.(0)&nbsp;,&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;!accu&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(ii)&nbsp;&lt;-&nbsp;f&nbsp;init.(ii)&nbsp;row&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.iter&nbsp;g&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;full_row_fold&nbsp;f&nbsp;init&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_column_fold function init matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;full_column_fold&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(f:coeff&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;coeff)&nbsp;(init:coeff&nbsp;array)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.empty&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;init&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.add&nbsp;(&nbsp;i.(1)&nbsp;,&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;!accu&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;column&nbsp;=&nbsp;tensor_column_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(ii)&nbsp;&lt;-&nbsp;f&nbsp;init.(ii)&nbsp;column&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.iter&nbsp;g&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;full_column_fold&nbsp;f&nbsp;init&nbsp;(&nbsp;to_sparse_tensor&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_row_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_row_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sum&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sparse_row_fold&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;d.(0)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_column_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_column_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sum&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sparse_column_fold&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;d.(1)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_row_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_row_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sum&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_column_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_column_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sum&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_matrix_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_matrix_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;sparse_row_sum&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">V</span>.sum&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_matrix_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_matrix_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;full_row_sum&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>matrix_sparse_vector_sparse_prod matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;matrix_sparse_vector_sparse_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;v&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;sparse_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>matrix_full_vector_sparse_prod matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;matrix_full_vector_sparse_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sparse_full_scal_prod&nbsp;w&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;sparse_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>matrix_sparse_vector_full_prod matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;matrix_sparse_vector_full_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;v&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>matrix_full_vector_full_prod matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;matrix_full_vector_full_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sparse_full_scal_prod&nbsp;w&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_vector_matrix_sparse_prod vector matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_vector_matrix_sparse_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;v&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;sparse_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_vector_matrix_sparse_prod vector matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_vector_matrix_sparse_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(v:coeff&nbsp;array)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sparse_full_scal_prod&nbsp;w&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">V</span>.null&nbsp;d.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;sparse_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_vector_matrix_full_prod vector matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_vector_matrix_full_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(v:<span class="constructor">V</span>.t)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;v&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_vector_matrix_full_prod vector matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_vector_matrix_full_prod&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(v:coeff&nbsp;array)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.sparse_full_scal_prod&nbsp;w&nbsp;v<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_row_max matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_row_max&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.max&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sparse_row_fold&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;d.(0)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_column_max matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_column_max&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.max&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sparse_column_fold&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;d.(1)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_row_max matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_row_max&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.max&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_column_max matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_column_max&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.max&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_matrix_max matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_matrix_max&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;sparse_row_max&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">V</span>.max&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_matrix_max matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_matrix_max&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;full_row_max&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_row_min matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_row_min&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.min&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sparse_row_fold&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;d.(0)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_column_min matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_column_min&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.min&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sparse_column_fold&nbsp;f&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;d.(1)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_row_min matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_row_min&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.min&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(0)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_row_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_column_min matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_column_min&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.min&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;d.(1)&nbsp;)&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;full_column_fold&nbsp;f&nbsp;z&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_matrix_min matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_matrix_min&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;sparse_row_min&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">V</span>.min&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_matrix_min matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_matrix_min&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;full_row_min&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>norm_inf matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;norm_inf&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Util</span>.array_maximum&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.norm_1&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.empty&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accumulator&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.add&nbsp;(&nbsp;i.(0)&nbsp;,&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accumulator&nbsp;:=&nbsp;(&nbsp;<span class="constructor">V</span>.norm_1&nbsp;row&nbsp;)&nbsp;::&nbsp;!accumulator&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.iter&nbsp;g&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;<span class="constructor">Util</span>.list_non_empty&nbsp;!accumulator&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;!accumulator&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;test&nbsp;!result&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;test&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accumulator&nbsp;:=&nbsp;<span class="constructor">List</span>.tl&nbsp;!accumulator&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;norm_inf&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>norm_1 matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;norm_1&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.norm_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.norm_inf&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.empty&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accumulator&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;accu&nbsp;:=&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.add&nbsp;(&nbsp;i.(0)&nbsp;,&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;!accu<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;tensor_row_extract&nbsp;i&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accumulator&nbsp;:=&nbsp;(&nbsp;<span class="constructor">V</span>.norm_inf&nbsp;row&nbsp;)&nbsp;::&nbsp;!accumulator&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.<span class="constructor">H</span>.<span class="constructor">B</span>.<span class="constructor">E</span>.iter&nbsp;g&nbsp;!accu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;<span class="constructor">Util</span>.list_non_empty&nbsp;!accumulator&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;!accumulator&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm_add&nbsp;test&nbsp;!result&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accumulator&nbsp;:=&nbsp;<span class="constructor">List</span>.tl&nbsp;!accumulator&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;norm_1&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>square_norm_frobenius matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;square_norm_frobenius&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.norm_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.square_norm_2&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm_add&nbsp;!result&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_mult&nbsp;y&nbsp;y&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;square_norm_frobenius&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>norm_sum matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;norm_sum&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.norm_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.norm_1&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_zero&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm_add&nbsp;!result&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;norm_sum&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_trace matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_trace&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;sparse_diag_extract&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">V</span>.sum&nbsp;d&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_trace matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_trace&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;full_diag_extract&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;<span class="constructor">Coeff</span>.add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)&nbsp;d&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>trace matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;trace&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;sparse_trace&nbsp;m<br>
&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;full_trace&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>scal_mult coefficient matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;scal_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;x&nbsp;)&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.scal_mult&nbsp;x&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;x&nbsp;y&nbsp;,&nbsp;<span class="constructor">T</span>.scal_mult&nbsp;x&nbsp;w&nbsp;)&nbsp;<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;x&nbsp;)&nbsp;y&nbsp;,&nbsp;<span class="constructor">T</span>.scal_mult&nbsp;x&nbsp;w&nbsp;)<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;x&nbsp;)&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.scal_mult&nbsp;x&nbsp;w&nbsp;)&nbsp;<br>
&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;x&nbsp;)&nbsp;)&nbsp;a&nbsp;,&nbsp;<span class="constructor">T</span>.scal_mult&nbsp;x&nbsp;w&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>add matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;add&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;test&nbsp;=&nbsp;(&nbsp;description_eq_zero&nbsp;m&nbsp;,&nbsp;description_eq_zero&nbsp;n&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;d&nbsp;=&nbsp;dimensions&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;test&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="keyword">true</span>&nbsp;,&nbsp;_&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;copy&nbsp;n<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="keyword">false</span>&nbsp;,&nbsp;<span class="keyword">true</span>&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;copy&nbsp;m<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;d.(1)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;<span class="constructor">V</span>.add&nbsp;w.(i)&nbsp;ww.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;yy&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;yy&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;aa&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;aa&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;aa&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;y&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;yy&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.add&nbsp;y&nbsp;yy&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;aa<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aalength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b.(&nbsp;aalength&nbsp;/&nbsp;2&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Coeff</span>.add&nbsp;b.(&nbsp;aalength&nbsp;/&nbsp;2&nbsp;)&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.add&nbsp;y&nbsp;)&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;aa<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;aalength&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b.(&nbsp;aalength&nbsp;/&nbsp;2&nbsp;)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Coeff</span>.add&nbsp;y&nbsp;)&nbsp;b.(&nbsp;aalength&nbsp;/&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;yy&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Util</span>.array_center_add&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;yy&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Util</span>.array_map2&nbsp;<span class="constructor">Coeff</span>.add&nbsp;a&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Util</span>.array_center_add&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;(&nbsp;<span class="constructor">Util</span>.array_map2&nbsp;<span class="constructor">Coeff</span>.add&nbsp;)&nbsp;[|&nbsp;a&nbsp;|]&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;yy&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;add&nbsp;n&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;aa&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Util</span>.array_center_add&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Coeff</span>.copy&nbsp;)&nbsp;(&nbsp;<span class="constructor">Util</span>.array_map2&nbsp;<span class="constructor">Coeff</span>.add&nbsp;)&nbsp;a&nbsp;aa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_multi_diag_matrix</span>&nbsp;(&nbsp;b&nbsp;,&nbsp;<span class="constructor">T</span>.add&nbsp;w&nbsp;ww&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sub matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sub&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;add&nbsp;m&nbsp;(&nbsp;opp&nbsp;n&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>eq matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;eq&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;eq_zero&nbsp;(&nbsp;sub&nbsp;m&nbsp;n&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>twisted_mult matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;twisted_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dm&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;dn&nbsp;=&nbsp;dimensions&nbsp;n<br>
&nbsp;<span class="keyword">and</span>&nbsp;test&nbsp;=&nbsp;(&nbsp;description_eq_zero&nbsp;m&nbsp;,&nbsp;description_eq_zero&nbsp;n&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dm0&nbsp;=&nbsp;dm.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dm1&nbsp;=&nbsp;dm.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn0&nbsp;=&nbsp;dn.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn1&nbsp;=&nbsp;dn.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dm1&nbsp;dn1&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.twisted_mult."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;test&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="keyword">true</span>&nbsp;,&nbsp;_&nbsp;)&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="keyword">false</span>&nbsp;,&nbsp;<span class="keyword">true</span>&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dm0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;dn0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_output&nbsp;=&nbsp;result.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_input_left&nbsp;=&nbsp;w.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;row_input_left&nbsp;ww.(j)&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;row_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dm0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;dn0&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;row_input_left&nbsp;row_output&nbsp;(&nbsp;a&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j&nbsp;=&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;k&nbsp;=&nbsp;a.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;(&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;k&nbsp;row_input_left&nbsp;)&nbsp;y&nbsp;)&nbsp;j&nbsp;row_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;(&nbsp;f&nbsp;w.(i)&nbsp;result.(i)&nbsp;)&nbsp;ww&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;xx&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;dn0&nbsp;dn1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(&nbsp;scal_mult&nbsp;xx&nbsp;m&nbsp;)&nbsp;(&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dn0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;j&nbsp;row_input_right&nbsp;(&nbsp;a&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;k&nbsp;=&nbsp;a.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;(&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;k&nbsp;row_input_right&nbsp;)&nbsp;y&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;(&nbsp;f&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;ww.(j)&nbsp;)&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rows&nbsp;=&nbsp;sparse_tensor_dirty_rows_array&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;columns&nbsp;=&nbsp;sparse_tensor_dirty_rows_array&nbsp;ww&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;rows<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;columns&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dirty_right&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;c&nbsp;(&nbsp;<span class="constructor">V</span>.null&nbsp;dn1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dirty_right.(i)&nbsp;&lt;-&nbsp;tensor_row_extract&nbsp;columns.(i)&nbsp;ww<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;first_index&nbsp;=&nbsp;rows.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_input_left&nbsp;=&nbsp;tensor_row_extract&nbsp;first_index&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coefficient&nbsp;=&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;row_input_left&nbsp;dirty_right.(j)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;coefficient&nbsp;[|&nbsp;first_index&nbsp;;&nbsp;columns.(j)&nbsp;|]&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;xx&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;dn0&nbsp;dn1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(&nbsp;scal_mult&nbsp;xx&nbsp;m&nbsp;)&nbsp;(&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;dm0&nbsp;dm1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(&nbsp;scal_mult&nbsp;x&nbsp;n&nbsp;)&nbsp;(&nbsp;twisted_mult&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;)&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;twisted_mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;twisted_mult&nbsp;(&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;a.(0)&nbsp;,&nbsp;w&nbsp;)&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;twisted_mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;twisted_mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>mult matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dm&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;dn&nbsp;=&nbsp;dimensions&nbsp;n<br>
&nbsp;<span class="keyword">and</span>&nbsp;test&nbsp;=&nbsp;(&nbsp;description_eq_zero&nbsp;m&nbsp;,&nbsp;description_eq_zero&nbsp;n&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dm0&nbsp;=&nbsp;dm.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dm1&nbsp;=&nbsp;dm.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn0&nbsp;=&nbsp;dn.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn1&nbsp;=&nbsp;dn.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dm1&nbsp;dn0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.mult."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;test&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="keyword">true</span>&nbsp;,&nbsp;_&nbsp;)&nbsp;<span class="keywordsign">|</span>&nbsp;(&nbsp;<span class="keyword">false</span>&nbsp;,&nbsp;<span class="keyword">true</span>&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn1&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;ww&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;transpose&nbsp;(&nbsp;to_sparse_tensor&nbsp;n&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dm0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;dn1&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;row_input_left&nbsp;row_output&nbsp;(&nbsp;a&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;k&nbsp;=&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;j&nbsp;=&nbsp;a.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;(&nbsp;<span class="constructor">V</span>.raw_extract&nbsp;k&nbsp;row_input_left&nbsp;)&nbsp;y&nbsp;)&nbsp;j&nbsp;row_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;(&nbsp;f&nbsp;w.(i)&nbsp;result.(i)&nbsp;)&nbsp;ww&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;xx&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;dn0&nbsp;dn1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(&nbsp;scal_mult&nbsp;xx&nbsp;m&nbsp;)&nbsp;(&nbsp;mult&nbsp;m&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mult&nbsp;m&nbsp;(&nbsp;to_sparse_tensor&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn1&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rows&nbsp;=&nbsp;sparse_tensor_dirty_rows_array&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;columns&nbsp;=&nbsp;sparse_tensor_dirty_columns_array&nbsp;ww&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;rows<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;columns&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dirty_right&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;c&nbsp;dn0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dirty_right.(i)&nbsp;&lt;-&nbsp;tensor_column_extract&nbsp;columns.(i)&nbsp;ww<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;first_index&nbsp;=&nbsp;rows.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_input_left&nbsp;=&nbsp;tensor_row_extract&nbsp;first_index&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coefficient&nbsp;=&nbsp;<span class="constructor">V</span>.scal_prod&nbsp;row_input_left&nbsp;dirty_right.(j)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;coefficient&nbsp;[|&nbsp;first_index&nbsp;;&nbsp;columns.(j)&nbsp;|]&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;xx&nbsp;,&nbsp;ww&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;dn0&nbsp;dn1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;(&nbsp;<span class="constructor">T</span>.scal_mult&nbsp;xx&nbsp;w&nbsp;)&nbsp;)&nbsp;(&nbsp;mult&nbsp;m&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;ww&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mult&nbsp;m&nbsp;(&nbsp;to_sparse_tensor&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;dm0&nbsp;dm1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(&nbsp;scal_mult&nbsp;x&nbsp;n&nbsp;)&nbsp;(&nbsp;mult&nbsp;(&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;)&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_multi_scal_matrix</span>&nbsp;(&nbsp;a&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;a&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;(&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;a.(0)&nbsp;,&nbsp;w&nbsp;)&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_full_twisted_mult matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;sparse_full_twisted_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:coeff&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dm&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;rn&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;n<br>
&nbsp;<span class="keyword">and</span>&nbsp;test&nbsp;=&nbsp;description_eq_zero&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dm0&nbsp;=&nbsp;dm.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dm1&nbsp;=&nbsp;dm.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn0&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;rn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dm1&nbsp;)&nbsp;&lt;&gt;&nbsp;rn&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_full_twisted_mult."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;test&nbsp;=&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dm0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;dn0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_output&nbsp;=&nbsp;result.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_input_left&nbsp;=&nbsp;w.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;<span class="constructor">V</span>.sparse_full_scal_prod&nbsp;row_input_left&nbsp;n.(j)&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;row_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dn0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">T</span>.null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;j&nbsp;row_input_right&nbsp;(&nbsp;a&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;a.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;k&nbsp;=&nbsp;a.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;row_input_right.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;k&nbsp;)&nbsp;y&nbsp;)&nbsp;[|&nbsp;i&nbsp;;&nbsp;j&nbsp;|]&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;r&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;(&nbsp;f&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;n.(j)&nbsp;)&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sparse_full_twisted_mult&nbsp;(&nbsp;to_half_full&nbsp;m&nbsp;)&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sparse_full_mult matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sparse_full_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:coeff&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dm&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;rn&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;n<br>
&nbsp;<span class="keyword">and</span>&nbsp;cn&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;n.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;test&nbsp;=&nbsp;description_eq_zero&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dm0&nbsp;=&nbsp;dm.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dm1&nbsp;=&nbsp;dm.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn1&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;cn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dm1&nbsp;)&nbsp;&lt;&gt;&nbsp;rn&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.sparse_full_mult."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;test&nbsp;=&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn1&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sparse_full_twisted_mult&nbsp;m&nbsp;(&nbsp;<span class="constructor">Util</span>.transpose&nbsp;n&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_sparse_twisted_mult matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;full_sparse_twisted_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:coeff&nbsp;array&nbsp;array)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dn&nbsp;=&nbsp;dimensions&nbsp;n<br>
&nbsp;<span class="keyword">and</span>&nbsp;rm&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;cm&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;test&nbsp;=&nbsp;description_eq_zero&nbsp;n&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dn0&nbsp;=&nbsp;dn.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn1&nbsp;=&nbsp;dn.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dm0&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;rm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;cm&nbsp;&lt;&gt;&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dn1&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.full_sparse_twisted_mult."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;test&nbsp;=&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;n&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;rm&nbsp;dn0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;rm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;pred&nbsp;cm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_output&nbsp;=&nbsp;result.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_input_left&nbsp;=&nbsp;m.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;cc&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;<span class="constructor">V</span>.sparse_full_scal_prod&nbsp;w.(j)&nbsp;row_input_left&nbsp;)&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;j&nbsp;)&nbsp;row_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sparse_tensor_matrix</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">V</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;rm&nbsp;dn0&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;row_in&nbsp;row_out&nbsp;(&nbsp;a&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">V</span>.insert_add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;x&nbsp;row_in.(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;a.(1)&nbsp;)&nbsp;)&nbsp;a.(0)&nbsp;row_out&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;rm&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_output&nbsp;=&nbsp;result.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_input_left&nbsp;=&nbsp;m.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">T</span>.iter&nbsp;(&nbsp;f&nbsp;row_input_left&nbsp;row_output&nbsp;)&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Half_full_matrix</span>&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;full_sparse_twisted_mult&nbsp;m&nbsp;(&nbsp;to_half_full&nbsp;n&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_sparse_mult matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;full_sparse_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:coeff&nbsp;array&nbsp;array)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dn&nbsp;=&nbsp;dimensions&nbsp;n<br>
&nbsp;<span class="keyword">and</span>&nbsp;rm&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;cm&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;test&nbsp;=&nbsp;description_eq_zero&nbsp;n&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dn0&nbsp;=&nbsp;dn.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dn1&nbsp;=&nbsp;dn.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dm0&nbsp;=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;rm&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;cm&nbsp;&lt;&gt;&nbsp;(&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dn0&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;dimensions&nbsp;in&nbsp;Sparse_matrix.Rng.full_sparse_mult."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;test&nbsp;=&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;[|&nbsp;dm0&nbsp;;&nbsp;dn1&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;transpose&nbsp;(&nbsp;sparse_full_twisted_mult&nbsp;(&nbsp;transpose&nbsp;n&nbsp;)&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>triple_mult matrix1 matrix2 matrix3</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;triple_mult&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;twisted_mult&nbsp;m&nbsp;(&nbsp;twisted_mult&nbsp;(&nbsp;transpose&nbsp;p&nbsp;)&nbsp;n&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>commut matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;commut&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(n:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;sub&nbsp;(&nbsp;mult&nbsp;m&nbsp;n&nbsp;)&nbsp;(&nbsp;mult&nbsp;n&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ § § </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
<span class="keyword">end</span>&nbsp;;;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Field</span>&nbsp;(<span class="constructor">Index</span>:<span class="constructor">Data</span>.<span class="constructor">Index_type</span>)&nbsp;(<span class="constructor">Hasher</span>:<span class="constructor">Hash</span>.<span class="constructor">Hash_type</span>&nbsp;<span class="keyword">with</span>&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Index</span>.t)&nbsp;(<span class="constructor">Coeff</span>:<span class="constructor">Data</span>.<span class="constructor">Field_coeff_type</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
<br>
<span class="keyword">include</span>&nbsp;<span class="constructor">Rng</span>&nbsp;(<span class="constructor">Index</span>)&nbsp;(<span class="constructor">Hasher</span>)&nbsp;(<span class="constructor">Coeff</span>)&nbsp;;;<br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">U</span>&nbsp;=&nbsp;<span class="constructor">Sparse_vector</span>.<span class="constructor">Field</span>&nbsp;(<span class="constructor">Index</span>)&nbsp;(<span class="constructor">Hasher</span>)&nbsp;(<span class="constructor">Coeff</span>)&nbsp;;;<br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">S</span>&nbsp;=&nbsp;<span class="constructor">Sparse_tensor</span>.<span class="constructor">Field</span>&nbsp;(<span class="constructor">Index</span>)&nbsp;(<span class="constructor">Hasher</span>)&nbsp;(<span class="constructor">Coeff</span>)&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** The coefficient two is used at different places for matrix calculations.
<p>

Le coefficient deux est utilisé à différents endroits pour les calculs matriciels. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;coeff_two&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Coeff</span>.add&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;);;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** The coefficient one half is used at different places for matrix calculations.
The characteristic of the field is supposed to be different from two.
<p>

Le coefficient un demi est utilisé à différents endroits pour les calculs matriciels.
On suppose que la caractéristique du corps est différente de deux. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;coeff_half&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Coeff</span>.inv&nbsp;(&nbsp;coeff_two&nbsp;()&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>scal_left_div scalar matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;scal_left_div&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:coeff)&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;scal_mult&nbsp;(&nbsp;<span class="constructor">Coeff</span>.inv&nbsp;x&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>reciprocal matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;reciprocal&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;scal_left_div&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm_inject&nbsp;(&nbsp;square_norm_frobenius&nbsp;m&nbsp;)&nbsp;)&nbsp;m&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>sym matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sym&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;scal_mult&nbsp;(&nbsp;coeff_half&nbsp;()&nbsp;)&nbsp;(&nbsp;add&nbsp;m&nbsp;(&nbsp;transpose&nbsp;m&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>antisym matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;antisym&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;scal_mult&nbsp;(&nbsp;coeff_half&nbsp;()&nbsp;)&nbsp;(&nbsp;sub&nbsp;m&nbsp;(&nbsp;transpose&nbsp;m&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_pivot_downward matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;in_place_pivot_downward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;error_message&nbsp;=&nbsp;<span class="string">"Non&nbsp;invertible&nbsp;left&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Field.in_place_pivot_downward."</span>&nbsp;;<br>
&nbsp;<span class="keyword">and</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;dip&nbsp;=&nbsp;dimensions&nbsp;p<br>
&nbsp;<span class="keyword">and</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip0&nbsp;=&nbsp;dip.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip1&nbsp;=&nbsp;dip.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;norm_coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dip0&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;col&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;!ii<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dim0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;=&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ii&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;!ii&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;extract&nbsp;!ii&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;col&nbsp;:=&nbsp;column_extract&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;j&nbsp;!ii&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nx&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;nx&nbsp;!norm_coeff&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;nx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;j&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.iter&nbsp;f&nbsp;!col&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coeff&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!index&nbsp;!ii&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!ii&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;col&nbsp;:=&nbsp;column_extract&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;!ii&nbsp;!substraction_row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_left&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_right&nbsp;:=&nbsp;row_extract&nbsp;!ii&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_right&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_right&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_right&nbsp;!ii&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;j&nbsp;!ii&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;j&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;x&nbsp;!substraction_row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!ii&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;j&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;row_extract&nbsp;j&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_right&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;x&nbsp;!substraction_row_right&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_right&nbsp;j&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.iter&nbsp;g&nbsp;!col&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>pivot_downward matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;pivot_downward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;copy&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_pivot_downward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;[|&nbsp;mm&nbsp;;&nbsp;pp&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>invertibility matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;invertibility&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;norm_coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;col&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;!ii<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dim0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;=&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ii&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;!ii&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;extract&nbsp;!ii&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;col&nbsp;:=&nbsp;column_extract&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;j&nbsp;!ii&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nx&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;nx&nbsp;!norm_coeff&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;nx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;j&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.iter&nbsp;f&nbsp;!col&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coeff&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"The&nbsp;end."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!index&nbsp;!ii&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;!ii&nbsp;!substraction_row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_left&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;h&nbsp;=&nbsp;!i&nbsp;+&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hh&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;h&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;!hh&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">U</span>.raw_extract&nbsp;!ii&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!substraction_row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!ii&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;!hh&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>det matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;det&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;norm_coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ii&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;col&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;!ii<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dim0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&lt;=&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ii&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;!ii&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;extract&nbsp;!ii&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;col&nbsp;:=&nbsp;column_extract&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;j&nbsp;!ii&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nx&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;nx&nbsp;!norm_coeff&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;nx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;j&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.iter&nbsp;f&nbsp;!col&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coeff&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"The&nbsp;end."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!index&nbsp;!ii&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;!result&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;!ii&nbsp;!substraction_row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_left&nbsp;!ii&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;h&nbsp;=&nbsp;!i&nbsp;+&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hh&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;h&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;!hh&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">U</span>.raw_extract&nbsp;!ii&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!substraction_row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!ii&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;!hh&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_pivot_upward matrix1 matrix2</pre> The left matrix is supposed to be upper triangular with 
ones on the diagonal.
<p>

La matrice de gauche est supposée triangulaire supérieure avec des uns sur la diagonale. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;in_place_pivot_upward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;dip&nbsp;=&nbsp;dimensions&nbsp;p<br>
&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip0&nbsp;=&nbsp;dip.(0)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip1&nbsp;=&nbsp;dip.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dip0&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;col&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Index</span>.to_int&nbsp;dim0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;rr&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ii&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!i&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ii&nbsp;:=&nbsp;<span class="constructor">Index</span>.from_int&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_right&nbsp;:=&nbsp;row_extract&nbsp;!ii&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;col&nbsp;:=&nbsp;column_extract&nbsp;!ii&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.compare&nbsp;j&nbsp;!ii&nbsp;&lt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;!hh&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;x&nbsp;!row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!ii&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;!hh&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;row_extract&nbsp;!hh&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_right&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;x&nbsp;!row_right&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_right&nbsp;!hh&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.iter&nbsp;g&nbsp;!col&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;decr&nbsp;i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>pivot_upward matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;pivot_upward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;copy&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_pivot_upward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;[|&nbsp;mm&nbsp;;&nbsp;pp&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>inv matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;inv&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;,&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;dimensions&nbsp;m&nbsp;).(0)&nbsp;)&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_pivot_downward&nbsp;mm&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;in_place_pivot_upward&nbsp;mm&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;p&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>left_quotient matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;left_quotient&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;copy&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_pivot_downward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;in_place_pivot_upward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;pp&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>right_quotient matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;right_quotient&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;transpose&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;transpose&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_pivot_downward&nbsp;pp&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;in_place_pivot_upward&nbsp;pp&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;transpose&nbsp;mm&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>cond norm invertor matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;cond&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;norm&nbsp;invertor&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Coeff</span>.norm_mult&nbsp;(&nbsp;norm&nbsp;m&nbsp;)&nbsp;(&nbsp;norm&nbsp;(&nbsp;invertor&nbsp;m&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>naive_solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;naive_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;inv&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;matrix_sparse_vector_sparse_prod&nbsp;mm&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;sparse_vector_to_column_matrix&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;column_extract&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)&nbsp;(&nbsp;left_quotient&nbsp;m&nbsp;p&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>full_solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;full_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;to_sparse&nbsp;(&nbsp;-1&nbsp;)&nbsp;1.&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;1&nbsp;)&nbsp;v&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x.(0)&nbsp;)&nbsp;(&nbsp;to_full&nbsp;(&nbsp;left_quotient&nbsp;m&nbsp;p&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tune_inv matrix inverse_candidate</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tune_inv&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:t)&nbsp;(y:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;two&nbsp;=&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;coeff_two&nbsp;()&nbsp;,&nbsp;<span class="constructor">S</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;dimensions&nbsp;x&nbsp;).(0)&nbsp;)&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;right_product&nbsp;=&nbsp;mult&nbsp;x&nbsp;y&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;difference&nbsp;=&nbsp;sub&nbsp;two&nbsp;right_product&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;mult&nbsp;y&nbsp;difference&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>approx_inv distance invertor matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;approx_inv&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;distance&nbsp;invertor&nbsp;(x:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;invertor&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=&nbsp;mult&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;identity&nbsp;=&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;,&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;dimensions&nbsp;x&nbsp;).(0)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;tune_inv&nbsp;x&nbsp;y&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;error0&nbsp;=&nbsp;distance&nbsp;(&nbsp;sub&nbsp;product&nbsp;identity&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;new_product&nbsp;=&nbsp;mult&nbsp;x&nbsp;result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;error1&nbsp;=&nbsp;distance&nbsp;(&nbsp;sub&nbsp;new_product&nbsp;identity&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;error1&nbsp;error0&nbsp;&gt;=0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;y&nbsp;,&nbsp;error0&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;result&nbsp;,&nbsp;error1&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>extrap_inv parameter matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;extrap_inv&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(parameter:<span class="constructor">Coeff</span>.t)&nbsp;(x:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;inv&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;yy&nbsp;=&nbsp;tune_inv&nbsp;x&nbsp;y&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;add&nbsp;yy&nbsp;(&nbsp;scal_mult&nbsp;parameter&nbsp;(&nbsp;sub&nbsp;yy&nbsp;y&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>approx_solve distance matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;approx_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;distance&nbsp;(m:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;approx_inv&nbsp;distance&nbsp;inv&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;matrix_sparse_vector_sparse_prod&nbsp;(&nbsp;fst&nbsp;mm&nbsp;)&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>approx_full_solve distance matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;approx_full_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;distance&nbsp;(m:t)&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;approx_inv&nbsp;distance&nbsp;inv&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;matrix_full_vector_sparse_prod&nbsp;(&nbsp;fst&nbsp;mm&nbsp;)&nbsp;v&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>iterate exponent matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;iterate&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(s:int)&nbsp;(x:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;ref&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;&gt;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;s&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;:=&nbsp;matrix_sparse_vector_sparse_prod&nbsp;x&nbsp;!y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;fst&nbsp;(&nbsp;approx_inv&nbsp;norm_inf&nbsp;inv&nbsp;x&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;(&nbsp;abs&nbsp;s&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;:=&nbsp;matrix_sparse_vector_sparse_prod&nbsp;xx&nbsp;!y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;!y&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>int_pow exponent matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;int_pow&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(s:int)&nbsp;(x:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;&gt;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;,&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;dimensions&nbsp;x&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;n&nbsp;=&nbsp;s&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;factor&nbsp;=&nbsp;int_pow&nbsp;n&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prod&nbsp;=&nbsp;mult&nbsp;factor&nbsp;factor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prod<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;prod&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;int_pow&nbsp;(&nbsp;abs&nbsp;s&nbsp;)&nbsp;(&nbsp;fst&nbsp;(&nbsp;approx_inv&nbsp;norm_inf&nbsp;inv&nbsp;x&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>find_first_pivot_downward tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;find_first_pivot_downward&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">S</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i0&nbsp;=&nbsp;i.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i1&nbsp;=&nbsp;i.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index0&nbsp;=&nbsp;!index.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index1&nbsp;=&nbsp;!index.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i0&nbsp;i1&nbsp;&gt;&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;index1&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i1&nbsp;index1&nbsp;&lt;&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i1&nbsp;index1&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i0&nbsp;index0&nbsp;&lt;&nbsp;0&nbsp;)&nbsp;)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">S</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;(&nbsp;!index&nbsp;,&nbsp;!coeff&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>find_first_pivot_upward tensor</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;find_first_pivot_upward&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(w:<span class="constructor">S</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i0&nbsp;=&nbsp;i.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;i1&nbsp;=&nbsp;i.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index0&nbsp;=&nbsp;!index.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index1&nbsp;=&nbsp;!index.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i0&nbsp;i1&nbsp;&lt;&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;index1&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i1&nbsp;index1&nbsp;&gt;&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;i1&nbsp;index1&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.compare&nbsp;i0&nbsp;index0&nbsp;&gt;&nbsp;0&nbsp;)&nbsp;)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">S</span>.iter&nbsp;f&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;(&nbsp;!index&nbsp;,&nbsp;!coeff&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_diff_to_id_pivot_downward matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;in_place_diff_to_id_pivot_downward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;error_string&nbsp;=&nbsp;<span class="string">"The&nbsp;first&nbsp;argument&nbsp;must&nbsp;be&nbsp;Diff_to_scal_matrix&nbsp;(&nbsp;Coeff.one&nbsp;,&nbsp;sparse_tensor&nbsp;)&nbsp;in&nbsp;Sparse_matrix.Field.diff_to_id_pivot_downward."</span><br>
&nbsp;<span class="keyword">and</span>&nbsp;error_message&nbsp;=&nbsp;<span class="string">"Non&nbsp;invertible&nbsp;left&nbsp;matrix&nbsp;in&nbsp;Sparse_matrix.Field.in_place_diff_to_id_pivot_downward"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_one&nbsp;x&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;pivot&nbsp;=&nbsp;ref&nbsp;(&nbsp;find_first_pivot_downward&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip&nbsp;=&nbsp;dimensions&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip1&nbsp;=&nbsp;dip.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;norm_coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dip.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;si&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.succ&nbsp;!i&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Index</span>.pred&nbsp;dim0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cc&nbsp;=&nbsp;<span class="constructor">Index</span>.pred&nbsp;dim1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;!i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!i&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;extract&nbsp;!i&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nx&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;nx&nbsp;!norm_coeff&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;nx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;j.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;f&nbsp;!i&nbsp;!si&nbsp;rr&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coeff&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!index&nbsp;!i&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!i&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;!i&nbsp;!substraction_row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_left&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_right&nbsp;:=&nbsp;row_extract&nbsp;!i&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_right&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_right&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_right&nbsp;!i&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">U</span>.raw_extract&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">U</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!substraction_row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;<span class="constructor">U</span>.sub&nbsp;!row_output_right&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!substraction_row_right&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_right&nbsp;j0&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;g&nbsp;!i&nbsp;!si&nbsp;rr&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pivot&nbsp;:=&nbsp;find_first_pivot_downward&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;si&nbsp;:=&nbsp;<span class="constructor">Index</span>.succ&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;j0&nbsp;j.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.add&nbsp;x&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coefficient&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.inv&nbsp;!coefficient&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;tensor_sub_row_extract&nbsp;j0&nbsp;(&nbsp;<span class="constructor">Index</span>.succ&nbsp;j0&nbsp;)&nbsp;cc&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_mult&nbsp;!coeff&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_row_replace&nbsp;!row_output_left&nbsp;j0&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_mult&nbsp;!coeff&nbsp;!row_output_right&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_right&nbsp;j0&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">S</span>.iter&nbsp;ff&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_string<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;error_string&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_pivot_downward matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_pivot_downward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;copy&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_downward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;[|&nbsp;mm&nbsp;;&nbsp;pp&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_invertibility matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_invertibility&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mm:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mm<br>
&nbsp;<span class="keyword">and</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;mm<br>
&nbsp;<span class="keyword">and</span>&nbsp;error_string&nbsp;=&nbsp;<span class="string">"The&nbsp;argument&nbsp;must&nbsp;be&nbsp;Diff_to_scal_matrix&nbsp;(&nbsp;Coeff.one&nbsp;,&nbsp;sparse_tensor&nbsp;)&nbsp;in&nbsp;Sparse_matrix.Field.diff_to_id_invertibility."</span><br>
&nbsp;<span class="keyword">and</span>&nbsp;error_message&nbsp;=&nbsp;<span class="string">"Not&nbsp;invertible."</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_one&nbsp;x&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;pivot&nbsp;=&nbsp;ref&nbsp;(&nbsp;find_first_pivot_downward&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;norm_coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;si&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.succ&nbsp;!i&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Index</span>.pred&nbsp;dim0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;!i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!i&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;extract&nbsp;!i&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nx&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;nx&nbsp;!norm_coeff&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;nx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;j.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;f&nbsp;!i&nbsp;!si&nbsp;rr&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coeff&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!index&nbsp;!i&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;!i&nbsp;!substraction_row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_left&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">U</span>.raw_extract&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">U</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!substraction_row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;g&nbsp;!i&nbsp;!si&nbsp;rr&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pivot&nbsp;:=&nbsp;find_first_pivot_downward&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;si&nbsp;:=&nbsp;<span class="constructor">Index</span>.succ&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;j0&nbsp;j.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.add&nbsp;x&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coefficient&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">S</span>.iter&nbsp;ff&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_string<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;error_string&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_det matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_det&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(mm:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;copy&nbsp;mm<br>
&nbsp;<span class="keyword">and</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;mm<br>
&nbsp;<span class="keyword">and</span>&nbsp;error_string&nbsp;=&nbsp;<span class="string">"The&nbsp;argument&nbsp;must&nbsp;be&nbsp;Diff_to_scal_matrix&nbsp;(&nbsp;Coeff.one&nbsp;,&nbsp;sparse_tensor&nbsp;)&nbsp;in&nbsp;Sparse_matrix.Field.diff_to_id_det."</span><br>
&nbsp;<span class="keyword">and</span>&nbsp;error_message&nbsp;=&nbsp;<span class="string">"Not&nbsp;invertible."</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_one&nbsp;x&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;result&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;pivot&nbsp;=&nbsp;ref&nbsp;(&nbsp;find_first_pivot_downward&nbsp;w&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;norm_coeff&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;si&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.succ&nbsp;!i&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;substraction_row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;<span class="constructor">Index</span>.pred&nbsp;dim0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;!i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!i&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;extract&nbsp;!i&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nx&nbsp;=&nbsp;<span class="constructor">Coeff</span>.norm&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.norm_compare&nbsp;nx&nbsp;!norm_coeff&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coeff&nbsp;:=&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;norm_coeff&nbsp;:=&nbsp;nx&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:=&nbsp;j.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;f&nbsp;!i&nbsp;!si&nbsp;rr&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coeff&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;!result&nbsp;!coeff&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!index&nbsp;!i&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_exchange&nbsp;!index&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;substraction_row_left&nbsp;:=&nbsp;<span class="constructor">U</span>.scal_left_div&nbsp;!coeff&nbsp;!row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.replace&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;!i&nbsp;!substraction_row_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!substraction_row_left&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">U</span>.raw_extract&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">U</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!substraction_row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;g&nbsp;!i&nbsp;!si&nbsp;rr&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pivot&nbsp;:=&nbsp;find_first_pivot_downward&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;si&nbsp;:=&nbsp;<span class="constructor">Index</span>.succ&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Index</span>.eq&nbsp;j0&nbsp;j.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.add&nbsp;x&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_zero&nbsp;!coefficient&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_message<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.mult&nbsp;!result&nbsp;!coefficient&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">S</span>.iter&nbsp;ff&nbsp;w<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;:=&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!result&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_string<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;error_string&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>in_place_diff_to_id_pivot_upward matrix1 matrix2</pre> The left matrix is supposed to be 
upper triangular with ones on the diagonal.
<p>

La matrice de gauche est supposée triangulaire supérieure avec des uns sur la diagonale. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;in_place_diff_to_id_pivot_upward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;dim&nbsp;=&nbsp;dimensions&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;error_string&nbsp;=&nbsp;<span class="string">"The&nbsp;first&nbsp;argument&nbsp;must&nbsp;be&nbsp;Diff_to_scal_matrix&nbsp;(&nbsp;Coeff.one&nbsp;,&nbsp;sparse_tensor&nbsp;)&nbsp;in&nbsp;Sparse_matrix.Field.diff_to_id_pivot_upward."</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;m&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;x&nbsp;,&nbsp;w&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Coeff</span>.eq_one&nbsp;x&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Coeff</span>.zero&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;pivot&nbsp;=&nbsp;ref&nbsp;(&nbsp;find_first_pivot_upward&nbsp;w&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;z&nbsp;=&nbsp;<span class="constructor">Index</span>.zero&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip&nbsp;=&nbsp;dimensions&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim0&nbsp;=&nbsp;dim.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dim1&nbsp;=&nbsp;dim.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip0&nbsp;=&nbsp;dip.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dip1&nbsp;=&nbsp;dip.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dim1&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;dim0&nbsp;dip0&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_left&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dim1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_output_right&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">U</span>.null&nbsp;dip1&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;pi&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Index</span>.pred&nbsp;!i&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;not&nbsp;(&nbsp;<span class="constructor">Index</span>.eq&nbsp;!i&nbsp;(&nbsp;<span class="constructor">Index</span>.witness&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_left&nbsp;:=&nbsp;row_extract&nbsp;!i&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_right&nbsp;:=&nbsp;row_extract&nbsp;!i&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(&nbsp;j&nbsp;,&nbsp;x&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;j0&nbsp;=&nbsp;j.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">U</span>.raw_extract&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_left&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_left&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!row_left&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">U</span>.remove&nbsp;!i&nbsp;!row_output_left&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_left&nbsp;j0&nbsp;m&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;row_extract&nbsp;j0&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_output_right&nbsp;:=&nbsp;<span class="constructor">V</span>.sub&nbsp;!row_output_right&nbsp;(&nbsp;<span class="constructor">V</span>.scal_mult&nbsp;!coefficient&nbsp;!row_right&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row_replace&nbsp;!row_output_right&nbsp;j0&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tensor_sub_column_iter&nbsp;g&nbsp;!i&nbsp;z&nbsp;!pi&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pivot&nbsp;:=&nbsp;find_first_pivot_downward&nbsp;w&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;:=&nbsp;(&nbsp;fst&nbsp;!pivot&nbsp;).(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pi&nbsp;:=&nbsp;<span class="constructor">Index</span>.pred&nbsp;!i&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;error_string<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;error_string&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_pivot_upward matrix1 matrix2</pre> The left matrix is supposed to be 
upper triangular with ones on the diagonal.
<p>

La matrice de gauche est supposée triangulaire supérieure avec des uns sur la diagonale. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_pivot_upward&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;copy&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_upward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;[|&nbsp;mm&nbsp;;&nbsp;pp&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_inv matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_inv&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;,&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;(&nbsp;dimensions&nbsp;m&nbsp;).(0)&nbsp;)&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_downward&nbsp;mm&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_upward&nbsp;mm&nbsp;p&nbsp;;<br>
&nbsp;&nbsp;p&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_left_quotient matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_left_quotient&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;copy&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;copy&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_downward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_upward&nbsp;mm&nbsp;pp&nbsp;;<br>
&nbsp;&nbsp;pp&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_right_quotient matrix1 matrix2</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_right_quotient&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(p:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;transpose&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;pp&nbsp;=&nbsp;transpose&nbsp;p&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_downward&nbsp;pp&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;in_place_diff_to_id_pivot_upward&nbsp;pp&nbsp;mm&nbsp;;<br>
&nbsp;&nbsp;transpose&nbsp;mm&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;sparse_vector_to_column_matrix&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;column_extract&nbsp;(&nbsp;<span class="constructor">Index</span>.zero&nbsp;()&nbsp;)&nbsp;(&nbsp;diff_to_id_left_quotient&nbsp;m&nbsp;p&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_full_solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_full_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;to_sparse&nbsp;(&nbsp;-1&nbsp;)&nbsp;1.&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;1&nbsp;)&nbsp;v&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x.(0)&nbsp;)&nbsp;(&nbsp;to_full&nbsp;(&nbsp;diff_to_id_left_quotient&nbsp;m&nbsp;p&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_tune_inv matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_tune_inv&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(m:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;tune_inv&nbsp;m&nbsp;(&nbsp;diff_to_id_inv&nbsp;m&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_tune_solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_tune_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;tune_inv&nbsp;m&nbsp;(&nbsp;diff_to_id_inv&nbsp;m&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;matrix_sparse_vector_sparse_prod&nbsp;mm&nbsp;v&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_tune_full_solve matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_tune_full_solve&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(m:t)&nbsp;(v:coeff&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mm&nbsp;=&nbsp;diff_to_id_tune_inv&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;matrix_full_vector_sparse_prod&nbsp;mm&nbsp;v&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_iterate exponent matrix vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;diff_to_id_iterate&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(s:int)&nbsp;(x:t)&nbsp;(v:<span class="constructor">U</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;ref&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;&gt;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;s&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;:=&nbsp;matrix_sparse_vector_sparse_prod&nbsp;x&nbsp;!y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xx&nbsp;=&nbsp;diff_to_id_tune_inv&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;(&nbsp;abs&nbsp;s&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;:=&nbsp;matrix_sparse_vector_sparse_prod&nbsp;xx&nbsp;!y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;!y&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>diff_to_id_int_pow exponent matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;diff_to_id_int_pow&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(s:int)&nbsp;(x:t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;&gt;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Diff_to_scal_matrix</span>&nbsp;(&nbsp;<span class="constructor">Coeff</span>.one&nbsp;()&nbsp;,&nbsp;<span class="constructor">T</span>.null&nbsp;(&nbsp;dimensions&nbsp;x&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;n&nbsp;=&nbsp;s&nbsp;/&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;factor&nbsp;=&nbsp;int_pow&nbsp;n&nbsp;x&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prod&nbsp;=&nbsp;mult&nbsp;factor&nbsp;factor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prod<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mult&nbsp;prod&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;int_pow&nbsp;(&nbsp;abs&nbsp;s&nbsp;)&nbsp;(&nbsp;diff_to_id_tune_inv&nbsp;x&nbsp;)&nbsp;;;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ § § </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
<br>
<br>
<span class="keyword">end</span>&nbsp;;;<br>
<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ § § </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
<br>
<span class="keyword">end</span></code></body></html>