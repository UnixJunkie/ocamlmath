<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Graphicmath" rel="Chapter" href="Graphicmath.html"><title>Graphicmath.Analogic</title>
</head>
<body>
<code class="code"><span class="keyword">struct</span><br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="1_Introduction"><h1>Introduction</h1></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
The mathematician will find in this module: 
<p>
<ul>
<li>function to digitize oscillograms and photographic pictures of graphic recorders,</li>
</ul>
<ul>
<li>utilities for the intermediate steps of picture treatment or digitization.</li>
</ul>

Going with it, a script <a href="../analogic/compile.sh"> compile.sh</a> compiles
<a href="../analogic/ferdinand.ml"> ferdinand.ml</a>, yielding a native executable <code class="code">ferdinand</code> for digitizing oscillograms;
a script <a href="../analogic/bytecode.sh"> bytecode.sh</a> compiles
<a href="../analogic/ferdinand-bytecode.ml"> ferdinand-bytecode.ml</a>, 
yielding a bytecode executable <code class="code">ferdinand.o</code> for digitizing oscillograms.
<p>

<span id="2_Conventions"><h2>Conventions</h2></span>
<p>

In digitizing a curve from its picture, the picture has to be cropped in order that only the pixels containing either the screen background or the curve are treated.
The horizontal cropping will preferably match the horizontal extension of the curve, without exceeding it.
<p>

The treatment of an oscillogram uses the luminosity of the picture.
The median value of the luminosity is roughly evaluated as the median of the medians of the luminosities of the lines.
<p>

The signal is supposed to be in the values of luminosity greater than the product of the threshold with the median.
The graticule is supposed to be in the lower values, up to full black.
<p>

For the pictures of oscilloscopes with graticule lit up by incandescence light or for pictures of graphic recorders 
(for which the variety of colors is unpredictable),
it is necessary to treat the colors in order to be reduced to the preceding conventions for oscillograms.
The <code class="code">phosphor</code> switch permits to choose between the functions <code class="code">oscillo</code> and <code class="code">recorder</code>.
<p>

The mathematician must supply the value of the threshold to separate the traces from the rest of the picture.
The detection of the number of traces is automatically done a priori (with a convenient threshold value),
but it is possible to stretch the work on a unique trace by assigning the value <code class="code"><span class="keyword">true</span></code> to the argument <code class="code">monotrace</code>.
<p>

The algorithm does not accept the trace crossing.
<p>

As the luminosity of the trace is higher inside the bends than outside, 
the position of the curve is evaluated recursively by taking into account the curvature radius from the preceding step,
until the variation from a step to another is low enough.
<p>

If the digitization gives strange results, try again changing the threshold value or the cropping.
If for a multitrace picture the number of traces remains inadequate, crop again the traces one-by-one and stretch the monotrace mode.
<p>

<span id="2_Comments"><h2>Comments</h2></span>
<p>

Here follow the maximal quantities of information contained inside a picture :
<p>
<OL>
<li>of size 1333 * 2000 with 8 bits per color : 2000 samples of 20 bits or one measurement of 31 bits,</li>
<li>of size 3000 * 4000 with 12 bits per color : 4000 samples of 25 bits or one measurement of 37 bits,</li>
<li>of size 8000 * 12000 with 16 bits per color : 12000 samples of 30,5 bits or one measurement of 44 bits.</li>
</OL>

The digitization of an oscillogram receives interference from different phenomenons, the main one being the presence of the graticule.
<p>

The noise plays a part in the measurement with the probe, the input attenuator, the amplifying chain, 
the cathode ray tube and the unevenness of the phosphore layer.
<p>

The noise plays a part in the view capture with the optical irregularities, the thermal noise,
the Bayer outmatrixing, the lossy compression.
<p>

A screen without graticule will give more pure results.
<p>

For monochromatic photographic archives of oscillograms in presence of lit up graticule or of graphic records with graticule,
it is necessary to touch up the picture once digitized by erasing the graticule before applying the present treatment.
<p>

The graphical interfaces are greedy in resources; 
a generous use of <code class="code"><span class="constructor">Gc</span>.compact ()</code> is realized by calling it at each window update.
<p>

This module is distributed under the same licence as Ocaml.
<p>

<center>§ </center>
<p>

La mathématicienne ou le mathématicien trouvera dans ce module :
<p>
<ul>
<li>des fonctions pour numériser des oscillogrammes ou des images photographiques de tables traçantes,</li>
</ul>
<ul>
<li>des utilitaires pour les étapes intermédiaires dans le traitement ou la numérisation des images.</li>
</ul>

L'accompagnant, un script <a href="../analogic/compile.sh"> compile.sh</a> compile
<a href="../analogic/ferdinand.ml"> ferdinand.ml</a>, produisant un exécutable natif <code class="code">ferdinand</code> de numérisation d'oscillogrammes ;
un script <a href="../analogic/bytecode.sh"> bytecode.sh</a> compile
<a href="../analogic/ferdinand-bytecode.ml"> ferdinand-bytecode.ml</a>, 
produisant un exécutable virtuel <code class="code">ferdinand.o</code> de numérisation d'oscillogrammes.
<p>

<span id="2_Conventions"><h2>Conventions</h2></span>
<p>

Dans la numérisation d'une courbe par son image, l'image doit d'abord être recadrée de façon que ne soient traités que des pixels qui contiennent
soit le fond d'écran soit la courbe. Le cadrage horizontal collera de préférence à l'extension horizontale de la courbe, sans la dépasser.
<p>

Le traitement d'un oscillogramme utilise la luminosité de l'image.
La valeur médiane de luminosité est évaluée grossièrement comme la médiane des médianes des luminosités de chaque ligne.
<p>

Le signal est censé être dans les valeurs de luminosité supérieures au produit du seuil par la médiane.
Le réticule est censé être dans les valeurs inférieures de luminosité, jusqu'au noir complet.
<p>

Pour les images d'oscilloscope avec réticule éclairé par des lampes à incandescence ou pour les images de tables traçantes 
(pour lesquelles la variété des couleurs est imprévisible),
il est nécessaire de traiter les couleurs pour se ramener aux conventions précédentes pour l'oscillogramme.
Le commutateur <code class="code">phosphor</code> permet de choisir entre les fonctions <code class="code">oscillo</code> et <code class="code">recorder</code>.
<p>

La mathématicienne ou le mathématicien doit fournir la valeur de seuil pour séparer les traces du reste de l'image.
La détection du nombre de traces se fait a priori automatiquement (avec une valeur de seuil convenable), 
mais il est possible de forcer le travail sur une trace unique en attribuant la valeur <code class="code"><span class="keyword">true</span></code> à l'argument <code class="code">monotrace</code>.
<p>

L'algorithme n'accepte pas le croisement des traces.
<p>

Comme la luminosité de la trace est plus élevée à l'intérieur des virages qu'à l'extérieur, 
la position de la courbe est évaluée récursivement en tenant compte du rayon de courbure à l'étape précédente,
jusqu'à ce que la variation d'une étape à l'autre soit assez faible.
<p>

Si la numérisation donne des résultats bizarres, recommencer en changeant la valeur de seuil ou le recadrage.
Si pour une image multitrace le nombre de traces détectées reste inadéquat, recadrer trace par trace et forcer le mode monotrace.
<p>

<span id="2_Commentaires"><h2>Commentaires</h2></span>
<p>

Suivent les quantités maximales d'information contenues dans une image :
<p>
<OL>
<li>de taille 1333 * 2000 à 8 bits par couleur : 2000 échantillons de 20 bits ou une mesure de 31 bits,</li>
<li>de taille 3000 * 4000 à 12 bits par couleur : 4000 échantillons de 25 bits ou une mesure de 37 bits,</li>
<li>de taille 8000 * 12000 à 16 bits par couleur : 12000 échantillons de 30,5 bits ou une mesure de 44 bits.</li>
</OL>

La numérisation d'un oscillogramme est parasitée par différents phénomènes, le principal étant la présence du réticule.
<p>

Le bruit de souffle intervient dans la mesure avec la sonde, l'atténuateur d'entrée, la chaîne d'amplification, 
le tube cathodique et l'irrégularité de la couche de phosphore.
<p>

Le bruit de souffle intervient dans la prise de vue avec les irrégularités optiques, le bruit thermique, 
le dématriçage de Bayer, la compression avec perte.
<p>

Un écran sans réticule donnera des résultats plus purs.
<p>

Pour des archives photographiques monochromes d'oscillogrammes avec présence du réticule éclairé ou de table traçante avec réticule,, 
il est nécessaire de retoucher l'image une fois numérisée en effaçant le réticule avant d'appliquer le présent traitement.
<p>

Les interfaces graphiques sont gourmandes en ressouces ; 
une utilisation généreuse de <code class="code"><span class="constructor">Gc</span>.compact ()</code> est effectuée par son appel à chaque rafraîchissement de fenêtre.
<p>

Ce module est distribué selon la même licence qu'Ocaml.
<p>

<center>Copyright Stéphane Grognet </center>
<center>Laboratoire de mathématiques Jean Leray UMR 6629 CNRS </center>
<center>Fédération de recherche mathématique des Pays de la Loire </center>
<center>IREM des Pays de la Loire - Université de Nantes </center>
<center>version 0.3</center>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(**
@version 0.3
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(**
@author Stéphane Grognet
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(**
@since 2012, 2013
*)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="1_Utilitaires"><h1>Utilitaires</h1></span>
<span id="1_Utilities"><h1>Utilities</h1></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Util</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Matrix</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Readwrite</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Infinitesimal</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Draw</span>&nbsp;;;<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Widget</span>&nbsp;;;<br>
<br>
<br>
<span class="constructor">Graphics</span>.open_graph&nbsp;<span class="string">"&nbsp;"</span>&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>max_color</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;max_color&nbsp;=&nbsp;<span class="constructor">Graphics</span>.red&nbsp;+&nbsp;<span class="constructor">Graphics</span>.green&nbsp;+&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>red_for_color real</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;red_for_color&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:float)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;min&nbsp;<span class="constructor">Graphics</span>.red&nbsp;(&nbsp;65536&nbsp;*&nbsp;(&nbsp;<span class="constructor">Util</span>.round&nbsp;x&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>green_for_color real</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;green_for_color&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:float)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;min&nbsp;<span class="constructor">Graphics</span>.green&nbsp;(&nbsp;256&nbsp;*&nbsp;(&nbsp;<span class="constructor">Util</span>.round&nbsp;x&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>blue_for_color real</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;blue_for_color&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:float)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;min&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;(&nbsp;<span class="constructor">Util</span>.round&nbsp;x&nbsp;)&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>display_float_unicolor h_offset v_offset matrix</pre> The function Graphics.draw_image is too unstable to be useful.
<p>

La fonction Graphics.draw_image est trop instable pour être utilisable. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;display_float_unicolor&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(h_offset:int)&nbsp;(v_offset:int)&nbsp;(m:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m<br>
&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;pred&nbsp;width<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;pred&nbsp;height&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;abscissa&nbsp;=&nbsp;ref&nbsp;h_offset<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ordinate&nbsp;=&nbsp;ref&nbsp;(&nbsp;v_offset&nbsp;+&nbsp;hh&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;hh&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row&nbsp;=&nbsp;m.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;ww&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;color&nbsp;=&nbsp;65793&nbsp;*&nbsp;(&nbsp;int_of_float&nbsp;row.(j)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;color&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.plot&nbsp;!abscissa&nbsp;!ordinate&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abscissa&nbsp;:=&nbsp;succ&nbsp;!abscissa&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ordinate&nbsp;:=&nbsp;pred&nbsp;!ordinate&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abscissa&nbsp;:=&nbsp;h_offset<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>display_float_rgb h_offset v_offset rgb_matrix</pre> The function Graphics.draw_image is too unstable to be useful.
<p>

La fonction Graphics.draw_image est trop instable pour être utilisable. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;display_float_rgb&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(h_offset:int)&nbsp;(v_offset:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;m.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;m.(2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;pred&nbsp;width<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;pred&nbsp;height&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;abscissa&nbsp;=&nbsp;ref&nbsp;h_offset<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ordinate&nbsp;=&nbsp;ref&nbsp;(&nbsp;v_offset&nbsp;+&nbsp;hh&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;hh&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_red&nbsp;=&nbsp;red.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_green&nbsp;=&nbsp;green.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_blue&nbsp;=&nbsp;blue.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;ww&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;color&nbsp;=&nbsp;(&nbsp;red_for_color&nbsp;row_red.(j)&nbsp;)&nbsp;+&nbsp;(&nbsp;green_for_color&nbsp;row_green.(j)&nbsp;)&nbsp;+&nbsp;(&nbsp;blue_for_color&nbsp;row_blue.(j)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;color&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.plot&nbsp;!abscissa&nbsp;!ordinate&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abscissa&nbsp;:=&nbsp;succ&nbsp;!abscissa&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ordinate&nbsp;:=&nbsp;pred&nbsp;!ordinate&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abscissa&nbsp;:=&nbsp;h_offset<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>relative_draw_line_float_rgb x_offset y_offset rgb_matrix row</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;relative_draw_line_float_rgb&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x_offset:int)&nbsp;(y_offset:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(row:int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;m.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;m.(2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;guarded_row&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;min&nbsp;row&nbsp;(&nbsp;pred&nbsp;height&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;x&nbsp;=&nbsp;ref&nbsp;x_offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_red&nbsp;=&nbsp;red.(guarded_row)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_green&nbsp;=&nbsp;green.(guarded_row)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_blue&nbsp;=&nbsp;blue.(guarded_row)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;y&nbsp;=&nbsp;y_offset&nbsp;+&nbsp;height&nbsp;-&nbsp;guarded_row&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;width&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;(&nbsp;(&nbsp;red_for_color&nbsp;row_red.(j)&nbsp;)&nbsp;+&nbsp;(&nbsp;green_for_color&nbsp;row_green.(j)&nbsp;)&nbsp;+&nbsp;(&nbsp;blue_for_color&nbsp;row_blue.(j)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.plot&nbsp;!x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;:=&nbsp;succ&nbsp;!x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>relative_draw_line_magnify_float_rgb factor x_offset y_offset rgb_matrix row</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;relative_draw_line_magnify_float_rgb&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(factor:int)&nbsp;(x_offset:int)&nbsp;(y_offset:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(row:int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;m.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;m.(2)<br>
&nbsp;<span class="keyword">and</span>&nbsp;ff&nbsp;=&nbsp;pred&nbsp;factor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;guarded_row&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;min&nbsp;row&nbsp;(&nbsp;pred&nbsp;height&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;x&nbsp;=&nbsp;ref&nbsp;(&nbsp;x_offset&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_red&nbsp;=&nbsp;red.(guarded_row)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_green&nbsp;=&nbsp;green.(guarded_row)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_blue&nbsp;=&nbsp;blue.(guarded_row)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;y&nbsp;=&nbsp;y_offset&nbsp;+&nbsp;factor&nbsp;*&nbsp;(&nbsp;height&nbsp;-&nbsp;guarded_row&nbsp;-&nbsp;1&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;width&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;(&nbsp;(&nbsp;red_for_color&nbsp;row_red.(j)&nbsp;)&nbsp;+&nbsp;(&nbsp;green_for_color&nbsp;row_green.(j)&nbsp;)&nbsp;+&nbsp;(&nbsp;blue_for_color&nbsp;row_blue.(j)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;h&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;ff&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;k&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;ff&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.plot&nbsp;(&nbsp;!x&nbsp;+&nbsp;h&nbsp;)&nbsp;(&nbsp;y&nbsp;+&nbsp;k&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;:=&nbsp;!x&nbsp;+&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>relative_draw_column_float_rgb x_offset y_offset rgb_matrix row</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;relative_draw_column_float_rgb&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x_offset:int)&nbsp;(y_offset:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(column:int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;m.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;m.(2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;guarded_column&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;min&nbsp;column&nbsp;(&nbsp;pred&nbsp;width&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;y&nbsp;=&nbsp;ref&nbsp;(&nbsp;y_offset&nbsp;+&nbsp;height&nbsp;-&nbsp;1&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;x_offset&nbsp;+&nbsp;guarded_column&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;height&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_red&nbsp;=&nbsp;red.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_green&nbsp;=&nbsp;green.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_blue&nbsp;=&nbsp;blue.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;(&nbsp;(&nbsp;red_for_color&nbsp;row_red.(guarded_column)&nbsp;)&nbsp;+&nbsp;(&nbsp;green_for_color&nbsp;row_green.(guarded_column)&nbsp;)&nbsp;+&nbsp;(&nbsp;blue_for_color&nbsp;row_blue.(guarded_column)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.plot&nbsp;x&nbsp;!y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;:=&nbsp;pred&nbsp;!y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>relative_draw_column_magnify_float_rgb factor x_offset y_offset rgb_matrix row</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;relative_draw_column_magnify_float_rgb&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(factor:int)&nbsp;(x_offset:int)&nbsp;(y_offset:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(column:int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;m.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;m.(2)<br>
&nbsp;<span class="keyword">and</span>&nbsp;ff&nbsp;=&nbsp;pred&nbsp;factor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;guarded_column&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;min&nbsp;column&nbsp;(&nbsp;pred&nbsp;width&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;y&nbsp;=&nbsp;ref&nbsp;(&nbsp;y_offset&nbsp;+&nbsp;factor&nbsp;*&nbsp;(&nbsp;height&nbsp;-&nbsp;1&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;x_offset&nbsp;+&nbsp;factor&nbsp;*&nbsp;guarded_column&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;height&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;row_red&nbsp;=&nbsp;red.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_green&nbsp;=&nbsp;green.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row_blue&nbsp;=&nbsp;blue.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;h&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;ff&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;k&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;ff&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;(&nbsp;(&nbsp;red_for_color&nbsp;row_red.(guarded_column)&nbsp;)&nbsp;+&nbsp;(&nbsp;green_for_color&nbsp;row_green.(guarded_column)&nbsp;)&nbsp;+&nbsp;(&nbsp;blue_for_color&nbsp;row_blue.(guarded_column)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.plot&nbsp;(&nbsp;x&nbsp;+&nbsp;h&nbsp;)&nbsp;(&nbsp;!y&nbsp;+&nbsp;k&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y&nbsp;:=&nbsp;!y&nbsp;-&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>cross_float_rgb float_color row column rgb_matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;cross_float_rgb&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(color:float&nbsp;array)&nbsp;(row:int)&nbsp;(column:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_copy&nbsp;m.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_copy&nbsp;m.(1)<br>
&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_copy&nbsp;m.(2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;red.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;guarded_row&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;min&nbsp;row&nbsp;(&nbsp;pred&nbsp;height&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;guarded_column&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;min&nbsp;column&nbsp;(&nbsp;pred&nbsp;width&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;red.(guarded_row)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.make&nbsp;width&nbsp;color.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;green.(guarded_row)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.make&nbsp;width&nbsp;color.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;blue.(guarded_row)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.make&nbsp;width&nbsp;color.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;height&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;red.(i).(guarded_column)&nbsp;&lt;-&nbsp;color.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;green.(i).(guarded_column)&nbsp;&lt;-&nbsp;color.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blue.(i).(guarded_column)&nbsp;&lt;-&nbsp;color.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;red&nbsp;;&nbsp;green&nbsp;;&nbsp;blue&nbsp;|]&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="1_Botesdedialogues"><h1>Boîtes de dialogues</h1></span>
<span id="1_Dialogboxes"><h1>Dialog boxes</h1></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>float_rgb_crop_image approx_hori_size approx_verti_size rgb_matrix reduced_matrix crop_values</pre> The integer vector <code class="code">crop_values</code> is modified in place.
<p>

Le vecteur entier <code class="code">crop_values</code> est modifié en place.  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;float_rgb_crop_image&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(approx_hori_size:int)&nbsp;(approx_verti_size:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(reduc:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(crop_values:int&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;crop_values&nbsp;&gt;=&nbsp;6&nbsp;)&nbsp;;<br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0).(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_pic&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_pic&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;reduc.(0).(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;obsolete&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;4&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_left&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_right&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_top&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_bottom&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;first_time&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;steps&nbsp;=&nbsp;8&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;crop_values.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(2)&nbsp;&lt;-&nbsp;crop_values.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(3)&nbsp;&lt;-&nbsp;crop_values.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hh&nbsp;=&nbsp;height&nbsp;-&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ww&nbsp;=&nbsp;width&nbsp;-&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_range&nbsp;=&nbsp;[|&nbsp;0&nbsp;;&nbsp;pred&nbsp;width&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_range&nbsp;=&nbsp;[|&nbsp;0&nbsp;;&nbsp;pred&nbsp;height&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;small_radius&nbsp;=&nbsp;max&nbsp;10&nbsp;(&nbsp;approx_verti_size&nbsp;/&nbsp;50&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;factor&nbsp;=&nbsp;height&nbsp;/&nbsp;h_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;h_pic&nbsp;)&nbsp;/&nbsp;100<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;w_pic&nbsp;)&nbsp;/&nbsp;100&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;w_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;h_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_mid&nbsp;=&nbsp;(&nbsp;5&nbsp;*&nbsp;w_border&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_mid&nbsp;=&nbsp;(&nbsp;5&nbsp;*&nbsp;h_border&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_size&nbsp;=&nbsp;2&nbsp;*&nbsp;w_border&nbsp;+&nbsp;w_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_size&nbsp;=&nbsp;2&nbsp;*&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ls0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ls1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ls2&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ls3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs2&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vl&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vr&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ser&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cs2&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cs3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;hs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;hs2&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;hs3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vt&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;set&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;seb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;left_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;crop_values.(0)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;left_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;right_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;crop_values.(1)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;right_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;top_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;crop_values.(2)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;top_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bottom_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;crop_values.(3)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;bottom_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_left&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_right&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_top&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_bottom&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cancel_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Annuler"</span>&nbsp;;&nbsp;<span class="string">"Cancel"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ok_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;OK&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Rafraîchir"</span>&nbsp;;&nbsp;<span class="string">"Refresh"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab_message&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ok&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cancel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.float_rgb_crop_image"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_initial&nbsp;:=&nbsp;string_of_int&nbsp;crop_values.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_initial&nbsp;:=&nbsp;string_of_int&nbsp;crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_initial&nbsp;:=&nbsp;string_of_int&nbsp;crop_values.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_initial&nbsp;:=&nbsp;string_of_int&nbsp;crop_values.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.background&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.fill_rect&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.foreground&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;!grab_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;ok_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cancel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;cancel_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab&nbsp;:=<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"Saisir"</span>&nbsp;;&nbsp;<span class="string">"Grab"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;w_border&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_mid&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls2&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_mid&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;w_border&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;hori_mid&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;w_border&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs2&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;w_border&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;hori_mid&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_range&nbsp;crop_values.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_range&nbsp;crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;+&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;w_border&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!left_initial&nbsp;!left_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_left&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;+&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ser&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;(&nbsp;7&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;w_border&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!right_initial&nbsp;!right_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_right&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;(&nbsp;7&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;hori_shift&nbsp;h_border&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;h_border&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs2&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_mid&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_mid&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;hori_shift&nbsp;verti_mid&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_mid&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs2&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;(&nbsp;h_border&nbsp;+&nbsp;(&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_range&nbsp;crop_values.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;h_border&nbsp;+&nbsp;(&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_range&nbsp;crop_values.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!top_initial&nbsp;!top_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_top&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;&nbsp;h_border&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_bottom&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;&nbsp;h_border&nbsp;+&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_left&nbsp;:=&nbsp;w_border&nbsp;+&nbsp;crop_values.(0)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_right&nbsp;:=&nbsp;w_border&nbsp;+&nbsp;crop_values.(1)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_top&nbsp;:=&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;crop_values.(2)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_bottom&nbsp;:=&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;crop_values.(3)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;<span class="constructor">Graphics</span>.red&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_segments&nbsp;[|&nbsp;(&nbsp;!trace_left&nbsp;,&nbsp;h_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_left&nbsp;,&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;w_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_top&nbsp;,&nbsp;w_border&nbsp;+&nbsp;w_pic&nbsp;-&nbsp;2&nbsp;,&nbsp;!trace_top&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_segments&nbsp;[|&nbsp;(&nbsp;!trace_right&nbsp;,&nbsp;h_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_right&nbsp;,&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;w_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_bottom&nbsp;,&nbsp;w_border&nbsp;+&nbsp;w_pic&nbsp;-&nbsp;2&nbsp;,&nbsp;!trace_bottom&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_time&nbsp;:=&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_int_vernier&nbsp;!vl&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;right_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_int_vernier&nbsp;!vr&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;top_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_int_vernier&nbsp;!vt&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bottom_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_int_vernier&nbsp;!vb&nbsp;x&nbsp;y&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!cancel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(0)&nbsp;&lt;-&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(1)&nbsp;&lt;-&nbsp;succ&nbsp;width&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(2)&nbsp;&lt;-&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(3)&nbsp;&lt;-&nbsp;succ&nbsp;height&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(4)&nbsp;&lt;-&nbsp;width&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(5)&nbsp;&lt;-&nbsp;height&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ok&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!grab&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;&nbsp;d.<span class="constructor">Unix</span>.tm_min)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;<span class="string">"Analogic.float_rgb_crop_image-"</span>&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".ppm"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab_message&nbsp;:=&nbsp;<span class="string">"&nbsp;Last&nbsp;grab&nbsp;:&nbsp;"</span>&nbsp;^&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls0&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls3&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;crop_values.(0)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(0)&nbsp;&lt;-&nbsp;max&nbsp;0&nbsp;(&nbsp;pred&nbsp;crop_values.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls1&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls2&nbsp;x&nbsp;y)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;crop_values.(1)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(1)&nbsp;&lt;-&nbsp;max&nbsp;0&nbsp;(&nbsp;pred&nbsp;crop_values.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs0&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs3&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;crop_values.(0)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(0)&nbsp;&lt;-&nbsp;succ&nbsp;(&nbsp;min&nbsp;ww&nbsp;crop_values.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs1&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs2&nbsp;x&nbsp;y)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;crop_values.(1)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(1)&nbsp;&lt;-&nbsp;succ&nbsp;(&nbsp;min&nbsp;ww&nbsp;crop_values.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs3&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs2&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(2)&nbsp;&lt;-&nbsp;crop_values.(2)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(2)&nbsp;&lt;-&nbsp;max&nbsp;0&nbsp;(&nbsp;pred&nbsp;crop_values.(2)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs0&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs1&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(3)&nbsp;&lt;-&nbsp;crop_values.(3)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(3)&nbsp;&lt;-&nbsp;max&nbsp;0&nbsp;(&nbsp;pred&nbsp;crop_values.(3)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs3&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs2&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(2)&nbsp;&lt;-&nbsp;crop_values.(2)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(2)&nbsp;&lt;-&nbsp;succ&nbsp;(&nbsp;min&nbsp;hh&nbsp;crop_values.(2)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs0&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs1&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(3)&nbsp;&lt;-&nbsp;crop_values.(3)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(3)&nbsp;&lt;-&nbsp;succ&nbsp;(&nbsp;min&nbsp;hh&nbsp;crop_values.(3)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_left&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_right&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_top&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_bottom&nbsp;x&nbsp;y&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;left_choice&nbsp;!=&nbsp;crop_values.(0)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;crop_values.(0)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(0)&nbsp;&lt;-&nbsp;left_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;hori_range&nbsp;crop_values.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;right_choice&nbsp;!=&nbsp;crop_values.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;crop_values.(1)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(1)&nbsp;&lt;-&nbsp;right_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;hori_range&nbsp;crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;top_choice&nbsp;!=&nbsp;crop_values.(2)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(2)&nbsp;&lt;-&nbsp;crop_values.(2)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(2)&nbsp;&lt;-&nbsp;top_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;h_border&nbsp;+&nbsp;(&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;verti_range&nbsp;crop_values.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;bottom_choice&nbsp;!=&nbsp;crop_values.(3)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(3)&nbsp;&lt;-&nbsp;crop_values.(3)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(3)&nbsp;&lt;-&nbsp;bottom_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;(&nbsp;h_border&nbsp;+&nbsp;(&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;verti_range&nbsp;crop_values.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!sel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_left&nbsp;=&nbsp;crop_values.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;obsolete.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!left_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!left_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!left_initial&nbsp;!left_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;crop_values.(0)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(0)&nbsp;&lt;-&nbsp;int_of_string&nbsp;(&nbsp;!left_initial&nbsp;^&nbsp;!left_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;old_obs&nbsp;;&nbsp;crop_values.(0)&nbsp;&lt;-&nbsp;old_left&nbsp;;&nbsp;left_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;left_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;crop_values.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!sel.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!sel.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!sel.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!left_initial&nbsp;!left_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!ser&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_right&nbsp;=&nbsp;crop_values.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;obsolete.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!right_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!right_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!right_initial&nbsp;!right_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;crop_values.(1)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(1)&nbsp;&lt;-&nbsp;int_of_string&nbsp;(&nbsp;!right_initial&nbsp;^&nbsp;!right_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;old_obs&nbsp;;&nbsp;crop_values.(1)&nbsp;&lt;-&nbsp;old_right&nbsp;;&nbsp;right_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;right_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ser&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!ser.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!ser.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!ser.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!right_initial&nbsp;!right_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!set&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_top&nbsp;=&nbsp;crop_values.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;obsolete.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!top_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!top_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!top_initial&nbsp;!top_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(2)&nbsp;&lt;-&nbsp;crop_values.(2)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(2)&nbsp;&lt;-&nbsp;int_of_string&nbsp;(&nbsp;!top_initial&nbsp;^&nbsp;!top_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete.(2)&nbsp;&lt;-&nbsp;old_obs&nbsp;;&nbsp;crop_values.(2)&nbsp;&lt;-&nbsp;old_top&nbsp;;&nbsp;top_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;top_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;crop_values.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!set.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!set.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!set.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!top_initial&nbsp;!top_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!seb&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_bottom&nbsp;=&nbsp;crop_values.(3)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;obsolete.(3)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!bottom_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!bottom_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(3)&nbsp;&lt;-&nbsp;crop_values.(3)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values.(3)&nbsp;&lt;-&nbsp;int_of_string&nbsp;(&nbsp;!bottom_initial&nbsp;^&nbsp;!bottom_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete.(3)&nbsp;&lt;-&nbsp;old_obs&nbsp;;&nbsp;crop_values.(3)&nbsp;&lt;-&nbsp;old_bottom&nbsp;;&nbsp;bottom_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;bottom_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;crop_values.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!seb.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seb.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seb.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;crop_values&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>float_rgb_color_treatment approx_hori_size approx_verti_size reduced_rgb_matrix coefficients</pre> The integer vector <code class="code">coefficients</code> is modified in place.
<p>

Le vecteur entier <code class="code">coefficients</code> est modifié en place.  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;float_rgb_color_treatment&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(approx_hori_size:int)&nbsp;(approx_verti_size:int)&nbsp;(reduc:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(coefficients:int&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;coefficients&nbsp;&gt;=&nbsp;3&nbsp;)&nbsp;;<br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;red&nbsp;=&nbsp;ref&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;green&nbsp;=&nbsp;ref&nbsp;reduc.(1)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;blue&nbsp;=&nbsp;ref&nbsp;reduc.(2)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rouge&nbsp;=&nbsp;ref&nbsp;coefficients.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vert&nbsp;=&nbsp;ref&nbsp;coefficients.(1)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bleu&nbsp;=&nbsp;ref&nbsp;coefficients.(2)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_pic&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_pic&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;reduc.(0).(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;triplet&nbsp;=&nbsp;[|&nbsp;<span class="string">"-1"</span>&nbsp;;&nbsp;<span class="string">"0"</span>&nbsp;;&nbsp;<span class="string">"1"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;first_time&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;h_pic&nbsp;)&nbsp;/&nbsp;100<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;w_pic&nbsp;)&nbsp;/&nbsp;100&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;w_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;h_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_size&nbsp;=&nbsp;2&nbsp;*&nbsp;w_border&nbsp;+&nbsp;w_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_size&nbsp;=&nbsp;2&nbsp;*&nbsp;h_border&nbsp;+&nbsp;h_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;sr&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sg&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cancel_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Annuler"</span>&nbsp;;&nbsp;<span class="string">"Cancel"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ok_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;OK&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;grab_message&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ok&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cancel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;max_radius&nbsp;=&nbsp;(&nbsp;min&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;/&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;small_radius&nbsp;=&nbsp;max&nbsp;10&nbsp;(&nbsp;verti_size&nbsp;/&nbsp;50&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.color_treatment"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;hori_shift&nbsp;(&nbsp;6&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"blue"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;hori_shift&nbsp;(&nbsp;4&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"green"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;hori_shift&nbsp;(&nbsp;2&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"red"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.background&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.fill_rect&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.foreground&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;!grab_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;ok_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cancel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;cancel_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab&nbsp;:=<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"Saisir"</span>&nbsp;;&nbsp;<span class="string">"Grab"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;hori_shift&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;triplet&nbsp;coefficients.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sg&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;hori_shift&nbsp;(&nbsp;5&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;triplet&nbsp;coefficients.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;hori_shift&nbsp;(&nbsp;7&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;triplet&nbsp;coefficients.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!rouge&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;red&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;red&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;red&nbsp;:=&nbsp;reduc.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!vert&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;green&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;reduc.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;green&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;reduc.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;green&nbsp;:=&nbsp;reduc.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!bleu&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;blue&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;reduc.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;blue&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;reduc.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;blue&nbsp;:=&nbsp;reduc.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;[|&nbsp;!red&nbsp;;&nbsp;!green&nbsp;;&nbsp;!blue&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_time&nbsp;:=&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rouge&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!sr&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vert&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!sg&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bleu&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!sb&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!cancel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients.(0)&nbsp;&lt;-&nbsp;2&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients.(1)&nbsp;&lt;-&nbsp;2&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients.(2)&nbsp;&lt;-&nbsp;2&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ok&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!grab&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;&nbsp;d.<span class="constructor">Unix</span>.tm_min)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;<span class="string">"Analogic.float_rgb_color_treatment-"</span>&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".ppm"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab_message&nbsp;:=&nbsp;<span class="string">"&nbsp;Last&nbsp;grab&nbsp;:&nbsp;"</span>&nbsp;^&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!rouge&nbsp;!=&nbsp;coefficients.(0)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients.(0)&nbsp;&lt;-&nbsp;!rouge&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!rouge&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;red&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;red&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;red&nbsp;:=&nbsp;reduc.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!vert&nbsp;!=&nbsp;coefficients.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients.(1)&nbsp;&lt;-&nbsp;!vert&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!vert&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;green&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;reduc.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;green&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;reduc.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;green&nbsp;:=&nbsp;reduc.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!bleu&nbsp;!=&nbsp;coefficients.(2)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients.(2)&nbsp;&lt;-&nbsp;!bleu&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!bleu&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;blue&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;reduc.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;blue&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;reduc.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;blue&nbsp;:=&nbsp;reduc.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficients<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
coefficients&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>float_rgb_mark_image approx_hori_size approx_verti_size rgb_matrix reduced_matrix mark</pre> The real vector <code class="code">mark</code> is modified in place.
<p>

Le vecteur réel <code class="code">mark</code> est modifié en place. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;float_rgb_mark_image&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(approx_hori_size:int)&nbsp;(approx_verti_size:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(reduc:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(mark:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;mark&nbsp;&gt;=&nbsp;4&nbsp;)&nbsp;;<br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0).(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_pic&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;reduc.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_pic&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;reduc.(0).(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;obsolete&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_hori&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_verti&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;first_time&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_string&nbsp;=&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;(&nbsp;min&nbsp;6&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;steps&nbsp;=&nbsp;10&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;width&nbsp;/&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;height&nbsp;/&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;factor&nbsp;=&nbsp;height&nbsp;/&nbsp;h_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;(&nbsp;float&nbsp;height&nbsp;)&nbsp;-.&nbsp;2.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ww&nbsp;=&nbsp;(&nbsp;float&nbsp;width&nbsp;)&nbsp;-.&nbsp;2.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_range&nbsp;=&nbsp;[|&nbsp;0&nbsp;;&nbsp;pred&nbsp;width&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_range&nbsp;=&nbsp;[|&nbsp;0&nbsp;;&nbsp;pred&nbsp;height&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_grid&nbsp;=&nbsp;[|&nbsp;-10.&nbsp;;&nbsp;10.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_grid&nbsp;=&nbsp;[|&nbsp;-10.&nbsp;;&nbsp;10.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;small_radius&nbsp;=&nbsp;max&nbsp;10&nbsp;(&nbsp;approx_verti_size&nbsp;/&nbsp;50&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;threshold&nbsp;=&nbsp;(&nbsp;sqrt&nbsp;epsilon_float&nbsp;)&nbsp;*.&nbsp;20.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;h_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;h_pic&nbsp;)&nbsp;/&nbsp;100<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;w_pic&nbsp;)&nbsp;/&nbsp;100&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;w_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;h_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_mid&nbsp;=&nbsp;(&nbsp;5&nbsp;*&nbsp;w_border&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_mid&nbsp;=&nbsp;(&nbsp;5&nbsp;*&nbsp;h_border&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_size&nbsp;=&nbsp;2&nbsp;*&nbsp;w_border&nbsp;+&nbsp;w_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_size&nbsp;=&nbsp;2&nbsp;*&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ls0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vl&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;hs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vt&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;set&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;left_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;left_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;top_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;top_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cancel_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Annuler"</span>&nbsp;;&nbsp;<span class="string">"Cancel"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ok_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;OK&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Rafraîchir"</span>&nbsp;;&nbsp;<span class="string">"Refresh"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab_message&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;right_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_float&nbsp;mark.(2)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;right_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ls3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vr&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ser&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0."</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bottom_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_float&nbsp;mark.(3)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;bottom_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;seb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0."</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_left&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_top&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_right&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_bottom&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ok&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cancel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture&nbsp;=&nbsp;[|&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;;&nbsp;verti_size&nbsp;/&nbsp;2&nbsp;;&nbsp;w_border&nbsp;;&nbsp;h_border&nbsp;;&nbsp;w_border&nbsp;+&nbsp;w_pic&nbsp;;&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.float_rgb_mark_image"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_initial&nbsp;:=&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_initial&nbsp;:=&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_initial&nbsp;:=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(2)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_initial&nbsp;:=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(3)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.background&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.fill_rect&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.foreground&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;!grab_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;ok_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cancel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;cancel_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab&nbsp;:=<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"Saisir"</span>&nbsp;;&nbsp;<span class="string">"Grab"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;(&nbsp;w_border&nbsp;+&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;hori_mid&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_range&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;+&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;w_border&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!left_initial&nbsp;!left_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_left&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;w_border&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;(&nbsp;w_border&nbsp;+&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;hori_mid&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_grid&nbsp;mark.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ser&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;+&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;w_border&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!right_initial&nbsp;!right_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_right&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;w_border&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;hori_shift&nbsp;(&nbsp;h_border&nbsp;+&nbsp;verti_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;hori_shift&nbsp;verti_mid&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_range&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!top_initial&nbsp;!top_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_top&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_mid&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;h_border&nbsp;+&nbsp;verti_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_grid&nbsp;mark.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;1&nbsp;+&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_bottom&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_verti&nbsp;:=&nbsp;w_border&nbsp;+&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_hori&nbsp;:=&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;<span class="constructor">Graphics</span>.red&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_segments&nbsp;[|&nbsp;(&nbsp;!trace_verti&nbsp;,&nbsp;h_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_verti&nbsp;,&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;w_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_hori&nbsp;,&nbsp;w_border&nbsp;+&nbsp;w_pic&nbsp;-&nbsp;2&nbsp;,&nbsp;!trace_hori&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_time&nbsp;:=&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_int_vernier&nbsp;!vl&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;top_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_int_vernier&nbsp;!vt&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;right_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_float_vernier&nbsp;!vr&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bottom_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_float_vernier&nbsp;!vb&nbsp;x&nbsp;y&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!cancel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;-1.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;-1.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ok&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!grab&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;&nbsp;d.<span class="constructor">Unix</span>.tm_min)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;<span class="string">"Analogic.float_rgb_mark_image-"</span>&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".ppm"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab_message&nbsp;:=&nbsp;<span class="string">"&nbsp;Last&nbsp;grab&nbsp;:&nbsp;"</span>&nbsp;^&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;picture&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;(&nbsp;x&nbsp;-&nbsp;w_border&nbsp;)&nbsp;*&nbsp;factor&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;-&nbsp;y&nbsp;)&nbsp;*&nbsp;factor&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;max&nbsp;0.&nbsp;(&nbsp;mark.(0)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;1.&nbsp;+.&nbsp;(&nbsp;min&nbsp;ww&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;max&nbsp;0.&nbsp;(&nbsp;mark.(1)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;1.&nbsp;+.&nbsp;(&nbsp;min&nbsp;hh&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls3&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(2)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs3&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(2)&nbsp;+.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs1&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(3)&nbsp;+.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs1&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(3)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_left&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_right&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_top&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_bottom&nbsp;x&nbsp;y&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;left_choice&nbsp;!=&nbsp;int_of_float&nbsp;mark.(0)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;float&nbsp;left_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;hori_range&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;top_choice&nbsp;!=&nbsp;int_of_float&nbsp;mark.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;float&nbsp;top_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_range&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs_float&nbsp;(&nbsp;right_choice&nbsp;-.&nbsp;mark.(2)&nbsp;)&nbsp;&gt;&nbsp;threshold&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;right_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_grid&nbsp;mark.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs_float&nbsp;(&nbsp;bottom_choice&nbsp;-.&nbsp;mark.(3)&nbsp;)&nbsp;&gt;&nbsp;threshold&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;bottom_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_grid&nbsp;mark.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!sel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_left&nbsp;=&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;obsolete.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!left_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!left_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!left_initial&nbsp;!left_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;int_of_string&nbsp;(&nbsp;!left_initial&nbsp;^&nbsp;!left_final&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;old_obs&nbsp;;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;int_of_string&nbsp;old_left&nbsp;)&nbsp;;&nbsp;left_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;left_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!sel.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!sel.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!sel.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!left_initial&nbsp;!left_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!set&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_top&nbsp;=&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;obsolete.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!top_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!top_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!top_initial&nbsp;!top_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;/&nbsp;factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;int_of_string&nbsp;(&nbsp;!top_initial&nbsp;^&nbsp;!top_final&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;old_obs&nbsp;;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;int_of_string&nbsp;old_top&nbsp;)&nbsp;;&nbsp;top_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;top_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;obsolete.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!set.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!set.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!set.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!top_initial&nbsp;!top_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!ser&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_right&nbsp;=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(2)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!right_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!right_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!right_initial&nbsp;!right_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;float_of_string&nbsp;(&nbsp;!right_initial&nbsp;^&nbsp;!right_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;mark.(2)&nbsp;&lt;-&nbsp;float_of_string&nbsp;old_right&nbsp;;&nbsp;right_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;right_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ser&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!ser.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!ser.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!ser.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!right_initial&nbsp;!right_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!seb&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_bottom&nbsp;=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(3)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!bottom_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!bottom_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;float_of_string&nbsp;(&nbsp;!bottom_initial&nbsp;^&nbsp;!bottom_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;mark.(3)&nbsp;&lt;-&nbsp;float_of_string&nbsp;old_bottom&nbsp;;&nbsp;bottom_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;bottom_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!seb.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seb.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seb.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;mark&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>float_rgb_refine_mark approx_hori_size approx_verti_size rgb_matrix mark</pre> The real vector <code class="code">mark</code> is modified in place.
<p>

Le vecteur réel <code class="code">mark</code> est modifié en place. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;float_rgb_refine_mark&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(approx_hori_size:int)&nbsp;(approx_verti_size:int)&nbsp;(m:float&nbsp;array&nbsp;array&nbsp;array)&nbsp;(mark:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;mark&nbsp;&gt;=&nbsp;4&nbsp;)&nbsp;;<br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;m.(0).(0)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;archive&nbsp;=&nbsp;[|&nbsp;mark.(0)&nbsp;;&nbsp;mark.(1)&nbsp;;&nbsp;mark.(2)&nbsp;;&nbsp;mark.(3)&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;obsolete&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_hori&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace_verti&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;first_time&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_string&nbsp;=&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;s&nbsp;0&nbsp;(&nbsp;min&nbsp;6&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;s&nbsp;)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;steps&nbsp;=&nbsp;10&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="constructor">Util</span>.int_gcd&nbsp;height&nbsp;width<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;(&nbsp;float&nbsp;height&nbsp;)&nbsp;-.&nbsp;2.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ww&nbsp;=&nbsp;(&nbsp;float&nbsp;width&nbsp;)&nbsp;-.&nbsp;2.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_focus&nbsp;=&nbsp;width&nbsp;/&nbsp;40<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_focus&nbsp;=&nbsp;height&nbsp;/&nbsp;40<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_range&nbsp;=&nbsp;[|&nbsp;0&nbsp;;&nbsp;pred&nbsp;width&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_range&nbsp;=&nbsp;[|&nbsp;0&nbsp;;&nbsp;pred&nbsp;height&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_grid&nbsp;=&nbsp;[|&nbsp;-10.&nbsp;;&nbsp;10.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_grid&nbsp;=&nbsp;[|&nbsp;-10.&nbsp;;&nbsp;10.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;small_radius&nbsp;=&nbsp;max&nbsp;10&nbsp;(&nbsp;approx_verti_size&nbsp;/&nbsp;50&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;factor&nbsp;=&nbsp;ref&nbsp;(&nbsp;min&nbsp;g&nbsp;(&nbsp;max&nbsp;(&nbsp;height&nbsp;/&nbsp;approx_hori_size&nbsp;)&nbsp;(&nbsp;width&nbsp;/&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_beginning&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;-&nbsp;hori_focus&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_ending&nbsp;=&nbsp;min&nbsp;(&nbsp;width&nbsp;-&nbsp;1&nbsp;)&nbsp;(&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;+&nbsp;hori_focus&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_beginning&nbsp;=&nbsp;max&nbsp;0&nbsp;(&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;-&nbsp;verti_focus&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_ending&nbsp;=&nbsp;min&nbsp;(&nbsp;height&nbsp;-&nbsp;1&nbsp;)&nbsp;(&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;+&nbsp;verti_focus&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;threshold&nbsp;=&nbsp;(&nbsp;sqrt&nbsp;epsilon_float&nbsp;)&nbsp;*.&nbsp;20.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;g&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factor&nbsp;:=&nbsp;succ&nbsp;!factor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;height&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;width&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"The&nbsp;under-sampling&nbsp;factor&nbsp;must&nbsp;divide&nbsp;the&nbsp;height&nbsp;and&nbsp;the&nbsp;width&nbsp;of&nbsp;the&nbsp;picture&nbsp;in&nbsp;Analogic.float_rgb_refine_mark."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_pic&nbsp;=&nbsp;height&nbsp;/&nbsp;!factor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;neighbour&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Readwrite</span>.rgb_crop&nbsp;m&nbsp;verti_beginning&nbsp;verti_ending&nbsp;hori_beginning&nbsp;hori_ending&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_pic&nbsp;=&nbsp;width&nbsp;/&nbsp;!factor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;h_pic&nbsp;)&nbsp;/&nbsp;100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;maximums&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Matrix</span>.matrix_float_max&nbsp;!neighbour<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_border&nbsp;=&nbsp;(&nbsp;23&nbsp;*&nbsp;w_pic&nbsp;)&nbsp;/&nbsp;100&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;w_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;h_border&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;mm&nbsp;=&nbsp;<span class="constructor">Matrix</span>.vector_float_max&nbsp;maximums<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_mid&nbsp;=&nbsp;(&nbsp;5&nbsp;*&nbsp;w_border&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_mid&nbsp;=&nbsp;(&nbsp;5&nbsp;*&nbsp;h_border&nbsp;)&nbsp;/&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hori_size&nbsp;=&nbsp;2&nbsp;*&nbsp;w_border&nbsp;+&nbsp;w_pic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_size&nbsp;=&nbsp;2&nbsp;*&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neighbour&nbsp;:=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_mult&nbsp;(&nbsp;255.&nbsp;/.&nbsp;(1.&nbsp;+.&nbsp;mm&nbsp;)&nbsp;)&nbsp;)&nbsp;!neighbour&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ls0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vl&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;hs0&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vt&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;set&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;reduc&nbsp;=&nbsp;<span class="constructor">Readwrite</span>.float_rgb_magnify&nbsp;(&nbsp;20&nbsp;/&nbsp;!factor&nbsp;)&nbsp;!neighbour<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;left_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;left_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;top_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;top_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cancel_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Annuler"</span>&nbsp;;&nbsp;<span class="string">"Cancel"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ok_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;OK&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Rafraîchir"</span>&nbsp;;&nbsp;<span class="string">"Refresh"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab_message&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;right_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_float&nbsp;mark.(2)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;right_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ls3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;rs3&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vr&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ser&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0."</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bottom_initial&nbsp;=&nbsp;ref&nbsp;(&nbsp;string_of_float&nbsp;mark.(3)&nbsp;)&nbsp;<span class="keyword">and</span>&nbsp;bottom_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cs1&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;vb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;seb&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"0."</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_left&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_top&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_right&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh_bottom&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ok&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cancel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture&nbsp;=&nbsp;[|&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;;&nbsp;verti_size&nbsp;/&nbsp;2&nbsp;;&nbsp;w_border&nbsp;;&nbsp;h_border&nbsp;;&nbsp;w_border&nbsp;+&nbsp;w_pic&nbsp;;&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.float_rgb_refine_mark"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_initial&nbsp;:=&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_initial&nbsp;:=&nbsp;string_of_int&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_initial&nbsp;:=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(2)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_initial&nbsp;:=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(3)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.background&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.fill_rect&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;)&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.foreground&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;!grab_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;ok_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cancel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;cancel_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab&nbsp;:=<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"Saisir"</span>&nbsp;;&nbsp;<span class="string">"Grab"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;(&nbsp;w_border&nbsp;+&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;hori_mid&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vl&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;verti_shift&nbsp;small_radius&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;hori_range&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;+&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;w_border&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!left_initial&nbsp;!left_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_left&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;w_border&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.left_switch&nbsp;(&nbsp;w_border&nbsp;+&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rs3&nbsp;:=&nbsp;<span class="constructor">Widget</span>.right_switch&nbsp;hori_mid&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_grid&nbsp;mark.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ser&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;hori_size&nbsp;/&nbsp;2&nbsp;+&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;w_border&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!right_initial&nbsp;!right_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_right&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;w_border&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;hori_shift&nbsp;(&nbsp;h_border&nbsp;+&nbsp;verti_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs0&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;hori_shift&nbsp;verti_mid&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vt&nbsp;:=&nbsp;<span class="constructor">Widget</span>.int_vernier&nbsp;hori_shift&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.white&nbsp;steps&nbsp;verti_range&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!top_initial&nbsp;!top_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_top&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;hori_shift&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.hat_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_mid&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs1&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cup_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;h_border&nbsp;+&nbsp;verti_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.blue&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_grid&nbsp;mark.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;1&nbsp;+&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_bottom&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_verti&nbsp;:=&nbsp;w_border&nbsp;+&nbsp;(&nbsp;(&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;-&nbsp;hori_beginning&nbsp;)&nbsp;*&nbsp;20&nbsp;)&nbsp;/&nbsp;!factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trace_hori&nbsp;:=&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;(&nbsp;(&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;-&nbsp;verti_beginning&nbsp;)&nbsp;&nbsp;*&nbsp;20&nbsp;)&nbsp;/&nbsp;!factor&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_float_rgb&nbsp;w_border&nbsp;h_border&nbsp;reduc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_column_magnify_float_rgb&nbsp;(&nbsp;20&nbsp;/&nbsp;!factor&nbsp;)&nbsp;w_border&nbsp;h_border&nbsp;!neighbour&nbsp;obsolete.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative_draw_line_magnify_float_rgb&nbsp;(&nbsp;20&nbsp;/&nbsp;!factor&nbsp;)&nbsp;w_border&nbsp;h_border&nbsp;!neighbour&nbsp;obsolete.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;<span class="constructor">Graphics</span>.red&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_segments&nbsp;[|&nbsp;(&nbsp;!trace_verti&nbsp;,&nbsp;h_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_verti&nbsp;,&nbsp;h_border&nbsp;+&nbsp;h_pic&nbsp;-&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;w_border&nbsp;+&nbsp;1&nbsp;,&nbsp;!trace_hori&nbsp;,&nbsp;w_border&nbsp;+&nbsp;w_pic&nbsp;-&nbsp;2&nbsp;,&nbsp;!trace_hori&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_time&nbsp;:=&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;right_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_float_vernier&nbsp;!vr&nbsp;x&nbsp;y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bottom_choice&nbsp;=&nbsp;<span class="constructor">Widget</span>.over_float_vernier&nbsp;!vb&nbsp;x&nbsp;y&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!cancel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;archive.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;archive.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;archive.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;archive.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ok&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!grab&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;&nbsp;d.<span class="constructor">Unix</span>.tm_min)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;<span class="string">"Analogic.float_rgb_refine_mark-"</span>&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".ppm"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab_message&nbsp;:=&nbsp;<span class="string">"&nbsp;Last&nbsp;grab&nbsp;:&nbsp;"</span>&nbsp;^&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;picture&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;-&nbsp;hori_beginning&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;-&nbsp;verti_beginning&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;(&nbsp;x&nbsp;-&nbsp;w_border&nbsp;)&nbsp;*&nbsp;!factor&nbsp;/&nbsp;20&nbsp;+&nbsp;hori_beginning&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;h_border&nbsp;-&nbsp;y&nbsp;)&nbsp;*&nbsp;!factor&nbsp;/&nbsp;20&nbsp;+&nbsp;verti_beginning&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;-&nbsp;hori_beginning&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;max&nbsp;0.&nbsp;(&nbsp;mark.(0)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(0)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(0)&nbsp;)&nbsp;-&nbsp;hori_beginning&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(0)&nbsp;&lt;-&nbsp;1.&nbsp;+.&nbsp;(&nbsp;min&nbsp;ww&nbsp;mark.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;-&nbsp;verti_beginning&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;max&nbsp;0.&nbsp;(&nbsp;mark.(1)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs0&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete.(1)&nbsp;&lt;-&nbsp;(&nbsp;int_of_float&nbsp;mark.(1)&nbsp;)&nbsp;-&nbsp;verti_beginning&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(1)&nbsp;&lt;-&nbsp;1.&nbsp;+.&nbsp;(&nbsp;min&nbsp;hh&nbsp;mark.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_left_button&nbsp;!ls3&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(2)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_right_button&nbsp;!rs3&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(2)&nbsp;+.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_hat_button&nbsp;!hs1&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(3)&nbsp;+.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_cup_button&nbsp;!cs1&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;0.1&nbsp;*.&nbsp;(&nbsp;float&nbsp;(&nbsp;int_of_float&nbsp;&nbsp;(&nbsp;10.&nbsp;*.&nbsp;mark.(3)&nbsp;-.&nbsp;1.&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_left&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_right&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_top&nbsp;x&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh_bottom&nbsp;x&nbsp;y&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs_float&nbsp;(&nbsp;right_choice&nbsp;-.&nbsp;mark.(2)&nbsp;)&nbsp;&gt;&nbsp;threshold&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;right_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vr&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;w_border&nbsp;+&nbsp;(&nbsp;3&nbsp;*&nbsp;hori_shift&nbsp;/&nbsp;2&nbsp;)&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;hori_grid&nbsp;mark.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;abs_float&nbsp;(&nbsp;bottom_choice&nbsp;-.&nbsp;mark.(3)&nbsp;)&nbsp;&gt;&nbsp;threshold&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;bottom_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.float_vernier&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;h_border&nbsp;)&nbsp;small_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.magenta&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.black&nbsp;steps&nbsp;verti_grid&nbsp;mark.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!ser&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_right&nbsp;=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(2)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!right_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!right_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!right_initial&nbsp;!right_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(2)&nbsp;&lt;-&nbsp;float_of_string&nbsp;(&nbsp;!right_initial&nbsp;^&nbsp;!right_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;mark.(2)&nbsp;&lt;-&nbsp;float_of_string&nbsp;old_right&nbsp;;&nbsp;right_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;right_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ser&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!ser.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!ser.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!ser.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!right_initial&nbsp;!right_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!seb&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_bottom&nbsp;=&nbsp;f_string&nbsp;(&nbsp;string_of_float&nbsp;mark.(3)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!bottom_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!bottom_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bottom_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(3)&nbsp;&lt;-&nbsp;float_of_string&nbsp;(&nbsp;!bottom_initial&nbsp;^&nbsp;!bottom_final&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;mark.(3)&nbsp;&lt;-&nbsp;float_of_string&nbsp;old_bottom&nbsp;;&nbsp;bottom_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;bottom_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seb&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!seb.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seb.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seb.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!bottom_initial&nbsp;!bottom_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;mark&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>coefficient_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;coefficient_list&nbsp;=&nbsp;[|&nbsp;<span class="string">"***"</span>&nbsp;;&nbsp;<span class="string">"0.01"</span>&nbsp;;&nbsp;<span class="string">"0.02"</span>&nbsp;;&nbsp;<span class="string">"0.05"</span>&nbsp;;&nbsp;<span class="string">"0.1"</span>&nbsp;;&nbsp;<span class="string">"0.2"</span>&nbsp;;&nbsp;<span class="string">"0.5"</span>&nbsp;;&nbsp;<span class="string">"1."</span>&nbsp;;&nbsp;<span class="string">"2."</span>&nbsp;;&nbsp;<span class="string">"5."</span>&nbsp;;&nbsp;<span class="string">"10."</span>&nbsp;;&nbsp;<span class="string">"20."</span>&nbsp;;&nbsp;<span class="string">"50."</span>&nbsp;;&nbsp;<span class="string">"100."</span>&nbsp;;&nbsp;<span class="string">"200."</span>&nbsp;;&nbsp;<span class="string">"500."</span>&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>other_coefficient_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;other_coefficient_list&nbsp;=&nbsp;[|&nbsp;<span class="string">"***"</span>&nbsp;;&nbsp;<span class="string">"0.01"</span>&nbsp;;&nbsp;<span class="string">"0.02"</span>&nbsp;;&nbsp;<span class="string">"0.025"</span>&nbsp;;&nbsp;<span class="string">"0.04"</span>&nbsp;;&nbsp;<span class="string">"0.05"</span>&nbsp;;&nbsp;<span class="string">"0.1"</span>&nbsp;;&nbsp;<span class="string">"0.2"</span>&nbsp;;&nbsp;<span class="string">"0.25"</span>&nbsp;;&nbsp;<span class="string">"0.4"</span>&nbsp;;&nbsp;<span class="string">"0.5"</span>&nbsp;;&nbsp;<span class="string">"1."</span>&nbsp;;&nbsp;<span class="string">"2."</span>&nbsp;;&nbsp;<span class="string">"2.5"</span>&nbsp;;&nbsp;<span class="string">"4."</span>&nbsp;;&nbsp;<span class="string">"5."</span>&nbsp;;&nbsp;<span class="string">"10."</span>&nbsp;;&nbsp;<span class="string">"20."</span>&nbsp;;&nbsp;<span class="string">"25."</span>&nbsp;;&nbsp;<span class="string">"40."</span>&nbsp;;&nbsp;<span class="string">"50."</span>&nbsp;;&nbsp;<span class="string">"100."</span>&nbsp;;&nbsp;<span class="string">"200."</span>&nbsp;;&nbsp;<span class="string">"250."</span>&nbsp;;&nbsp;<span class="string">"400."</span>&nbsp;;&nbsp;<span class="string">"500."</span>&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>multiplicator_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;multiplicator_list&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;float_of_string&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;coefficient_list&nbsp;1&nbsp;(&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;coefficient_list&nbsp;)&nbsp;)&nbsp;)&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>prefix_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;prefix_list&nbsp;=&nbsp;[|&nbsp;<span class="string">"a"</span>&nbsp;;&nbsp;<span class="string">"f"</span>&nbsp;;&nbsp;<span class="string">"p"</span>&nbsp;;&nbsp;<span class="string">"n"</span>&nbsp;;&nbsp;<span class="string">"µ"</span>&nbsp;;&nbsp;<span class="string">"m"</span>&nbsp;;&nbsp;<span class="string">"c"</span>&nbsp;;&nbsp;<span class="string">"d"</span>&nbsp;;&nbsp;<span class="string">""</span>&nbsp;;&nbsp;<span class="string">"da"</span>&nbsp;;&nbsp;<span class="string">"h"</span>&nbsp;;&nbsp;<span class="string">"k"</span>&nbsp;;&nbsp;<span class="string">"M"</span>&nbsp;;&nbsp;<span class="string">"G"</span>&nbsp;;&nbsp;<span class="string">"T"</span>&nbsp;;&nbsp;<span class="string">"P"</span>&nbsp;;&nbsp;<span class="string">"E"</span>&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>exponent_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;exponent_list&nbsp;=&nbsp;[|&nbsp;1e-18&nbsp;;&nbsp;1e-15&nbsp;;&nbsp;1e-12&nbsp;;&nbsp;1e-9&nbsp;;&nbsp;1e-6&nbsp;;&nbsp;1e-3&nbsp;;&nbsp;0.01&nbsp;;&nbsp;0.1&nbsp;;&nbsp;1.&nbsp;;&nbsp;10.&nbsp;;&nbsp;100.&nbsp;;&nbsp;1e3&nbsp;;&nbsp;1e6&nbsp;;&nbsp;1e9&nbsp;;&nbsp;1e12&nbsp;;&nbsp;1e15&nbsp;;&nbsp;1e18&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>unit_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;unit_list&nbsp;=&nbsp;[|&nbsp;<span class="string">"***"</span>&nbsp;;&nbsp;<span class="string">"V"</span>&nbsp;;&nbsp;<span class="string">"A"</span>&nbsp;;&nbsp;<span class="string">"h"</span>&nbsp;;&nbsp;<span class="string">"min"</span>&nbsp;;&nbsp;<span class="string">"s"</span>&nbsp;;&nbsp;<span class="string">"B"</span>&nbsp;;&nbsp;<span class="string">"Bm"</span>&nbsp;;&nbsp;<span class="string">"BA"</span>&nbsp;;&nbsp;<span class="string">"Hz"</span>&nbsp;;&nbsp;<span class="string">"m"</span>&nbsp;;&nbsp;<span class="string">"ft"</span>&nbsp;;&nbsp;<span class="string">"%"</span>&nbsp;;&nbsp;<span class="string">"DIV"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>visual_unit_list</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;visual_unit_list&nbsp;=&nbsp;[|&nbsp;<span class="string">"DIV"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;;&nbsp;<span class="string">"scr"</span>&nbsp;|]&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>choose_unit hori_size verti_size units</pre> The string vector <code class="code">unit_strings</code> is modified in place.
<p>

Le vecteur de chaînes de caractères <code class="code">unit_strings</code> est modifié en place. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;choose_unit&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(hori_size:int)&nbsp;(verti_size:int)&nbsp;(unit_strings:string&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">assert</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;unit_strings&nbsp;&gt;=&nbsp;4&nbsp;)&nbsp;;<br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;obsolete&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;first_time&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;cancel_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Annuler"</span>&nbsp;;&nbsp;<span class="string">"Cancel"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;ok_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;OK&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;refresh_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"Rafraîchir"</span>&nbsp;;&nbsp;<span class="string">"Refresh"</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab_message&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;sc&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sp&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;su&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sv&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coefficient&nbsp;=&nbsp;ref&nbsp;7&nbsp;<span class="keyword">and</span>&nbsp;prefix&nbsp;=&nbsp;ref&nbsp;8&nbsp;<span class="keyword">and</span>&nbsp;unit&nbsp;=&nbsp;ref&nbsp;1&nbsp;<span class="keyword">and</span>&nbsp;visual_unit&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;sec&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sep&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;seu&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;sev&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">""</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ok&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;cancel&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;grab&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;refresh&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;hori_size&nbsp;/&nbsp;20<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;verti_size&nbsp;/&nbsp;20<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coefficient_initial&nbsp;=&nbsp;ref&nbsp;coefficient_list.(!coefficient)&nbsp;<span class="keyword">and</span>&nbsp;coefficient_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;prefix_initial&nbsp;=&nbsp;ref&nbsp;prefix_list.(!prefix)&nbsp;<span class="keyword">and</span>&nbsp;prefix_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;unit_initial&nbsp;=&nbsp;ref&nbsp;unit_list.(!unit)&nbsp;<span class="keyword">and</span>&nbsp;unit_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;visual_unit_initial&nbsp;=&nbsp;ref&nbsp;visual_unit_list.(!visual_unit)&nbsp;<span class="keyword">and</span>&nbsp;visual_unit_final&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;max_radius&nbsp;=&nbsp;(&nbsp;min&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;/&nbsp;3<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;small_radius&nbsp;=&nbsp;max&nbsp;10&nbsp;(&nbsp;verti_size&nbsp;/&nbsp;50&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(0)&nbsp;&lt;-&nbsp;!coefficient_initial&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(1)&nbsp;&lt;-&nbsp;!prefix_initial&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(2)&nbsp;&lt;-&nbsp;!unit_initial&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(3)&nbsp;&lt;-&nbsp;!visual_unit_initial&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!first_time&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.choose_unit"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.background&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.fill_rect&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;0&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.foreground&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;!grab_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;16&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;-&nbsp;(&nbsp;snd&nbsp;(&nbsp;<span class="constructor">Graphics</span>.text_size&nbsp;<span class="string">"W"</span>&nbsp;)&nbsp;)&nbsp;/&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"/"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient_initial&nbsp;:=&nbsp;unit_strings.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefix_initial&nbsp;:=&nbsp;unit_strings.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefix_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_initial&nbsp;:=&nbsp;unit_strings.(2)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_final&nbsp;:=&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;visual_unit_initial&nbsp;:=&nbsp;unit_strings.(3)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;visual_unit_final&nbsp;:=<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete&nbsp;:=&nbsp;unit_strings.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;hori_size&nbsp;-&nbsp;2&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;3&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;ok_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cancel&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;2&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;2&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;cancel_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab&nbsp;:=<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;2&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.cyan&nbsp;<span class="constructor">Graphics</span>.black&nbsp;[|&nbsp;<span class="string">"Saisir"</span>&nbsp;;&nbsp;<span class="string">"Grab"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;verti_size&nbsp;-&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;refresh_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;coefficient_list&nbsp;!coefficient&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;11&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;prefix_list&nbsp;!prefix&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;su&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;15&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;unit_list&nbsp;!unit&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sv&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;18&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;visual_unit_list&nbsp;!visual_unit&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sec&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;8&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!coefficient_initial&nbsp;!coefficient_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sep&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;11&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)(&nbsp;2&nbsp;*&nbsp;&nbsp;hori_shift&nbsp;)&nbsp;<span class="constructor">Widget</span>.dark_grey&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!prefix_initial&nbsp;!prefix_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seu&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;14&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!unit_initial&nbsp;!unit_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sev&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;18&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;(&nbsp;2&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;!visual_unit_initial&nbsp;!visual_unit_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.background&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.fill_rect&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;15&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_color&nbsp;&nbsp;<span class="constructor">Graphics</span>.foreground&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;15&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;(&nbsp;unit_strings.(0)&nbsp;^&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;unit_strings.(1)&nbsp;^&nbsp;unit_strings.(2)&nbsp;^&nbsp;<span class="string">"&nbsp;/&nbsp;"</span>&nbsp;^&nbsp;unit_strings.(3)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_init *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_time&nbsp;:=&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!sc&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!sp&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!su&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;visual_unit&nbsp;:=&nbsp;<span class="constructor">Widget</span>.over_selector&nbsp;!sv&nbsp;x&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!cancel&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(0)&nbsp;&lt;-&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(1)&nbsp;&lt;-&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(2)&nbsp;&lt;-&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(3)&nbsp;&lt;-&nbsp;<span class="string">""</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ok&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!grab&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;&nbsp;d.<span class="constructor">Unix</span>.tm_min)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;<span class="string">"Analogic.choose_unit-"</span>&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".ppm"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;hori_size&nbsp;verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grab_message&nbsp;:=&nbsp;<span class="string">"&nbsp;Last&nbsp;grab&nbsp;:&nbsp;"</span>&nbsp;^&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!refresh&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;!coefficient&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;coefficient_list.(!coefficient)&nbsp;!=&nbsp;unit_strings.(0)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(0)&nbsp;&lt;-&nbsp;coefficient_list.(!coefficient)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;coefficient_list&nbsp;!coefficient&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;prefix_list.(!prefix)&nbsp;!=&nbsp;unit_strings.(1)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(1)&nbsp;&lt;-&nbsp;prefix_list.(!prefix)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;11&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;prefix_list&nbsp;!prefix&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;!unit&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;unit_list.(!unit)&nbsp;!=&nbsp;unit_strings.(2)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(2)&nbsp;&lt;-&nbsp;unit_list.(!unit)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;su&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;15&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;unit_list&nbsp;!unit&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;visual_unit_list.(!visual_unit)&nbsp;!=&nbsp;unit_strings.(3)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(3)&nbsp;&lt;-&nbsp;visual_unit_list.(!visual_unit)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sv&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;18&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;visual_unit_list&nbsp;!visual_unit&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!sec&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_coefficient&nbsp;=&nbsp;unit_strings.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_obs&nbsp;=&nbsp;!obsolete<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_initial&nbsp;=&nbsp;!coefficient_initial<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;old_final&nbsp;=&nbsp;!coefficient_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!coefficient_initial&nbsp;!coefficient_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;chaine&nbsp;=&nbsp;!coefficient_initial&nbsp;^&nbsp;!coefficient_final&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_of_string&nbsp;chaine&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obsolete&nbsp;:=&nbsp;unit_strings.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(0)&nbsp;&lt;-&nbsp;chaine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;obsolete&nbsp;:=&nbsp;old_obs&nbsp;;&nbsp;unit_strings.(0)&nbsp;&lt;-&nbsp;old_coefficient&nbsp;;&nbsp;coefficient_initial&nbsp;:=&nbsp;old_initial&nbsp;;&nbsp;coefficient_final&nbsp;:=&nbsp;old_final&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sec&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!sec.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!sec.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!sec.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!coefficient_initial&nbsp;!coefficient_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coefficient&nbsp;:=&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;coefficient_list&nbsp;!coefficient&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_string_edit&nbsp;!seu&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ev&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.keypressed&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Graphics</span>.button_down&nbsp;()&nbsp;)&nbsp;)&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_key&nbsp;(&nbsp;!ev.<span class="constructor">Graphics</span>.key&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Widget</span>.string_treatment&nbsp;!unit_initial&nbsp;!unit_final&nbsp;!current_character&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_initial&nbsp;:=&nbsp;res.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_final&nbsp;:=&nbsp;res.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings.(2)&nbsp;&lt;-&nbsp;!unit_initial&nbsp;^&nbsp;!unit_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seu&nbsp;:=&nbsp;<span class="constructor">Widget</span>.string_edit&nbsp;(&nbsp;int_of_string&nbsp;!seu.(0)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seu.(1)&nbsp;)&nbsp;(&nbsp;int_of_string&nbsp;!seu.(2)&nbsp;)&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.white&nbsp;<span class="constructor">Graphics</span>.green&nbsp;!unit_initial&nbsp;!unit_final&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;:=&nbsp;0&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;su&nbsp;:=&nbsp;<span class="constructor">Widget</span>.cursor_round_selector&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;small_radius&nbsp;max_radius&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.yellow&nbsp;<span class="constructor">Graphics</span>.black&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.white&nbsp;unit_list&nbsp;!unit&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ev&nbsp;:=&nbsp;<span class="constructor">Graphics</span>.wait_next_event&nbsp;[&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Key_pressed</span>&nbsp;;&nbsp;<span class="constructor">Graphics</span>.<span class="constructor">Button_down</span>&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit_strings<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;unit_strings&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="1_Calculs"><h1>Calculs</h1></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>antigamma luminance_matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;antigamma&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(signal:float&nbsp;array&nbsp;array)<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;1.&nbsp;+.&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_max&nbsp;signal&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;x&nbsp;*.&nbsp;m&nbsp;)&nbsp;/.&nbsp;(&nbsp;m&nbsp;-.&nbsp;x&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Matrix</span>.matrix_float_apply&nbsp;f&nbsp;signal&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>prepare_trace threshold luminance_matrix</pre> This function corresponds to the function <code class="code">split_traces</code>
when the monotrace mode is strectched.
<p>

Cette fonction correspond à la fonction <code class="code">split_traces</code> quand le mode monotrace est forcé. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;prepare_trace&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(threshold:float)&nbsp;(lumi:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mediane&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_composed_median&nbsp;lumi&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;signal&nbsp;=&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_crest&nbsp;(&nbsp;threshold&nbsp;*.&nbsp;mediane&nbsp;)&nbsp;lumi&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;slopes&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_diff&nbsp;1.&nbsp;x&nbsp;)&nbsp;signal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;[|&nbsp;signal&nbsp;|]&nbsp;;&nbsp;[|&nbsp;slopes&nbsp;|]&nbsp;|]&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>split_traces threshold luminance_matrix</pre> A good value for the threshold is between around 0.1 and 10.
It depends much on the view capture and must be set by the user.
Output: transposed matrices of the peaks of the luminosities restricted to the zone of each trace: <code class="code">traces</code>,
partial derivatives (in the vertical direction of the picture) of the preceding ones: <code class="code">slopes = diff_traces</code>.
<p>

Une bonne valeur pour le seuil <code class="code">threshold</code> est autour de 0.1 à 10.
Il dépend beaucoup de la prise de vue et doit être fixé par l'utilisateur.
Sortie : transposées des crêtes de luminosités restreintes aux zones de chaque trace : <code class="code">traces</code>, 
dérivées partielles (dans la direction verticale de l'image) des précédentes : <code class="code">slopes = diff_traces</code>. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;split_traces&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(threshold:float)&nbsp;(lumi:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;ff&nbsp;=&nbsp;(&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;x&nbsp;!=&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;abs&nbsp;x&nbsp;=&nbsp;abs&nbsp;y&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">false</span>&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;compare&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_sum&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_demakeup&nbsp;x&nbsp;)&nbsp;)&nbsp;0.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mediane&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_composed_median&nbsp;lumi&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;signal&nbsp;=&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_crest&nbsp;(&nbsp;threshold&nbsp;*.&nbsp;mediane&nbsp;)&nbsp;lumi&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;slopes&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_diff&nbsp;1.&nbsp;x&nbsp;)&nbsp;signal<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;signal<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;signal.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;separations&nbsp;=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;width&nbsp;1&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hh&nbsp;=&nbsp;float&nbsp;height<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;nn&nbsp;=&nbsp;pred&nbsp;width<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;numbers&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;width&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;range&nbsp;=&nbsp;int_of_float&nbsp;(&nbsp;2.&nbsp;*.&nbsp;(&nbsp;sqrt&nbsp;hh&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Matrix</span>.vector_foa_demakeup&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_foa_cut&nbsp;range&nbsp;(&nbsp;<span class="constructor">Matrix</span>.<span class="constructor">Float_vector_cons</span>&nbsp;x&nbsp;)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;factor&nbsp;=&nbsp;height&nbsp;/&nbsp;range<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;pr&nbsp;=&nbsp;pred&nbsp;range&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;h&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;(&nbsp;g&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;pr&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;auxil&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;h&nbsp;slopes&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;up&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.sub&nbsp;x&nbsp;0&nbsp;pr&nbsp;)&nbsp;auxil<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;down&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.sub&nbsp;x&nbsp;1&nbsp;pr&nbsp;)&nbsp;auxil&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;nn&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;column_up&nbsp;=&nbsp;up.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;column_down&nbsp;=&nbsp;down.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;sep&nbsp;=&nbsp;ref&nbsp;separations.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;ff&nbsp;column_up.(j)&nbsp;column_down.(j)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sep&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!sep&nbsp;[|&nbsp;(&nbsp;factor&nbsp;*&nbsp;j&nbsp;+&nbsp;!sep.(&nbsp;pred&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!sep&nbsp;)&nbsp;)&nbsp;)&nbsp;/&nbsp;2&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sep&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!sep&nbsp;[|&nbsp;pred&nbsp;height&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separations.(i)&nbsp;&lt;-&nbsp;!sep&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numbers.(i)&nbsp;&lt;-&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!sep&nbsp;)&nbsp;-&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nombre&nbsp;=&nbsp;int_of_float&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_median&nbsp;(&nbsp;<span class="constructor">Matrix</span>.float_of_vector&nbsp;numbers&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;valid&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;(&nbsp;=&nbsp;)&nbsp;nombre&nbsp;)&nbsp;numbers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;nombre&nbsp;0.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;beginning&nbsp;=&nbsp;<span class="constructor">Util</span>.vector_find_first&nbsp;(&nbsp;=&nbsp;)&nbsp;<span class="keyword">true</span>&nbsp;valid<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;traces&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;width&nbsp;height&nbsp;)&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff_traces&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;width&nbsp;height&nbsp;)&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;nombre&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;accu_high&nbsp;=&nbsp;ref&nbsp;(&nbsp;separations.(beginning).(&nbsp;succ&nbsp;i&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accu_low&nbsp;=&nbsp;ref&nbsp;(&nbsp;separations.(beginning).(&nbsp;i&nbsp;+&nbsp;2&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;trace&nbsp;=&nbsp;traces.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;diff_trace&nbsp;=&nbsp;diff_traces.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;beginning&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.blit&nbsp;signal.(j)&nbsp;!accu_high&nbsp;trace.(j)&nbsp;!accu_high&nbsp;(&nbsp;!accu_low&nbsp;-&nbsp;!accu_high&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.blit&nbsp;slopes.(j)&nbsp;!accu_high&nbsp;diff_trace.(j)&nbsp;!accu_high&nbsp;(&nbsp;!accu_low&nbsp;-&nbsp;!accu_high&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;j&nbsp;=&nbsp;succ&nbsp;beginning&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;width&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;valid.(j)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu_high&nbsp;:=&nbsp;separations.(j).(&nbsp;succ&nbsp;i&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accu_low&nbsp;:=&nbsp;separations.(j).(&nbsp;2&nbsp;+&nbsp;i&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.blit&nbsp;signal.(j)&nbsp;!accu_high&nbsp;trace.(j)&nbsp;!accu_high&nbsp;(&nbsp;!accu_low&nbsp;-&nbsp;!accu_high&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.blit&nbsp;slopes.(j)&nbsp;!accu_high&nbsp;diff_trace.(j)&nbsp;!accu_high&nbsp;(&nbsp;!accu_low&nbsp;-&nbsp;!accu_high&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;traces&nbsp;;&nbsp;diff_traces&nbsp;|]&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>bound_trace trace</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;bound_trace&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(trace:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;trace<br>
&nbsp;<span class="keyword">and</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;trace.(0)<br>
&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;cmp_lum&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;compare&nbsp;y&nbsp;x<br>
&nbsp;<span class="keyword">and</span>&nbsp;cmp_index&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(&nbsp;i&nbsp;,&nbsp;x&nbsp;)&nbsp;(&nbsp;j&nbsp;,&nbsp;y&nbsp;)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;compare&nbsp;i&nbsp;j&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;r&nbsp;2&nbsp;0.<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;first_decile&nbsp;=&nbsp;height&nbsp;/&nbsp;10&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;rr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;x&nbsp;=&nbsp;<span class="constructor">Array</span>.mapi&nbsp;f&nbsp;trace.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row&nbsp;=&nbsp;b.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.sort&nbsp;cmp_lum&nbsp;x&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;y&nbsp;=&nbsp;<span class="constructor">Array</span>.sub&nbsp;x&nbsp;0&nbsp;first_decile&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.sort&nbsp;cmp_index&nbsp;y&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row.(0)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;fst&nbsp;y.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;row.(1)&nbsp;&lt;-&nbsp;float&nbsp;(&nbsp;fst&nbsp;(&nbsp;<span class="constructor">Util</span>.array_last&nbsp;y&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;b&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>digitize_step bounds weights trace slope</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;digitize_step&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(bounds:float&nbsp;array&nbsp;array)&nbsp;(weights:float&nbsp;array)&nbsp;(trace:float&nbsp;array&nbsp;array)&nbsp;(slope:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;wl&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;weights<br>
&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;trace&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;wl&nbsp;!=&nbsp;width&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"Bad&nbsp;number&nbsp;of&nbsp;weights&nbsp;in&nbsp;Analogic.digitize."</span>&nbsp;;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;width&nbsp;0.<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;y&nbsp;&gt;=&nbsp;0.&nbsp;<span class="keyword">then</span>&nbsp;x&nbsp;<span class="keyword">else</span>&nbsp;1.&nbsp;-.&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;g&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;i&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;y&nbsp;&gt;=&nbsp;0.&nbsp;<span class="keyword">then</span>&nbsp;(&nbsp;float&nbsp;i&nbsp;)&nbsp;*.&nbsp;x&nbsp;<span class="keyword">else</span>&nbsp;(&nbsp;float&nbsp;i&nbsp;)&nbsp;*.&nbsp;(&nbsp;1.&nbsp;-.&nbsp;x&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;width&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;form&nbsp;=&nbsp;trace.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;row&nbsp;=&nbsp;bounds.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;gradient&nbsp;=&nbsp;slope.(i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w&nbsp;=&nbsp;weights.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ww&nbsp;=&nbsp;<span class="constructor">Array</span>.mapi&nbsp;(&nbsp;g&nbsp;w&nbsp;)&nbsp;gradient<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;w_w&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;f&nbsp;w&nbsp;)&nbsp;gradient&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;position&nbsp;=&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_scal_prod&nbsp;ww&nbsp;form&nbsp;)&nbsp;/.&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_scal_prod&nbsp;w_w&nbsp;form&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.(i)&nbsp;&lt;-&nbsp;max&nbsp;row.(0)&nbsp;(&nbsp;min&nbsp;position&nbsp;row.(1)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;result&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>thickness matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;thickness&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(trace:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;width&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;trace&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;thickness&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;width&nbsp;0.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;width&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;form&nbsp;=&nbsp;trace.(i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;float&nbsp;(&nbsp;compare&nbsp;x&nbsp;0.&nbsp;)&nbsp;)&nbsp;form&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thickness.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.vector_float_sum&nbsp;t<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;thickness&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>direct_tame vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;direct_tame&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(v:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;v<br>
&nbsp;<span class="keyword">and</span>&nbsp;a&nbsp;=&nbsp;0.5&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;w&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;r&nbsp;0.<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rr&nbsp;=&nbsp;pred&nbsp;r<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;rrr&nbsp;=&nbsp;r&nbsp;-&nbsp;2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;rrr&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;w.(i)&nbsp;&lt;-&nbsp;a&nbsp;*.&nbsp;(&nbsp;v.(&nbsp;pred&nbsp;i&nbsp;)&nbsp;+.&nbsp;v.(i)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;w.(rr)&nbsp;&lt;-&nbsp;v.(rrr)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;w.(0)&nbsp;&lt;-&nbsp;w.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>tame degree vector</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;tame&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(n:int)&nbsp;(v:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;w&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_copy&nbsp;v&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;1&nbsp;<span class="keyword">to</span>&nbsp;n&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;w&nbsp;:=&nbsp;direct_tame&nbsp;!w<br>
&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;!w&nbsp;;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>weigh factor position</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;weigh&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(factor:float)&nbsp;(index:int)&nbsp;(position:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kappa&nbsp;=&nbsp;<span class="constructor">Infinitesimal</span>.discrete_graph_curvature&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_richardson_binary_diff&nbsp;factor&nbsp;(&nbsp;tame&nbsp;index&nbsp;position&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;0.5&nbsp;*.&nbsp;(&nbsp;1.&nbsp;-.&nbsp;0.99&nbsp;*.&nbsp;tanh&nbsp;(&nbsp;x&nbsp;*.&nbsp;factor&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tame&nbsp;index&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;f&nbsp;kappa&nbsp;)&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>digitize threshold trace slope</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;digitize&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(threshold:float)&nbsp;(trace:float&nbsp;array&nbsp;array)&nbsp;(slope:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;error&nbsp;=&nbsp;ref&nbsp;max_float<br>
&nbsp;<span class="keyword">and</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Matrix</span>.vector_float_median&nbsp;(&nbsp;thickness&nbsp;trace&nbsp;)<br>
&nbsp;<span class="keyword">and</span>&nbsp;index&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;<span class="keyword">and</span>&nbsp;rate&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;<span class="keyword">and</span>&nbsp;bounds&nbsp;=&nbsp;bound_trace&nbsp;trace&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;position&nbsp;=&nbsp;ref&nbsp;(&nbsp;digitize_step&nbsp;bounds&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;trace&nbsp;)&nbsp;0.5&nbsp;)&nbsp;trace&nbsp;slope&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;old_position&nbsp;=&nbsp;ref&nbsp;!position<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;n&nbsp;=&nbsp;int_of_float&nbsp;(&nbsp;1.&nbsp;+.&nbsp;(&nbsp;log&nbsp;t&nbsp;)&nbsp;/.&nbsp;(&nbsp;log&nbsp;2.&nbsp;)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!error&nbsp;&gt;=&nbsp;threshold&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old_position&nbsp;:=&nbsp;!position&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;:=&nbsp;digitize_step&nbsp;bounds&nbsp;(&nbsp;weigh&nbsp;t&nbsp;n&nbsp;!position&nbsp;)&nbsp;trace&nbsp;slope&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.vector_float_norm_inf&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_minus&nbsp;(&nbsp;tame&nbsp;!rate&nbsp;!position&nbsp;)&nbsp;(&nbsp;tame&nbsp;!rate&nbsp;!old_position&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;index&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rate&nbsp;:=&nbsp;int_of_float&nbsp;(&nbsp;sqrt&nbsp;(&nbsp;float&nbsp;!index&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!position&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>automatic_digitize trace slope</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;automatic_digitize&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(trace:float&nbsp;array&nbsp;array)&nbsp;(slope:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;height&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;trace.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;threshold&nbsp;=&nbsp;(&nbsp;float&nbsp;(&nbsp;height&nbsp;*&nbsp;256&nbsp;)&nbsp;)&nbsp;*.&nbsp;epsilon_float&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;digitize&nbsp;threshold&nbsp;trace&nbsp;slope&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>linear_regression departure arrival</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;linear_regression&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(x:float&nbsp;array&nbsp;array)&nbsp;(y:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="constructor">Matrix</span>.linear_regression&nbsp;(&nbsp;<span class="constructor">Matrix</span>.sym_float_tune_reduc&nbsp;2e-4&nbsp;30&nbsp;)&nbsp;x&nbsp;y&nbsp;;;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>autocrop luminance_matrix</pre> *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;autocrop&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;(lumi:float&nbsp;array&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">let</span>&nbsp;mediane&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_composed_median&nbsp;lumi&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;x&nbsp;&gt;=&nbsp;0.8&nbsp;*.&nbsp;mediane&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;x&nbsp;&lt;=&nbsp;1.2&nbsp;*.&nbsp;mediane&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;1.&nbsp;<span class="keyword">else</span>&nbsp;0.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mask&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;test&nbsp;)&nbsp;lumi&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_scan&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_sum_by_row&nbsp;mask<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_scan&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_sum_by_column&nbsp;mask&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hm&nbsp;=&nbsp;<span class="constructor">Matrix</span>.vector_float_median&nbsp;hori_scan<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vm&nbsp;=&nbsp;<span class="constructor">Matrix</span>.vector_float_median&nbsp;verti_scan&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hs&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;(&nbsp;&lt;=&nbsp;)&nbsp;(&nbsp;0.8&nbsp;*.&nbsp;hm&nbsp;)&nbsp;)&nbsp;hori_scan<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vs&nbsp;=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;(&nbsp;&lt;=&nbsp;)&nbsp;(&nbsp;0.8&nbsp;*.&nbsp;vm&nbsp;)&nbsp;)&nbsp;verti_scan&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="constructor">Util</span>.vector_find_first&nbsp;(&nbsp;=&nbsp;)&nbsp;<span class="keyword">true</span>&nbsp;vs&nbsp;;&nbsp;<span class="constructor">Util</span>.vector_find_last&nbsp;(&nbsp;=&nbsp;)&nbsp;<span class="keyword">true</span>&nbsp;vs&nbsp;;&nbsp;<span class="constructor">Util</span>.vector_find_first&nbsp;(&nbsp;=&nbsp;)&nbsp;<span class="keyword">true</span>&nbsp;hs&nbsp;;&nbsp;<span class="constructor">Util</span>.vector_find_last&nbsp;(&nbsp;=&nbsp;)&nbsp;<span class="keyword">true</span>&nbsp;hs&nbsp;;&nbsp;<span class="constructor">Array</span>.length&nbsp;lumi.(0)&nbsp;;&nbsp;<span class="constructor">Array</span>.length&nbsp;lumi&nbsp;|]&nbsp;;;<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ </center> *)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** 
<span id="1_Numrisationinteractive"><h1>Numérisation interactive</h1></span>
<span id="1_Interactivedigitization"><h1>Interactive digitization</h1></span>
*)</span></td></tr></table><code class="code"><br>
</code><table><tr><td></td><td><span class="comment">(** <center> </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** The following functions save automatically some window captures in <code class="code">ppm</code> files.
The numerical data are automatically saved in text files or <code class="code">au</code> files.
The treatment data are saved in a file whose name ends with "metadata".
A good value for the threshold is between around 0.1 and 10.
It depends much on the view capture and must be set by the user.
The <code class="code">monotrace</code> switch permits to stretch the work on a unique trace.
The integer <code class="code">max_number</code> limits the display of selectors: go all over the lists with the central button.
<p>

Les fonctions suivantes sauvegardent automatiquement certaines saisies de fenêtres dans des fichiers <code class="code">ppm</code>.
Les données numériques sont sauvegardées automatiquement dans des fichiers textes ou des fichiers <code class="code">au</code>.
Les données de traitement sont sauvegardées dans un fichier dont le nom se termine par "metadata".
Une bonne valeur pour le seuil est autour de 0.1 à 10.
Il dépend beaucoup de la prise de vue et doit être fixé par l'utilisateur.
Le commutateur <code class="code">monotrace</code> permet de forcer le travail sur une trace unique.
L'entier <code class="code">max_number</code> limite l'affichage des sélecteurs : parcourir les listes avec le bouton central. *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>oscillo_recorder phosphor_switch monotrace_switch hori_size verti_size max_number</pre> This function acts only by side effect, writing data into files.
The <code class="code">phosphor</code> switch permits using this function for oscilloscopes and graphic recorders.
<p>

Cette fonction opère uniquement par effet de bord, en écrivant les données dans des fichiers.
Le commutateur <code class="code">phosphor</code> permet une utilisation pour les oscilloscopes, les tables traçantes, les enregistreurs graphiques. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;oscillo_recorder&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(phosphor:bool)&nbsp;(monotrace:bool)&nbsp;(approx_hori_size:int)&nbsp;(approx_verti_size:int)&nbsp;(max_number:int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;date&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;step&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;dname&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Sys</span>.getcwd&nbsp;()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture_file&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture_address&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;picture&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;3&nbsp;1&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;height&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;width&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;factor&nbsp;=&nbsp;ref&nbsp;1<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;reduc&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;3&nbsp;1&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;coefficients&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;3&nbsp;2<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;threshold&nbsp;=&nbsp;[|&nbsp;1.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;marks&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;4&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;mark&nbsp;=&nbsp;<span class="constructor">Array</span>.make&nbsp;4&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;affine_isomorphism&nbsp;=&nbsp;ref&nbsp;[|&nbsp;[|&nbsp;[|&nbsp;1.&nbsp;;&nbsp;0.&nbsp;|]&nbsp;;&nbsp;[|&nbsp;0.&nbsp;;&nbsp;-1.&nbsp;|]&nbsp;|]&nbsp;;&nbsp;[|&nbsp;[|&nbsp;0.&nbsp;;&nbsp;0.&nbsp;|]&nbsp;|]&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ll_corner&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ur_corner&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;horizontal_units&nbsp;=&nbsp;[|&nbsp;<span class="string">"1."</span>&nbsp;;&nbsp;<span class="string">"&nbsp;"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;vertical_units&nbsp;=&nbsp;[|&nbsp;<span class="string">"1."</span>&nbsp;;&nbsp;<span class="string">"&nbsp;"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;;&nbsp;<span class="string">"pix"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;source&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;3&nbsp;1&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;bigomega&nbsp;=&nbsp;ref&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;number_of_traces&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;samples&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;interval&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0.&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;curves&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;derivatives&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;speeds&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;transfos&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;modules&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;crop_values&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;6&nbsp;0&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;never_cropped&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;truncate&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;(peak:float)&nbsp;(x:float&nbsp;array)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="keyword">function</span>&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;classify_float&nbsp;y&nbsp;=&nbsp;<span class="constructor">FP_normal</span>&nbsp;<span class="keyword">then</span>&nbsp;min&nbsp;peak&nbsp;(&nbsp;max&nbsp;0.&nbsp;y&nbsp;)&nbsp;<span class="keyword">else</span>&nbsp;0.&nbsp;)&nbsp;x<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accu_int&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;s&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;^&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;accu_float&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;s&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;^&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_float&nbsp;x&nbsp;)<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;end_message&nbsp;=&nbsp;[|&nbsp;<span class="string">"&nbsp;Terminer&nbsp;"</span>&nbsp;;&nbsp;<span class="string">"&nbsp;Finish&nbsp;"</span>&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;go_on_messages&nbsp;=&nbsp;[|&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;le&nbsp;répertoire&nbsp;de&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;directory&nbsp;of&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Recadrer&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Crop&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Traiter&nbsp;les&nbsp;couleurs"</span>&nbsp;;&nbsp;<span class="string">"Treat&nbsp;the&nbsp;colors"</span>&nbsp;|]&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;le&nbsp;seuil"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;threshold"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;brut&nbsp;des&nbsp;courbes"</span>&nbsp;;&nbsp;<span class="string">"Raw&nbsp;display&nbsp;of&nbsp;the&nbsp;curves"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Marquer&nbsp;des&nbsp;points&nbsp;du"</span>&nbsp;;&nbsp;<span class="string">"réticule&nbsp;sur&nbsp;l'image"</span>&nbsp;;&nbsp;<span class="string">"Mark&nbsp;graticule&nbsp;points"</span>&nbsp;;&nbsp;<span class="string">"on&nbsp;the&nbsp;picture"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Raffiner&nbsp;le&nbsp;marquage"</span>&nbsp;;&nbsp;<span class="string">"Refine&nbsp;the&nbsp;marks"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;les&nbsp;unités&nbsp;horizontales"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;horizontal&nbsp;units"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Choisir&nbsp;les&nbsp;unités&nbsp;verticales"</span>&nbsp;;&nbsp;<span class="string">"Choose&nbsp;the&nbsp;vertical&nbsp;units"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;des&nbsp;courbes"</span>&nbsp;;&nbsp;<span class="string">"en&nbsp;divisions"</span>&nbsp;;&nbsp;<span class="string">"Display&nbsp;of&nbsp;the&nbsp;curves"</span>&nbsp;;&nbsp;<span class="string">"in&nbsp;divisions"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;des"</span>&nbsp;;&nbsp;<span class="string">"courbes&nbsp;en&nbsp;unités"</span>&nbsp;;&nbsp;<span class="string">"Display&nbsp;of&nbsp;the"</span>&nbsp;;&nbsp;<span class="string">"curves&nbsp;in&nbsp;units"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;brut"</span>&nbsp;;&nbsp;<span class="string">"des&nbsp;dérivées"</span>&nbsp;;&nbsp;<span class="string">"Raw&nbsp;display&nbsp;of"</span>&nbsp;;&nbsp;<span class="string">"the&nbsp;derivatives"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Affichage&nbsp;brut"</span>&nbsp;;&nbsp;<span class="string">"des&nbsp;transformées"</span>&nbsp;;&nbsp;<span class="string">"de&nbsp;Fourier"</span>;&nbsp;<span class="string">"Raw&nbsp;display&nbsp;of"</span>&nbsp;;&nbsp;<span class="string">"the&nbsp;Fourier"</span>&nbsp;;&nbsp;<span class="string">"transforms"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Suite"</span>&nbsp;;&nbsp;<span class="string">"Continuation"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Reprendre&nbsp;à&nbsp;partir"</span>&nbsp;;&nbsp;<span class="string">"du&nbsp;recadrage"</span>&nbsp;;&nbsp;<span class="string">"Resume&nbsp;from"</span>&nbsp;;&nbsp;<span class="string">"the&nbsp;cropping"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[|&nbsp;<span class="string">"Terminer"</span>&nbsp;;&nbsp;<span class="string">"Finish"</span>&nbsp;|]&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;save_name&nbsp;=&nbsp;ref&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">and</span>&nbsp;current_character&nbsp;=&nbsp;ref&nbsp;<span class="string">"0"</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;ending&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">and</span>&nbsp;go_on&nbsp;=&nbsp;ref&nbsp;[|&nbsp;0&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hori_shift&nbsp;=&nbsp;approx_hori_size&nbsp;/&nbsp;20<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;metadata&nbsp;=&nbsp;ref&nbsp;[|&nbsp;<span class="string">"phosphor:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_bool&nbsp;phosphor&nbsp;)&nbsp;;&nbsp;<span class="string">"monotrace:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_bool&nbsp;monotrace&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"size:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_verti_size&nbsp;)&nbsp;;&nbsp;<span class="string">"max&nbsp;number&nbsp;for&nbsp;selectors:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;max_number&nbsp;)&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;verti_shift&nbsp;=&nbsp;approx_verti_size&nbsp;/&nbsp;20&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_init&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.open_graph&nbsp;(&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_hori_size&nbsp;)&nbsp;^&nbsp;<span class="string">"x"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!step&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"L'oscilloscope&nbsp;a&nbsp;été&nbsp;inventé&nbsp;par&nbsp;Karl&nbsp;Ferdinand&nbsp;Braun&nbsp;(1850-1918)."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.moveto&nbsp;(&nbsp;5&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;15&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.draw_string&nbsp;<span class="string">"The&nbsp;oscilloscope&nbsp;has&nbsp;been&nbsp;invented&nbsp;by&nbsp;Karl&nbsp;Ferdinand&nbsp;Braun&nbsp;(1850-1918)."</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;10&nbsp;*&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;10&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ending&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;verti_shift&nbsp;<span class="constructor">Graphics</span>.red&nbsp;<span class="constructor">Graphics</span>.black&nbsp;end_message&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_end&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.array_write_text_file&nbsp;!metadata&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".metadata"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_key&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;current_character&nbsp;:=&nbsp;<span class="constructor">Char</span>.escaped&nbsp;c&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_mouse&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;y&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!ending&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Widget</span>.is_over_rect_button&nbsp;!go_on&nbsp;x&nbsp;y&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!step&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Répertoire - Directory *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dname&nbsp;:=&nbsp;<span class="constructor">Widget</span>.choose_directory&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;max_number&nbsp;!dname&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Fichier - File *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture_file&nbsp;:=&nbsp;<span class="constructor">Widget</span>.choose_regular_file&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;max_number&nbsp;!dname&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture_address&nbsp;:=&nbsp;<span class="constructor">Filename</span>.concat&nbsp;!dname&nbsp;!picture_file&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;(&nbsp;<span class="constructor">String</span>.length&nbsp;!picture_file&nbsp;)&nbsp;=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">||</span>&nbsp;(&nbsp;not&nbsp;(&nbsp;<span class="constructor">Sys</span>.file_exists&nbsp;!picture_address&nbsp;)&nbsp;)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Recadrage - Croping *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!never_cropped&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture&nbsp;:=&nbsp;<span class="constructor">Readwrite</span>.read_picture_float_rgb&nbsp;!picture_address&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height&nbsp;:=&nbsp;<span class="constructor">Array</span>.length&nbsp;!picture.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;width&nbsp;:=&nbsp;<span class="constructor">Array</span>.length&nbsp;!picture.(0).(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!affine_isomorphism.(1).(0).(1)&nbsp;&lt;-&nbsp;float&nbsp;!height&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;=&nbsp;<span class="constructor">Util</span>.int_gcd&nbsp;!height&nbsp;!width&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factor&nbsp;:=&nbsp;min&nbsp;g&nbsp;(&nbsp;2&nbsp;+&nbsp;(&nbsp;max&nbsp;(&nbsp;!height&nbsp;/&nbsp;approx_verti_size&nbsp;)&nbsp;(&nbsp;!width&nbsp;/&nbsp;approx_hori_size&nbsp;)&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;g&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factor&nbsp;:=&nbsp;succ&nbsp;!factor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(&nbsp;!height&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;(&nbsp;!width&nbsp;<span class="keyword">mod</span>&nbsp;!factor&nbsp;!=&nbsp;0&nbsp;)&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"The&nbsp;under-sampling&nbsp;factor&nbsp;must&nbsp;divide&nbsp;the&nbsp;height&nbsp;and&nbsp;the&nbsp;width&nbsp;of&nbsp;the&nbsp;picture&nbsp;in&nbsp;Analogic.oscillo."</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reduc&nbsp;:=&nbsp;<span class="constructor">Readwrite</span>.matrix_float_rgb_under_sample&nbsp;!factor&nbsp;!picture&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crop_values&nbsp;:=&nbsp;autocrop&nbsp;(&nbsp;<span class="constructor">Readwrite</span>.matrix_float_rgb_to_luminance&nbsp;!picture&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;never_cropped&nbsp;:=&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_crop_image&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!picture&nbsp;!reduc&nbsp;!crop_values&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"crop&nbsp;values:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;accu_int&nbsp;<span class="string">""</span>&nbsp;!crop_values&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;phosphor&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;2&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;3&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Traitement des couleurs - Color treatment *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_color_treatment&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!reduc&nbsp;coefficients&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;coefficients.(0)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(0)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;!picture.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(0)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;!picture.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;coefficients.(1)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(1)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;!picture.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(1)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;!picture.(1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;coefficients.(2)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(2)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_right_sub&nbsp;255.&nbsp;!picture.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!picture.(2)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.zeros_float&nbsp;!picture.(2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"red:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;pred&nbsp;coefficients.(0)&nbsp;)&nbsp;)&nbsp;;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"green:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;pred&nbsp;coefficients.(1)&nbsp;)&nbsp;)&nbsp;;&nbsp;<span class="string">"blue:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;pred&nbsp;coefficients.(2)&nbsp;)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;4&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Seuil - Threshold *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;<span class="constructor">Widget</span>.choose_real&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;[|&nbsp;0.&nbsp;;&nbsp;10.&nbsp;|]&nbsp;threshold&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"threshold:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_float&nbsp;threshold.(0)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;5&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage brut des courbes - Raw display of the curves *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;:=&nbsp;<span class="constructor">Readwrite</span>.rgb_crop&nbsp;!picture&nbsp;!crop_values.(2)&nbsp;!crop_values.(3)&nbsp;!crop_values.(0)&nbsp;!crop_values.(1)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Unix</span>.localtime&nbsp;(&nbsp;<span class="constructor">Unix</span>.time&nbsp;()&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;:=&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;1900&nbsp;+&nbsp;d.<span class="constructor">Unix</span>.tm_year&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;(&nbsp;succ&nbsp;d.<span class="constructor">Unix</span>.tm_mon&nbsp;)&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_mday&nbsp;)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_hour&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_min&nbsp;)&nbsp;^&nbsp;<span class="string">"."</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;d.<span class="constructor">Unix</span>.tm_sec&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_float_rgb&nbsp;!source&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;luminance&nbsp;=&nbsp;<span class="constructor">Readwrite</span>.matrix_float_rgb_to_luminance&nbsp;!source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;splitting&nbsp;=&nbsp;ref&nbsp;(&nbsp;<span class="constructor">Array</span>.make&nbsp;2&nbsp;[|&nbsp;|]&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;monotrace&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;splitting&nbsp;:=&nbsp;prepare_trace&nbsp;threshold.(0)&nbsp;(&nbsp;antigamma&nbsp;luminance&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;number_of_traces&nbsp;:=&nbsp;1&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;splitting&nbsp;:=&nbsp;split_traces&nbsp;threshold.(0)&nbsp;(&nbsp;antigamma&nbsp;luminance&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;number_of_traces&nbsp;:=&nbsp;<span class="constructor">Array</span>.length&nbsp;!splitting.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;samples&nbsp;:=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;!number_of_traces&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!source&nbsp;)&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!samples.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.vector_float_scal_add&nbsp;(&nbsp;float&nbsp;!crop_values.(2)&nbsp;)&nbsp;(&nbsp;automatic_digitize&nbsp;!splitting.(0).(i)&nbsp;!splitting.(1).(i)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.vector_float_write&nbsp;!samples.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"trace"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;100&nbsp;!samples&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"traces.au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bigomega&nbsp;:=&nbsp;float&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!source.(0).(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_multicolor_segment_1_1&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!samples&nbsp;[|&nbsp;0.&nbsp;;&nbsp;!bigomega&nbsp;;&nbsp;float&nbsp;!height&nbsp;;&nbsp;0.&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;raw&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".raw.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"number&nbsp;of&nbsp;traces:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;!number_of_traces&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;18&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;6&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Marquage - Marking *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;mark.(0)&nbsp;&gt;=&nbsp;0.&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_mark_image&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!picture&nbsp;!reduc&nbsp;mark&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;marks&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!marks&nbsp;[|&nbsp;[|&nbsp;mark.(0)&nbsp;;&nbsp;mark.(1)&nbsp;;&nbsp;mark.(2)&nbsp;;&nbsp;mark.(3)&nbsp;|]&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;!marks&nbsp;&gt;=&nbsp;4&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;6&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;3&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark.(i)&nbsp;&lt;-&nbsp;0.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;7&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Raffinement du marquage - Refining the marks *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!marks&nbsp;)&nbsp;-&nbsp;2&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;float_rgb_refine_mark&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;!picture&nbsp;!marks.(i)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"marks:&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lm&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;!marks&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m_m&nbsp;=&nbsp;<span class="constructor">Array</span>.sub&nbsp;!marks&nbsp;0&nbsp;&nbsp;(&nbsp;pred&nbsp;lm&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;accu_float&nbsp;<span class="string">""</span>&nbsp;)&nbsp;m_m&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;lm&nbsp;&gt;=&nbsp;4&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;m_m&nbsp;<span class="keyword">in</span><br>
</code><table><tr><td></td><td><span class="comment">(** Les coordonnées doivent être du même ordre de grandeur pour que la régression linéaire fonctionne.
The coordinates must have the same order of magnitude in order for the regression to work. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;departures&nbsp;=&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_mult&nbsp;1e-3&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;m&nbsp;0&nbsp;2&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;<span class="constructor">Matrix</span>.float_rank&nbsp;departures&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;r&nbsp;=&nbsp;2&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;affine_isomorphism&nbsp;:=&nbsp;linear_regression&nbsp;departures&nbsp;(&nbsp;<span class="constructor">Array</span>.sub&nbsp;m&nbsp;2&nbsp;2&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!affine_isomorphism.(0)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_scal_mult&nbsp;1e-3&nbsp;!affine_isomorphism.(0)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;!step&nbsp;+&nbsp;5&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"affine&nbsp;isomorphism:&nbsp;"</span>&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;(&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.fold_left&nbsp;accu_float&nbsp;<span class="string">""</span>&nbsp;)&nbsp;!affine_isomorphism.(0)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;string_of_float&nbsp;!affine_isomorphism.(1).(0).(0)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;string_of_float&nbsp;!affine_isomorphism.(1).(0).(1)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;8&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Unités horizontales - Horizontal units *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;choose_unit&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;horizontal_units&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;9&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Unités verticales - Vertical units *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(&nbsp;choose_unit&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;vertical_units&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;10&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage des courbes en divisions - Curves display in divisions *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"horizontal&nbsp;units:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">"&nbsp;"</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.to_list&nbsp;horizontal_units&nbsp;)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:=&nbsp;<span class="constructor">Array</span>.append&nbsp;!metadata&nbsp;[|&nbsp;<span class="string">"vertical&nbsp;units:&nbsp;"</span>&nbsp;^&nbsp;(&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">"&nbsp;"</span>&nbsp;(&nbsp;<span class="constructor">Array</span>.to_list&nbsp;vertical_units&nbsp;)&nbsp;)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;decalage&nbsp;=&nbsp;float&nbsp;!crop_values.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;a&nbsp;=&nbsp;!affine_isomorphism.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;b&nbsp;=&nbsp;!affine_isomorphism.(1).(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interval&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.float_closed_equal_subdivision&nbsp;decalage&nbsp;(&nbsp;int_of_float&nbsp;!bigomega&nbsp;)&nbsp;(&nbsp;!bigomega&nbsp;+.&nbsp;decalage&nbsp;-.&nbsp;1.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curves&nbsp;:=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;!number_of_traces&nbsp;0&nbsp;[|&nbsp;0.&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_curve&nbsp;=&nbsp;[|&nbsp;!interval&nbsp;;&nbsp;!samples.(i)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!curves.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Matrix</span>.matrix_float_column_apply_vect&nbsp;(&nbsp;<span class="constructor">Matrix</span>.vector_float_plus&nbsp;b&nbsp;)&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_prod&nbsp;a&nbsp;input_curve&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"curve"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;200&nbsp;+&nbsp;i&nbsp;)&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"curve"</span>&nbsp;^&nbsp;(string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ll_corner&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.vector_float_plus&nbsp;b&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_vector_float_prod&nbsp;a&nbsp;[|&nbsp;0.&nbsp;;&nbsp;float&nbsp;!height&nbsp;|]&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ur_corner&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.vector_float_plus&nbsp;b&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_vector_float_prod&nbsp;a&nbsp;[|&nbsp;float&nbsp;!width&nbsp;;&nbsp;0.&nbsp;|]&nbsp;&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ll_corner.(0)&nbsp;&lt;-&nbsp;min&nbsp;(&nbsp;floor&nbsp;!ll_corner.(0)&nbsp;)&nbsp;(&nbsp;-5.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ll_corner.(1)&nbsp;&lt;-&nbsp;min&nbsp;(&nbsp;floor&nbsp;!ll_corner.(1)&nbsp;)&nbsp;(&nbsp;-4.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ur_corner.(0)&nbsp;&lt;-&nbsp;max&nbsp;(&nbsp;ceil&nbsp;!ur_corner.(0)&nbsp;)&nbsp;5.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!ur_corner.(1)&nbsp;&lt;-&nbsp;max&nbsp;(&nbsp;ceil&nbsp;!ur_corner.(1)&nbsp;)&nbsp;4.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_trans_multicolor_segment_1_2&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!curves&nbsp;[|&nbsp;0.&nbsp;;&nbsp;1.&nbsp;|]&nbsp;[|&nbsp;!ll_corner.(0)&nbsp;;&nbsp;!ur_corner.(0)&nbsp;;&nbsp;!ll_corner.(1)&nbsp;;&nbsp;!ur_corner.(1)&nbsp;;&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;curves&nbsp;DIV&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".div.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;18&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;11&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage des courbes en unités - Curves display in units *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;u&nbsp;=&nbsp;[|&nbsp;float_of_string&nbsp;horizontal_units.(0)&nbsp;;&nbsp;float_of_string&nbsp;vertical_units.(0)&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;horizontal_units.(3)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"pix"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(0)&nbsp;&lt;-&nbsp;u.(0)&nbsp;*.&nbsp;(&nbsp;float&nbsp;!width&nbsp;)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(0)&nbsp;-.&nbsp;!ll_corner.(0)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"scrn"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(0)&nbsp;&lt;-&nbsp;u.(0)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(0)&nbsp;-.&nbsp;!ll_corner.(0)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;vertical_units.(3)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"pix"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(1)&nbsp;&lt;-&nbsp;u.(1)&nbsp;*.&nbsp;(&nbsp;float&nbsp;!height&nbsp;)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(1)&nbsp;-.&nbsp;!ll_corner.(1)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"scrn"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;u.(1)&nbsp;&lt;-&nbsp;u.(1)&nbsp;/.&nbsp;(&nbsp;!ur_corner.(1)&nbsp;-.&nbsp;!ll_corner.(1)&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curves&nbsp;:=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Array</span>.mapi&nbsp;(&nbsp;<span class="keyword">fun</span>&nbsp;i&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Matrix</span>.vector_float_scal_mult&nbsp;u.(i)&nbsp;x&nbsp;)&nbsp;)&nbsp;!curves&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ll_corner&nbsp;:=&nbsp;[|&nbsp;u.(0)&nbsp;*.&nbsp;!ll_corner.(0)&nbsp;;&nbsp;u.(1)&nbsp;*.&nbsp;!ll_corner.(1)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ur_corner&nbsp;:=&nbsp;[|&nbsp;u.(0)&nbsp;*.&nbsp;!ur_corner.(0)&nbsp;;&nbsp;u.(1)&nbsp;*.&nbsp;!ur_corner.(1)&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_trans_multicolor_segment_1_2&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!curves&nbsp;[|&nbsp;0.&nbsp;;&nbsp;1.&nbsp;|]&nbsp;[|&nbsp;!ll_corner.(0)&nbsp;;&nbsp;!ur_corner.(0)&nbsp;;&nbsp;!ll_corner.(1)&nbsp;;&nbsp;!ur_corner.(1)&nbsp;;&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;curves&nbsp;UNITS&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"magnitude"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;300&nbsp;+&nbsp;i&nbsp;)&nbsp;!curves.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"magnitude"</span>&nbsp;^&nbsp;(string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".units.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;12&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage brut des dérivées - Raw display of the derivatives *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Les lignes sont numérotées du haut vers le bas. - The lines are numbered from top to bottom. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;derivatives&nbsp;:=&nbsp;<span class="constructor">Infinitesimal</span>.discrete_trans_vector_speed&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_richardson_binary_diff&nbsp;(-1.)&nbsp;!samples&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.vector_float_write&nbsp;!derivatives.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"deriv"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;400&nbsp;!derivatives&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"derivatives.au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_multicolor_segment_1_1&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!derivatives&nbsp;[|&nbsp;0.&nbsp;;&nbsp;!bigomega&nbsp;;&nbsp;<span class="constructor">Matrix</span>.matrix_float_min&nbsp;!derivatives&nbsp;;&nbsp;<span class="constructor">Matrix</span>.matrix_float_max&nbsp;!derivatives&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;raw&nbsp;derivatives&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".raw_deriv.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;!curves&nbsp;&gt;=&nbsp;5&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;speeds&nbsp;:=&nbsp;<span class="constructor">Array</span>.map&nbsp;(&nbsp;<span class="constructor">Infinitesimal</span>.discrete_trans_vector_speed&nbsp;<span class="constructor">Infinitesimal</span>.mean_float_discrete_richardson_binary_diff&nbsp;(&nbsp;!ur_corner.(0)&nbsp;-.&nbsp;!ll_corner.(0)&nbsp;)&nbsp;)&nbsp;!curves&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!speeds.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"speed"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;500&nbsp;+&nbsp;i&nbsp;)&nbsp;!speeds.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"speed"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;17&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;13&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Affichage brut des transformées - Raw display of the transforms *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.sand_glass&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tf&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;omega&nbsp;z&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Infinitesimal</span>.discrete_float_causal_fourier_transform&nbsp;z&nbsp;omega<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;value&nbsp;=&nbsp;(&nbsp;!bigomega&nbsp;-.&nbsp;1.&nbsp;)&nbsp;/.&nbsp;2.&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interval&nbsp;:=&nbsp;<span class="constructor">Matrix</span>.float_closed_equal_subdivision&nbsp;(&nbsp;-.&nbsp;value&nbsp;)&nbsp;(&nbsp;int_of_float&nbsp;!bigomega&nbsp;)&nbsp;value&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transfos&nbsp;:=&nbsp;<span class="constructor">Array</span>.make&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!samples&nbsp;)&nbsp;(&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;0&nbsp;0&nbsp;0.&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules&nbsp;:=&nbsp;<span class="constructor">Array</span>.make_matrix&nbsp;(&nbsp;<span class="constructor">Array</span>.length&nbsp;!samples&nbsp;)&nbsp;0&nbsp;0.&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;pred&nbsp;!number_of_traces&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ft&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;omega&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tf&nbsp;omega&nbsp;(&nbsp;truncate&nbsp;(&nbsp;float&nbsp;!height&nbsp;)&nbsp;!samples.(i)&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!transfos.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;ft&nbsp;!interval&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!modules.(i)&nbsp;&lt;-&nbsp;<span class="constructor">Array</span>.map&nbsp;<span class="constructor">Matrix</span>.vector_float_norm_2&nbsp;!transfos.(i)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!transfos.(i)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"Fourier"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;600&nbsp;+&nbsp;i&nbsp;)&nbsp;(&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;!transfos.(i)&nbsp;)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"Fourier"</span>&nbsp;^&nbsp;(&nbsp;string_of_int&nbsp;i&nbsp;)&nbsp;^&nbsp;<span class="string">".au"</span>&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.matrix_float_write&nbsp;!modules&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"transfoModules"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_matrix_float_to_float64_au&nbsp;(&nbsp;700&nbsp;)&nbsp;(&nbsp;<span class="constructor">Matrix</span>.float_transpose&nbsp;!modules&nbsp;)&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">"transfoModules.au"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Draw</span>.discrete_multicolor_segment_1_1&nbsp;<span class="constructor">Draw</span>.color_list&nbsp;!modules&nbsp;[|&nbsp;-.&nbsp;value&nbsp;;&nbsp;value&nbsp;;&nbsp;floor&nbsp;(&nbsp;1.1&nbsp;*.&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_min&nbsp;!modules&nbsp;)&nbsp;)&nbsp;;&nbsp;ceil&nbsp;(&nbsp;1.1&nbsp;*.&nbsp;(&nbsp;<span class="constructor">Matrix</span>.matrix_float_max&nbsp;!modules&nbsp;)&nbsp;)&nbsp;|]&nbsp;[|&nbsp;approx_hori_size&nbsp;;&nbsp;approx_verti_size&nbsp;|]&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Graphics</span>.set_window_title&nbsp;<span class="string">"Analogic.oscillo&nbsp;:&nbsp;raw&nbsp;Fourier&nbsp;transforms&nbsp;display"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_name&nbsp;:=&nbsp;(&nbsp;!picture_file&nbsp;^&nbsp;!date&nbsp;^&nbsp;<span class="string">".raw_Fourier.ppm"</span>&nbsp;)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Readwrite</span>.write_ppm_binary_color&nbsp;(&nbsp;<span class="constructor">Graphics</span>.dump_image&nbsp;(&nbsp;<span class="constructor">Graphics</span>.get_image&nbsp;0&nbsp;0&nbsp;approx_hori_size&nbsp;approx_verti_size&nbsp;)&nbsp;)&nbsp;!save_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_on&nbsp;:=&nbsp;<span class="constructor">Widget</span>.rect_switch&nbsp;(&nbsp;approx_hori_size&nbsp;-&nbsp;hori_shift&nbsp;)&nbsp;(&nbsp;18&nbsp;*&nbsp;verti_shift&nbsp;)&nbsp;<span class="constructor">Graphics</span>.green&nbsp;<span class="constructor">Graphics</span>.black&nbsp;go_on_messages.(!step)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;14&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Choix - Choice *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;step&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_init&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;15&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Bouclage - Looping *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;:=&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_end&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** f_mouse *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;f_except&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;unknown&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(&nbsp;<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;&nbsp;raise&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Widget</span>.skeleton&nbsp;f_init&nbsp;f_end&nbsp;f_key&nbsp;f_mouse&nbsp;f_except&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Widget</span>.<span class="constructor">End</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gc</span>.compact&nbsp;()&nbsp;;<br>
&nbsp;()&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>oscillo monotrace_switch hori_size verti_size max_number</pre> This function acts only by side effect, writing data into files.
<p>

Cette fonction opère uniquement par effet de bord, en écrivant les données dans des fichiers. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;oscillo&nbsp;=&nbsp;oscillo_recorder&nbsp;<span class="keyword">true</span>&nbsp;;;<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <pre>recorder monotrace_switch hori_size verti_size max_number</pre> This function acts only by side effect, writing data into files.
<p>

Cette fonction opère uniquement par effet de bord, en écrivant les données dans des fichiers. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;recorder&nbsp;=&nbsp;oscillo_recorder&nbsp;<span class="keyword">false</span>&nbsp;;;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <center>§ § § </center> *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="constructor">Graphics</span>.close_graph&nbsp;()&nbsp;;;<br>
<br>
<br>
<span class="keyword">end</span></code></body></html>